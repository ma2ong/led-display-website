<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品数据状态检查 - 简化版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        .product-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">产品数据状态检查 - 简化版</h3>
                    </div>
                    <div class="card-body">
                        <button id="check-supabase-btn" class="btn btn-primary me-3">检查Supabase连接</button>
                        <button id="load-products-btn" class="btn btn-success me-3">加载产品数据</button>
                        <button id="add-sample-btn" class="btn btn-warning me-3">添加示例产品</button>
                        <button id="test-flask-btn" class="btn btn-info">测试Flask API</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">测试结果</h4>
                    </div>
                    <div class="card-body">
                        <div id="test-result">点击按钮开始测试</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">产品数据</h4>
                    </div>
                    <div class="card-body">
                        <div id="products-result">点击"加载产品数据"查看产品</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">操作日志</h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="log-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 初始化Supabase客户端
        const { createClient } = supabase;
        const supabaseUrl = 'https://jirudzbqcxviytcmxegf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y214ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4';
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

        // 日志系统
        const logContainer = document.getElementById('log-container');
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 检查Supabase连接
        document.getElementById('check-supabase-btn').addEventListener('click', async () => {
            log('开始检查Supabase连接...');
            document.getElementById('test-result').innerHTML = '<div class="spinner-border" role="status"></div>';
            
            try {
                // 测试连接
                const { data, error } = await supabaseClient
                    .from('products')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw new Error(`连接失败: ${error.message}`);
                }
                
                log('✅ Supabase连接成功', 'success');
                log(`数据库中共有 ${data || 0} 个产品`, 'success');
                
                document.getElementById('test-result').innerHTML = `
                    <div class="alert alert-success">
                        <h5>✅ Supabase连接正常</h5>
                        <ul class="mb-0">
                            <li>连接状态: 正常</li>
                            <li>数据库: 可访问</li>
                            <li>产品表: 存在</li>
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                log(`❌ 连接失败: ${error.message}`, 'error');
                document.getElementById('test-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>❌ Supabase连接失败</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // 加载产品数据
        document.getElementById('load-products-btn').addEventListener('click', async () => {
            log('开始加载产品数据...');
            document.getElementById('products-result').innerHTML = '<div class="spinner-border" role="status"></div>';
            
            try {
                const { data: products, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw new Error(`加载产品失败: ${error.message}`);
                }
                
                log(`✅ 成功加载 ${products.length} 个产品`, 'success');
                
                if (products.length === 0) {
                    document.getElementById('products-result').innerHTML = `
                        <div class="alert alert-warning">
                            <h5>⚠️ 暂无产品数据</h5>
                            <p>数据库中没有产品数据，请添加示例产品。</p>
                        </div>
                    `;
                } else {
                    let productsHtml = `<div class="alert alert-info">找到 ${products.length} 个产品</div>`;
                    
                    products.slice(0, 3).forEach(product => {
                        productsHtml += `
                            <div class="product-card">
                                <h6>${product.name || '未命名产品'}</h6>
                                <p class="text-muted mb-1">分类: ${product.category || '未分类'}</p>
                                <p class="text-muted mb-1">描述: ${product.description || '无描述'}</p>
                                <small class="text-muted">创建时间: ${product.created_at ? new Date(product.created_at).toLocaleString() : '未知'}</small>
                            </div>
                        `;
                    });
                    
                    if (products.length > 3) {
                        productsHtml += `<p class="text-muted">... 还有 ${products.length - 3} 个产品</p>`;
                    }
                    
                    document.getElementById('products-result').innerHTML = productsHtml;
                }
                
            } catch (error) {
                log(`❌ 加载失败: ${error.message}`, 'error');
                document.getElementById('products-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>❌ 加载失败</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // 添加示例产品
        document.getElementById('add-sample-btn').addEventListener('click', async () => {
            log('开始添加示例产品...');
            
            const sampleProducts = [
                {
                    name: "P2.5室内LED显示屏",
                    category: "Indoor",
                    description: "高清室内LED显示屏，适用于会议室、展厅等场所",
                    price: 1999.99,
                    image_url: "assets/products/p2.5-indoor.jpg",
                    specifications: JSON.stringify(["像素间距: P2.5", "分辨率: 1920x1080", "亮度: 800nits", "刷新率: 3840Hz"]),
                    status: "active"
                },
                {
                    name: "P4户外LED显示屏",
                    category: "Outdoor", 
                    description: "防水户外LED显示屏，适用于广告牌、体育场等",
                    price: 2999.99,
                    image_url: "assets/products/p4-outdoor.jpg",
                    specifications: JSON.stringify(["像素间距: P4", "防护等级: IP65", "亮度: 6000nits", "工作温度: -40°C~+60°C"]),
                    status: "active"
                },
                {
                    name: "P3.91租赁LED显示屏",
                    category: "Rental",
                    description: "轻便租赁LED显示屏，适用于演出、会议等临时活动",
                    price: 1599.99,
                    image_url: "assets/products/p3.91-rental.jpg",
                    specifications: JSON.stringify(["像素间距: P3.91", "重量: 7kg/㎡", "快速安装", "航空箱包装"]),
                    status: "active"
                }
            ];
            
            try {
                for (let i = 0; i < sampleProducts.length; i++) {
                    const product = sampleProducts[i];
                    log(`添加产品 ${i + 1}/${sampleProducts.length}: ${product.name}`);
                    
                    const { data, error } = await supabaseClient
                        .from('products')
                        .insert(product);
                    
                    if (error) {
                        log(`❌ ${product.name} 添加失败: ${error.message}`, 'error');
                    } else {
                        log(`✅ ${product.name} 添加成功`, 'success');
                    }
                    
                    // 添加延迟避免频率限制
                    if (i < sampleProducts.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                log('✅ 示例产品添加完成', 'success');
                
                // 自动重新加载产品数据
                setTimeout(() => {
                    document.getElementById('load-products-btn').click();
                }, 1000);
                
            } catch (error) {
                log(`❌ 添加示例产品失败: ${error.message}`, 'error');
            }
        });

        // 测试Flask API
        document.getElementById('test-flask-btn').addEventListener('click', async () => {
            log('开始测试Flask API...');
            
            try {
                const response = await fetch('http://localhost:5003/api/products');
                const data = await response.json();
                
                if (response.ok) {
                    log(`✅ Flask API连接成功，返回 ${data.products ? data.products.length : 0} 个产品`, 'success');
                } else {
                    log(`❌ Flask API返回错误: ${data.message || '未知错误'}`, 'error');
                }
                
            } catch (error) {
                log(`❌ Flask API连接失败: ${error.message}`, 'error');
                log('💡 提示: 确保管理系统在 http://localhost:5003 运行', 'info');
            }
        });

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', () => {
            log('产品数据状态检查工具已加载 - 简化版');
            log('请点击按钮开始测试各项功能');
        });
    </script>
</body>
</html>