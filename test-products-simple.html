<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“æ•°æ®çŠ¶æ€æ£€æŸ¥ - ç®€åŒ–ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        .product-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">äº§å“æ•°æ®çŠ¶æ€æ£€æŸ¥ - ç®€åŒ–ç‰ˆ</h3>
                    </div>
                    <div class="card-body">
                        <button id="check-supabase-btn" class="btn btn-primary me-3">æ£€æŸ¥Supabaseè¿æ¥</button>
                        <button id="load-products-btn" class="btn btn-success me-3">åŠ è½½äº§å“æ•°æ®</button>
                        <button id="add-sample-btn" class="btn btn-warning me-3">æ·»åŠ ç¤ºä¾‹äº§å“</button>
                        <button id="test-flask-btn" class="btn btn-info">æµ‹è¯•Flask API</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">æµ‹è¯•ç»“æœ</h4>
                    </div>
                    <div class="card-body">
                        <div id="test-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">äº§å“æ•°æ®</h4>
                    </div>
                    <div class="card-body">
                        <div id="products-result">ç‚¹å‡»"åŠ è½½äº§å“æ•°æ®"æŸ¥çœ‹äº§å“</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">æ“ä½œæ—¥å¿—</h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="log-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const { createClient } = supabase;
        const supabaseUrl = 'https://jirudzbqcxviytcmxegf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y214ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4';
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

        // æ—¥å¿—ç³»ç»Ÿ
        const logContainer = document.getElementById('log-container');
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ£€æŸ¥Supabaseè¿æ¥
        document.getElementById('check-supabase-btn').addEventListener('click', async () => {
            log('å¼€å§‹æ£€æŸ¥Supabaseè¿æ¥...');
            document.getElementById('test-result').innerHTML = '<div class="spinner-border" role="status"></div>';
            
            try {
                // æµ‹è¯•è¿æ¥
                const { data, error } = await supabaseClient
                    .from('products')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw new Error(`è¿æ¥å¤±è´¥: ${error.message}`);
                }
                
                log('âœ… Supabaseè¿æ¥æˆåŠŸ', 'success');
                log(`æ•°æ®åº“ä¸­å…±æœ‰ ${data || 0} ä¸ªäº§å“`, 'success');
                
                document.getElementById('test-result').innerHTML = `
                    <div class="alert alert-success">
                        <h5>âœ… Supabaseè¿æ¥æ­£å¸¸</h5>
                        <ul class="mb-0">
                            <li>è¿æ¥çŠ¶æ€: æ­£å¸¸</li>
                            <li>æ•°æ®åº“: å¯è®¿é—®</li>
                            <li>äº§å“è¡¨: å­˜åœ¨</li>
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('test-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>âŒ Supabaseè¿æ¥å¤±è´¥</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // åŠ è½½äº§å“æ•°æ®
        document.getElementById('load-products-btn').addEventListener('click', async () => {
            log('å¼€å§‹åŠ è½½äº§å“æ•°æ®...');
            document.getElementById('products-result').innerHTML = '<div class="spinner-border" role="status"></div>';
            
            try {
                const { data: products, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw new Error(`åŠ è½½äº§å“å¤±è´¥: ${error.message}`);
                }
                
                log(`âœ… æˆåŠŸåŠ è½½ ${products.length} ä¸ªäº§å“`, 'success');
                
                if (products.length === 0) {
                    document.getElementById('products-result').innerHTML = `
                        <div class="alert alert-warning">
                            <h5>âš ï¸ æš‚æ— äº§å“æ•°æ®</h5>
                            <p>æ•°æ®åº“ä¸­æ²¡æœ‰äº§å“æ•°æ®ï¼Œè¯·æ·»åŠ ç¤ºä¾‹äº§å“ã€‚</p>
                        </div>
                    `;
                } else {
                    let productsHtml = `<div class="alert alert-info">æ‰¾åˆ° ${products.length} ä¸ªäº§å“</div>`;
                    
                    products.slice(0, 3).forEach(product => {
                        productsHtml += `
                            <div class="product-card">
                                <h6>${product.name || 'æœªå‘½åäº§å“'}</h6>
                                <p class="text-muted mb-1">åˆ†ç±»: ${product.category || 'æœªåˆ†ç±»'}</p>
                                <p class="text-muted mb-1">æè¿°: ${product.description || 'æ— æè¿°'}</p>
                                <small class="text-muted">åˆ›å»ºæ—¶é—´: ${product.created_at ? new Date(product.created_at).toLocaleString() : 'æœªçŸ¥'}</small>
                            </div>
                        `;
                    });
                    
                    if (products.length > 3) {
                        productsHtml += `<p class="text-muted">... è¿˜æœ‰ ${products.length - 3} ä¸ªäº§å“</p>`;
                    }
                    
                    document.getElementById('products-result').innerHTML = productsHtml;
                }
                
            } catch (error) {
                log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('products-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>âŒ åŠ è½½å¤±è´¥</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // æ·»åŠ ç¤ºä¾‹äº§å“
        document.getElementById('add-sample-btn').addEventListener('click', async () => {
            log('å¼€å§‹æ·»åŠ ç¤ºä¾‹äº§å“...');
            
            const sampleProducts = [
                {
                    name: "P2.5å®¤å†…LEDæ˜¾ç¤ºå±",
                    category: "Indoor",
                    description: "é«˜æ¸…å®¤å†…LEDæ˜¾ç¤ºå±ï¼Œé€‚ç”¨äºä¼šè®®å®¤ã€å±•å…ç­‰åœºæ‰€",
                    price: 1999.99,
                    image_url: "assets/products/p2.5-indoor.jpg",
                    specifications: JSON.stringify(["åƒç´ é—´è·: P2.5", "åˆ†è¾¨ç‡: 1920x1080", "äº®åº¦: 800nits", "åˆ·æ–°ç‡: 3840Hz"]),
                    status: "active"
                },
                {
                    name: "P4æˆ·å¤–LEDæ˜¾ç¤ºå±",
                    category: "Outdoor", 
                    description: "é˜²æ°´æˆ·å¤–LEDæ˜¾ç¤ºå±ï¼Œé€‚ç”¨äºå¹¿å‘Šç‰Œã€ä½“è‚²åœºç­‰",
                    price: 2999.99,
                    image_url: "assets/products/p4-outdoor.jpg",
                    specifications: JSON.stringify(["åƒç´ é—´è·: P4", "é˜²æŠ¤ç­‰çº§: IP65", "äº®åº¦: 6000nits", "å·¥ä½œæ¸©åº¦: -40Â°C~+60Â°C"]),
                    status: "active"
                },
                {
                    name: "P3.91ç§ŸèµLEDæ˜¾ç¤ºå±",
                    category: "Rental",
                    description: "è½»ä¾¿ç§ŸèµLEDæ˜¾ç¤ºå±ï¼Œé€‚ç”¨äºæ¼”å‡ºã€ä¼šè®®ç­‰ä¸´æ—¶æ´»åŠ¨",
                    price: 1599.99,
                    image_url: "assets/products/p3.91-rental.jpg",
                    specifications: JSON.stringify(["åƒç´ é—´è·: P3.91", "é‡é‡: 7kg/ã¡", "å¿«é€Ÿå®‰è£…", "èˆªç©ºç®±åŒ…è£…"]),
                    status: "active"
                }
            ];
            
            try {
                for (let i = 0; i < sampleProducts.length; i++) {
                    const product = sampleProducts[i];
                    log(`æ·»åŠ äº§å“ ${i + 1}/${sampleProducts.length}: ${product.name}`);
                    
                    const { data, error } = await supabaseClient
                        .from('products')
                        .insert(product);
                    
                    if (error) {
                        log(`âŒ ${product.name} æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
                    } else {
                        log(`âœ… ${product.name} æ·»åŠ æˆåŠŸ`, 'success');
                    }
                    
                    // æ·»åŠ å»¶è¿Ÿé¿å…é¢‘ç‡é™åˆ¶
                    if (i < sampleProducts.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                log('âœ… ç¤ºä¾‹äº§å“æ·»åŠ å®Œæˆ', 'success');
                
                // è‡ªåŠ¨é‡æ–°åŠ è½½äº§å“æ•°æ®
                setTimeout(() => {
                    document.getElementById('load-products-btn').click();
                }, 1000);
                
            } catch (error) {
                log(`âŒ æ·»åŠ ç¤ºä¾‹äº§å“å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // æµ‹è¯•Flask API
        document.getElementById('test-flask-btn').addEventListener('click', async () => {
            log('å¼€å§‹æµ‹è¯•Flask API...');
            
            try {
                const response = await fetch('http://localhost:5003/api/products');
                const data = await response.json();
                
                if (response.ok) {
                    log(`âœ… Flask APIè¿æ¥æˆåŠŸï¼Œè¿”å› ${data.products ? data.products.length : 0} ä¸ªäº§å“`, 'success');
                } else {
                    log(`âŒ Flask APIè¿”å›é”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Flask APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                log('ğŸ’¡ æç¤º: ç¡®ä¿ç®¡ç†ç³»ç»Ÿåœ¨ http://localhost:5003 è¿è¡Œ', 'info');
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            log('äº§å“æ•°æ®çŠ¶æ€æ£€æŸ¥å·¥å…·å·²åŠ è½½ - ç®€åŒ–ç‰ˆ');
            log('è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•å„é¡¹åŠŸèƒ½');
        });
    </script>
</body>
</html>