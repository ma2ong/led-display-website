# ğŸ” ç™»å½•é—®é¢˜æ’æŸ¥æŒ‡å—

å¦‚æœæ‚¨åˆ›å»ºäº†ç®¡ç†å‘˜è´¦å·ä½†æ— æ³•ç™»å½•ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ’æŸ¥å’Œä¿®å¤é—®é¢˜ã€‚

---

## ğŸ“‹ å¿«é€Ÿè¯Šæ–­ï¼ˆä¸‰é€‰ä¸€ï¼‰

### æ–¹æ³• 1: ä½¿ç”¨æµè§ˆå™¨è°ƒè¯•å·¥å…·ï¼ˆæ¨èï¼‰â­

è¿™æ˜¯æœ€ç›´è§‚çš„æ–¹æ³•ï¼Œå¯ä»¥å®æ—¶çœ‹åˆ°æ¯ä¸ªæ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯ã€‚

1. **æ‰“å¼€è°ƒè¯•é¡µé¢**
   ```
   http://localhost:3000/admin/debug-login.html
   æˆ–
   https://your-domain.vercel.app/admin/debug-login.html
   ```

2. **æŒ‰ç…§é¡µé¢æç¤ºæ“ä½œ**
   - æ­¥éª¤ 1: ç‚¹å‡» "æµ‹è¯•è¿æ¥" - éªŒè¯ Supabase è¿æ¥
   - æ­¥éª¤ 2: è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼Œç‚¹å‡» "æµ‹è¯•ç™»å½•" - æŸ¥çœ‹è¯¦ç»†çš„ç™»å½•æµç¨‹
   - æ­¥éª¤ 3: ç‚¹å‡» "æ£€æŸ¥æ•°æ®åº“" - æŸ¥çœ‹æ•°æ®åº“ä¸­çš„ç”¨æˆ·çŠ¶æ€
   - æ­¥éª¤ 4: ç‚¹å‡» "æ˜¾ç¤ºç¯å¢ƒé…ç½®" - æŸ¥çœ‹ç¯å¢ƒä¿¡æ¯

3. **æ ¹æ®é”™è¯¯æç¤ºä¿®å¤**
   - è°ƒè¯•é¡µé¢ä¼šæ˜¾ç¤ºå…·ä½“çš„é”™è¯¯åŸå› å’Œè§£å†³æ–¹æ¡ˆ
   - å¯¹åº”çš„ SQL ä¿®å¤è„šæœ¬åœ¨ `database/fix_admin_login.sql`

---

### æ–¹æ³• 2: ä½¿ç”¨ SQL è¯Šæ–­è„šæœ¬

1. **è¿è¡Œè¯Šæ–­è„šæœ¬**
   - ç™»å½• [Supabase Dashboard](https://supabase.com/dashboard)
   - è¿›å…¥ä½ çš„é¡¹ç›®
   - ç‚¹å‡»å·¦ä¾§èœå• **SQL Editor**
   - ç‚¹å‡» **New Query**
   - å¤åˆ¶ `database/diagnose_login.sql` çš„å…¨éƒ¨å†…å®¹
   - ç²˜è´´å¹¶ç‚¹å‡» **Run**

2. **æŸ¥çœ‹è¯Šæ–­ç»“æœ**

   è¯Šæ–­è„šæœ¬ä¼šæ£€æŸ¥ä»¥ä¸‹ 7 ä¸ªæ–¹é¢ï¼š

   | æ£€æŸ¥é¡¹ | è¯´æ˜ |
   |--------|------|
   | admin_users è¡¨ | æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ |
   | admin_login_logs è¡¨ | æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ |
   | è®¤è¯ç”¨æˆ·åˆ—è¡¨ | æ˜¾ç¤ºæ‰€æœ‰ auth.users ä¸­çš„ç”¨æˆ· |
   | ç®¡ç†å‘˜ç”¨æˆ·åˆ—è¡¨ | æ˜¾ç¤ºæ‰€æœ‰ admin_users ä¸­çš„ç”¨æˆ· |
   | å­¤ç«‹ç”¨æˆ·æ£€æŸ¥ | æ‰¾å‡ºåœ¨ auth.users ä½†ä¸åœ¨ admin_users çš„ç”¨æˆ· |
   | RLS ç­–ç•¥ | æ£€æŸ¥æƒé™ç­–ç•¥æ˜¯å¦æ­£ç¡® |
   | æœ€è¿‘ç™»å½•è®°å½• | æŸ¥çœ‹ç™»å½•æ—¥å¿— |

3. **æ ¹æ®ç»“æœä¿®å¤**
   - å‚è€ƒä¸‹æ–¹çš„"å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ"
   - æˆ–ä½¿ç”¨ `database/fix_admin_login.sql` ä¸­çš„ä¿®å¤è„šæœ¬

---

### æ–¹æ³• 3: æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥

1. **æ‰“å¼€ç™»å½•é¡µé¢**
   ```
   http://localhost:3000/admin/login.html
   ```

2. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**
   - Chrome/Edge: æŒ‰ `F12` æˆ–å³é”® â†’ æ£€æŸ¥
   - åˆ‡æ¢åˆ° **Console** æ ‡ç­¾

3. **å°è¯•ç™»å½•å¹¶æŸ¥çœ‹é”™è¯¯**
   - è¾“å…¥é‚®ç®±å’Œå¯†ç 
   - ç‚¹å‡»ç™»å½•
   - æŸ¥çœ‹æ§åˆ¶å°çš„çº¢è‰²é”™è¯¯ä¿¡æ¯

4. **æ ¹æ®é”™è¯¯ä¿¡æ¯å¯¹ç…§ä¸‹æ–¹çš„è§£å†³æ–¹æ¡ˆ**

---

## ğŸ”§ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: "ç”¨æˆ·ä¸åœ¨ admin_users è¡¨ä¸­"

**ç—‡çŠ¶**:
- èƒ½åˆ›å»ºè´¦å·ï¼Œä½†ç™»å½•æ—¶æç¤º "æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™"
- SQL è¯Šæ–­æ˜¾ç¤ºç”¨æˆ·å­˜åœ¨äº `auth.users` ä½†ä¸åœ¨ `admin_users`

**åŸå› **: åªåœ¨ Supabase Auth ä¸­åˆ›å»ºäº†ç”¨æˆ·ï¼Œä½†æ²¡æœ‰æ·»åŠ åˆ° `admin_users` è¡¨

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- å¤åˆ¶åˆ° Supabase SQL Editor å¹¶è¿è¡Œ
INSERT INTO admin_users (user_id, email, role, is_active)
SELECT
  id,
  email,
  'super_admin',
  true
FROM auth.users
WHERE email = 'YOUR_EMAIL@example.com'  -- âš ï¸ æ›¿æ¢ä¸ºä½ çš„é‚®ç®±
ON CONFLICT (user_id) DO UPDATE
SET
  is_active = true,
  role = 'super_admin',
  updated_at = NOW();
```

---

### é—®é¢˜ 2: "è´¦å·å·²è¢«ç¦ç”¨"

**ç—‡çŠ¶**:
- ç™»å½•æ—¶æç¤º "æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™"
- SQL è¯Šæ–­æ˜¾ç¤º `is_active = false`

**åŸå› **: ç”¨æˆ·å­˜åœ¨ä½†è¢«ç¦ç”¨

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æ¿€æ´»è´¦å·
UPDATE admin_users
SET
  is_active = true,
  updated_at = NOW()
WHERE email = 'YOUR_EMAIL@example.com';  -- âš ï¸ æ›¿æ¢ä¸ºä½ çš„é‚®ç®±
```

---

### é—®é¢˜ 3: "Invalid login credentials" (é‚®ç®±æˆ–å¯†ç é”™è¯¯)

**ç—‡çŠ¶**:
- ç™»å½•æ—¶æç¤º "Invalid login credentials"
- ç¡®å®šé‚®ç®±å’Œå¯†ç æ˜¯æ­£ç¡®çš„

**åŸå› **: å¯èƒ½æ˜¯ä»¥ä¸‹å‡ ç§æƒ…å†µ
1. å¯†ç çœŸçš„è¾“å…¥é”™è¯¯
2. é‚®ç®±æœªç¡®è®¤
3. è´¦å·è¢«é”å®š

**è§£å†³æ–¹æ¡ˆ A - é‡ç½®å¯†ç **:

1. åœ¨ Supabase Dashboard â†’ Authentication â†’ Users
2. æ‰¾åˆ°ä½ çš„ç”¨æˆ·
3. ç‚¹å‡»ç”¨æˆ·æ—è¾¹çš„ `...` â†’ Reset Password
4. å¤åˆ¶ä¸´æ—¶å¯†ç æˆ–è®¾ç½®æ–°å¯†ç 

**è§£å†³æ–¹æ¡ˆ B - ç¡®è®¤é‚®ç®±**:

```sql
-- æ‰‹åŠ¨ç¡®è®¤é‚®ç®±ï¼ˆéœ€è¦åœ¨ SQL Editor è¿è¡Œï¼‰
UPDATE auth.users
SET
  confirmed_at = NOW(),
  email_confirmed_at = NOW()
WHERE email = 'YOUR_EMAIL@example.com';  -- âš ï¸ æ›¿æ¢ä¸ºä½ çš„é‚®ç®±
```

æˆ–åœ¨ Supabase Dashboard æ‰‹åŠ¨ç¡®è®¤ï¼š
1. Authentication â†’ Users
2. æ‰¾åˆ°ç”¨æˆ·
3. å¦‚æœæ˜¾ç¤º "æœªç¡®è®¤"ï¼Œç‚¹å‡»ç¡®è®¤æŒ‰é’®

---

### é—®é¢˜ 4: "è§’è‰²æƒé™ä¸è¶³"

**ç—‡çŠ¶**:
- èƒ½ç™»å½•ï¼Œä½†ç«‹å³è¢«æç¤º "æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™"
- SQL è¯Šæ–­æ˜¾ç¤º `role = 'viewer'`

**åŸå› **: ç”¨æˆ·è§’è‰²è®¾ç½®ä¸º `viewer`ï¼ˆåªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½ç™»å½•åå°ï¼‰

**è§£å†³æ–¹æ¡ˆ**:

```sql
-- æ›´æ–°è§’è‰²ä¸º super_admin
UPDATE admin_users
SET
  role = 'super_admin',  -- æˆ– 'admin', 'editor'
  updated_at = NOW()
WHERE email = 'YOUR_EMAIL@example.com';  -- âš ï¸ æ›¿æ¢ä¸ºä½ çš„é‚®ç®±
```

**è§’è‰²è¯´æ˜**:
- `super_admin`: è¶…çº§ç®¡ç†å‘˜ï¼ˆæ¨èï¼‰
- `admin`: ç®¡ç†å‘˜
- `editor`: ç¼–è¾‘ï¼ˆå¯ä»¥ç™»å½•åå°ï¼‰
- `viewer`: æŸ¥çœ‹è€…ï¼ˆä¸èƒ½ç™»å½•åå°ï¼‰

---

### é—®é¢˜ 5: "relation 'admin_users' does not exist" (è¡¨ä¸å­˜åœ¨)

**ç—‡çŠ¶**:
- è¿æ¥æµ‹è¯•å¤±è´¥
- æç¤º `relation "admin_users" does not exist`

**åŸå› **: æ•°æ®åº“è¿ç§»æœªæ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**:

1. ç¡®è®¤æ‚¨å·²ç»è¿è¡Œäº†æ•°æ®åº“è¿ç§»è„šæœ¬
2. å¦‚æœæ²¡æœ‰ï¼Œè¿è¡Œ `database/migrations/001_create_admin_users.sql`
3. å‚è€ƒ `database/STEP_BY_STEP_INIT.md` çš„å®Œæ•´æ­¥éª¤

---

### é—®é¢˜ 6: ç¯å¢ƒå˜é‡é…ç½®é—®é¢˜

**ç—‡çŠ¶**:
- è°ƒè¯•å·¥å…·æ˜¾ç¤º Supabase URL æˆ– Key ä¸º "(æœªè®¾ç½®)"
- æˆ–è€…æ˜¾ç¤ºçš„ URL ä¸æ­£ç¡®

**åŸå› **: å‰ç«¯ç¯å¢ƒå˜é‡æœªé…ç½®

**è§£å†³æ–¹æ¡ˆ**:

1. æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•æ˜¯å¦æœ‰ `.env` æ–‡ä»¶
2. ç¡®ä¿åŒ…å«ä»¥ä¸‹å˜é‡ï¼š
   ```bash
   VITE_SUPABASE_URL=https://jirudzbqcxviytcmxegf.supabase.co
   VITE_SUPABASE_ANON_KEY=your-anon-key-here
   ```

3. å¦‚æœæ˜¯ Vercel éƒ¨ç½²ï¼Œåœ¨ Vercel Dashboard é…ç½®ç¯å¢ƒå˜é‡ï¼š
   - Settings â†’ Environment Variables
   - æ·»åŠ  `VITE_SUPABASE_URL` å’Œ `VITE_SUPABASE_ANON_KEY`
   - é‡æ–°éƒ¨ç½²

---

## ğŸ¯ å®Œæ•´çš„åˆ›å»ºç®¡ç†å‘˜æµç¨‹ï¼ˆä»å¤´å¼€å§‹ï¼‰

å¦‚æœæ‚¨è¿˜æ²¡æœ‰åˆ›å»ºç®¡ç†å‘˜ï¼Œæˆ–è€…æƒ³é‡æ–°åˆ›å»ºï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹å®Œæ•´æµç¨‹ï¼š

### æ­¥éª¤ 1: åœ¨ Supabase åˆ›å»ºç”¨æˆ·

1. ç™»å½• [Supabase Dashboard](https://supabase.com/dashboard)
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. ç‚¹å‡»å·¦ä¾§èœå• **Authentication** â†’ **Users**
4. ç‚¹å‡»å³ä¸Šè§’ **Add user** â†’ **Create new user**
5. å¡«å†™ä¿¡æ¯ï¼š
   - Email: `your-email@example.com`
   - Password: è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ï¼ˆè‡³å°‘ 6 ä½ï¼‰
   - âœ… **å‹¾é€‰ "Auto Confirm User"** (è‡ªåŠ¨ç¡®è®¤ç”¨æˆ·)
6. ç‚¹å‡» **Create user**
7. **è®°ä¸‹ç”¨æˆ·çš„ ID**ï¼ˆåœ¨ç”¨æˆ·åˆ—è¡¨ä¸­å¯ä»¥çœ‹åˆ°ï¼‰

### æ­¥éª¤ 2: æ·»åŠ åˆ° admin_users è¡¨

1. ç‚¹å‡»å·¦ä¾§èœå• **SQL Editor**
2. ç‚¹å‡» **New Query**
3. å¤åˆ¶ä»¥ä¸‹ SQLï¼ˆæ›¿æ¢ä½ çš„ä¿¡æ¯ï¼‰ï¼š

```sql
-- æ·»åŠ ç®¡ç†å‘˜åˆ° admin_users è¡¨
INSERT INTO admin_users (user_id, email, role, is_active)
VALUES (
  'PASTE_USER_ID_HERE',  -- ä»æ­¥éª¤ 1 å¤åˆ¶çš„ç”¨æˆ· ID
  'your-email@example.com',  -- ä½ çš„é‚®ç®±
  'super_admin',  -- è§’è‰²ï¼šsuper_admin
  true  -- æ¿€æ´»çŠ¶æ€
)
ON CONFLICT (user_id) DO UPDATE
SET
  is_active = true,
  role = 'super_admin',
  updated_at = NOW();
```

4. ç‚¹å‡» **Run**

### æ­¥éª¤ 3: éªŒè¯

è¿è¡Œä»¥ä¸‹ SQL éªŒè¯æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š

```sql
SELECT
  au.email,
  au.role,
  au.is_active,
  u.confirmed_at,
  CASE
    WHEN au.is_active AND u.confirmed_at IS NOT NULL
    THEN 'âœ… å¯ä»¥ç™»å½•'
    WHEN NOT au.is_active
    THEN 'âŒ è´¦å·è¢«ç¦ç”¨'
    WHEN u.confirmed_at IS NULL
    THEN 'âŒ é‚®ç®±æœªç¡®è®¤'
    ELSE 'âš ï¸ æœªçŸ¥é—®é¢˜'
  END as login_status
FROM admin_users au
JOIN auth.users u ON u.id = au.user_id
WHERE au.email = 'your-email@example.com';  -- âš ï¸ æ›¿æ¢ä¸ºä½ çš„é‚®ç®±
```

å¦‚æœæ˜¾ç¤º "âœ… å¯ä»¥ç™»å½•"ï¼Œè¯´æ˜åˆ›å»ºæˆåŠŸï¼

### æ­¥éª¤ 4: æµ‹è¯•ç™»å½•

1. æ‰“å¼€ç™»å½•é¡µé¢ï¼š`http://localhost:3000/admin/login.html`
2. è¾“å…¥é‚®ç®±å’Œå¯†ç 
3. ç‚¹å‡»ç™»å½•

---

## ğŸ“ è¿˜æ˜¯æ— æ³•è§£å†³ï¼Ÿ

å¦‚æœæŒ‰ç…§ä¸Šè¿°æ­¥éª¤ä»ç„¶æ— æ³•ç™»å½•ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æµè§ˆå™¨è°ƒè¯•å·¥å…·çš„æˆªå›¾**
   - æ‰“å¼€ `/admin/debug-login.html`
   - è¿è¡Œæ‰€æœ‰ 4 ä¸ªæ­¥éª¤
   - æˆªå›¾æ‰€æœ‰æ—¥å¿—

2. **SQL è¯Šæ–­è„šæœ¬çš„ç»“æœ**
   - è¿è¡Œ `database/diagnose_login.sql`
   - æˆªå›¾æ‰€æœ‰æŸ¥è¯¢ç»“æœ

3. **æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯**
   - æ‰“å¼€ `/admin/login.html`
   - æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°
   - å°è¯•ç™»å½•
   - æˆªå›¾æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `database/diagnose_login.sql` - SQL è¯Šæ–­è„šæœ¬
- `database/fix_admin_login.sql` - SQL ä¿®å¤è„šæœ¬
- `admin/debug-login.html` - æµè§ˆå™¨è°ƒè¯•å·¥å…·
- `database/STEP_BY_STEP_INIT.md` - æ•°æ®åº“åˆå§‹åŒ–æŒ‡å—
- `QUICK_DEPLOY.md` - å¿«é€Ÿéƒ¨ç½²æŒ‡å—

---

**æœ€åæ›´æ–°**: 2025-11-05
