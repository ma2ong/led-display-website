#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
LED Display Website Admin Panel
åŸºäºFlaskçš„åç«¯ç®¡ç†ç³»ç»Ÿ
"""

from flask import Flask, render_template, request, redirect, url_for, flash, session, jsonify
from werkzeug.security import generate_password_hash, check_password_hash
from werkzeug.utils import secure_filename
import sqlite3
import os
import json
from datetime import datetime
from functools import wraps
from PIL import Image
import uuid

app = Flask(__name__)
app.secret_key = 'led_admin_secret_key_2024'
app.config['UPLOAD_FOLDER'] = 'static/uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max file size
app.config['ALLOWED_EXTENSIONS'] = {'png', 'jpg', 'jpeg', 'gif', 'webp'}
app.config['JSON_AS_ASCII'] = False  # Ensure UTF-8 for JSON responses

# ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
os.makedirs('static/uploads/products', exist_ok=True)
os.makedirs('static/uploads/news', exist_ok=True)
os.makedirs('static/uploads/cases', exist_ok=True)

# ç¡®ä¿å‰ç«¯assetsç›®å½•å­˜åœ¨
frontend_assets = os.path.join('..', 'assets', 'products')
os.makedirs(frontend_assets, exist_ok=True)

def allowed_file(filename):
    """æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦å…è®¸"""
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in app.config['ALLOWED_EXTENSIONS']

def process_uploaded_image(file, category='products'):
    """å¤„ç†ä¸Šä¼ çš„å›¾ç‰‡"""
    if file and allowed_file(file.filename):
        # ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
        filename = secure_filename(file.filename)
        name, ext = os.path.splitext(filename)
        unique_filename = f"{name}_{uuid.uuid4().hex[:8]}{ext}"
        
        # ä¿å­˜åˆ°adminé™æ€ç›®å½•
        admin_path = os.path.join(app.config['UPLOAD_FOLDER'], category, unique_filename)
        file.save(admin_path)
        
        # åŒæ—¶å¤åˆ¶åˆ°å‰ç«¯assetsç›®å½•
        frontend_path = os.path.join('..', 'assets', category, unique_filename)
        
        # ä½¿ç”¨PILå¤„ç†å›¾ç‰‡å¹¶ä¿å­˜åˆ°å‰ç«¯ç›®å½•
        try:
            with Image.open(admin_path) as img:
                # ä¼˜åŒ–å›¾ç‰‡å¤§å°
                if img.width > 1200:
                    ratio = 1200 / img.width
                    new_height = int(img.height * ratio)
                    img = img.resize((1200, new_height), Image.Resampling.LANCZOS)
                
                # ä¿å­˜åˆ°å‰ç«¯ç›®å½•
                img.save(frontend_path, optimize=True, quality=85)
        except Exception as e:
            print(f"å›¾ç‰‡å¤„ç†é”™è¯¯: {e}")
            # å¦‚æœå¤„ç†å¤±è´¥ï¼Œç›´æ¥å¤åˆ¶æ–‡ä»¶
            import shutil
            shutil.copy2(admin_path, frontend_path)
        
        return f"assets/{category}/{unique_filename}"
    return None

# æ•°æ®åº“åˆå§‹åŒ–
def init_db():
    """åˆå§‹åŒ–æ•°æ®åº“"""
    conn = sqlite3.connect('led_admin.db')
    cursor = conn.cursor()
    
    # ç®¡ç†å‘˜è¡¨
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS admins (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            email TEXT,
            role TEXT DEFAULT 'admin',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_login TIMESTAMP
        )
    ''')
    
    # äº§å“è¡¨
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name_en TEXT NOT NULL,
            name_zh TEXT NOT NULL,
            category TEXT NOT NULL,
            description_en TEXT,
            description_zh TEXT,
            specifications TEXT,
            features TEXT,
            images TEXT,
            price REAL,
            status TEXT DEFAULT 'active',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # æ–°é—»è¡¨
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS news (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title_en TEXT NOT NULL,
            title_zh TEXT NOT NULL,
            content_en TEXT,
            content_zh TEXT,
            category TEXT,
            image TEXT,
            author TEXT,
            status TEXT DEFAULT 'published',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # æ¡ˆä¾‹è¡¨
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS cases (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title_en TEXT NOT NULL,
            title_zh TEXT NOT NULL,
            description_en TEXT,
            description_zh TEXT,
            category TEXT,
            location TEXT,
            client TEXT,
            images TEXT,
            project_date DATE,
            status TEXT DEFAULT 'published',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # è¯¢ç›˜è¡¨
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS inquiries (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT NOT NULL,
            company TEXT,
            phone TEXT,
            product_interest TEXT,
            message TEXT,
            status TEXT DEFAULT 'new',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            handled_by TEXT,
            handled_at TIMESTAMP
        )
    ''')
    
    # æŠ¥ä»·è¯·æ±‚è¡¨
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS quotes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT NOT NULL,
            company TEXT NOT NULL,
            product_type TEXT,
            display_size TEXT,
            quantity INTEGER,
            requirements TEXT,
            timeline TEXT,
            budget TEXT,
            status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            handled_by TEXT,
            handled_at TIMESTAMP
        )
    ''')
    
    # ç½‘ç«™è®¾ç½®è¡¨
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS settings (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            key TEXT UNIQUE NOT NULL,
            value TEXT,
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
    cursor.execute('SELECT COUNT(*) FROM admins')
    if cursor.fetchone()[0] == 0:
        default_password = generate_password_hash('admin123')
        cursor.execute('''
            INSERT INTO admins (username, password_hash, email, role)
            VALUES (?, ?, ?, ?)
        ''', ('admin', default_password, 'admin@lianjinled.com', 'super_admin'))
    
    # æ’å…¥å‰ç«¯ç½‘é¡µå·²æœ‰çš„äº§å“æ•°æ®
    cursor.execute('SELECT COUNT(*) FROM products')
    if cursor.fetchone()[0] == 0:
        default_products = [
            ('Fine Pitch LED Display', 'å°é—´è·LEDæ˜¾ç¤ºå±', 'fine-pitch', 
             'Ultra-high resolution displays with pixel pitches from P0.9 to P1.56, perfect for control rooms, broadcast studios, and corporate environments.',
             'åƒç´ é—´è·ä»P0.9åˆ°P1.56çš„è¶…é«˜åˆ†è¾¨ç‡æ˜¾ç¤ºå±ï¼Œå®Œç¾é€‚ç”¨äºæ§åˆ¶å®¤ã€å¹¿æ’­æ¼”æ’­å®¤å’Œä¼ä¸šç¯å¢ƒã€‚',
             'Pixel Pitch: P0.9-P1.56\nResolution: 4K/8K\nBrightness: 600-1200 nits\nRefresh Rate: 3840Hz\nViewing Angle: 160Â°/160Â°',
             '4K/8K Resolution, Seamless Splicing, High Refresh Rate',
             'assets/products/fine-pitch-led.jpg', 'active'),
            
            ('Outdoor LED Display', 'æˆ·å¤–LEDæ˜¾ç¤ºå±', 'outdoor',
             'Weather-resistant displays for outdoor advertising and information with high brightness and energy efficiency.',
             'é€‚ç”¨äºæˆ·å¤–å¹¿å‘Šå’Œä¿¡æ¯æ˜¾ç¤ºçš„é˜²é£é›¨æ˜¾ç¤ºå±ï¼Œå…·æœ‰é«˜äº®åº¦å’ŒèŠ‚èƒ½ç‰¹æ€§ã€‚',
             'Pixel Pitch: P3-P10\nBrightness: 5000-8000 nits\nIP Rating: IP65\nOperating Temperature: -40Â°C to +60Â°C\nViewing Distance: 3-100m',
             'IP65 Waterproof, High Brightness, Energy Efficient',
             'assets/products/outdoor-led.jpg', 'active'),
            
            ('Indoor LED Display', 'å®¤å†…LEDæ˜¾ç¤ºå±', 'indoor',
             'High-quality displays for indoor commercial and corporate applications with full color display and easy installation.',
             'é€‚ç”¨äºå®¤å†…å•†ä¸šå’Œä¼ä¸šåº”ç”¨çš„é«˜è´¨é‡æ˜¾ç¤ºå±ï¼Œå…·æœ‰å…¨å½©æ˜¾ç¤ºå’Œæ˜“äºå®‰è£…çš„ç‰¹ç‚¹ã€‚',
             'Pixel Pitch: P1.25-P4\nBrightness: 800-1500 nits\nRefresh Rate: 1920-3840Hz\nColor Temperature: 3200K-9300K\nLifespan: 100,000 hours',
             'Full Color Display, Easy Installation, Low Maintenance',
             'assets/products/indoor-led.jpg', 'active'),
            
            ('Transparent LED Display', 'é€æ˜LEDæ˜¾ç¤ºå±', 'transparent',
             'Innovative transparent displays that blend seamlessly with architecture while delivering stunning visual impact.',
             'ä¸å»ºç­‘å®Œç¾èåˆçš„åˆ›æ–°é€æ˜æ˜¾ç¤ºå±ï¼ŒåŒæ—¶æä¾›ä»¤äººæƒŠå¹çš„è§†è§‰å†²å‡»ã€‚',
             'Transparency: 70-90%\nPixel Pitch: P3.91-P7.81\nBrightness: 4000-6000 nits\nWeight: 12kg/mÂ²\nMaintenance: Front/Rear',
             '90% Transparency, Lightweight Design, Creative Applications',
             'assets/products/transparent-led.jpg', 'active'),
            
            ('Creative LED Display', 'åˆ›æ„LEDæ˜¾ç¤ºå±', 'creative',
             'Custom-shaped displays for unique architectural and artistic applications with flexible design options.',
             'é€‚ç”¨äºç‹¬ç‰¹å»ºç­‘å’Œè‰ºæœ¯åº”ç”¨çš„å®šåˆ¶å½¢çŠ¶æ˜¾ç¤ºå±ï¼Œå…·æœ‰çµæ´»çš„è®¾è®¡é€‰é¡¹ã€‚',
             'Shape: Customizable\nPixel Pitch: P1.25-P10\nCurve Radius: Râ‰¥500mm\nInstallation: Flexible\nControl: Professional',
             'Custom Shapes, Flexible Design, Artistic Integration',
             'assets/products/creative-led.jpg', 'active'),
            
            ('Rental LED Display', 'ç§ŸèµLEDæ˜¾ç¤ºå±', 'rental',
             'Portable and quick-setup displays for events and temporary installations with lightweight and durable design.',
             'é€‚ç”¨äºæ´»åŠ¨å’Œä¸´æ—¶å®‰è£…çš„ä¾¿æºå¼å¿«é€Ÿå®‰è£…æ˜¾ç¤ºå±ï¼Œå…·æœ‰è½»é‡åŒ–å’Œè€ç”¨çš„è®¾è®¡ã€‚',
             'Pixel Pitch: P2.6-P4.81\nWeight: 6-8kg/panel\nSetup Time: <30min\nConnection: Quick Lock\nFlight Case: Available',
             'Quick Setup, Lightweight, Durable Design',
             'assets/products/rental-led.jpg', 'active')
        ]
        
        for product in default_products:
            cursor.execute('''
                INSERT INTO products (
                    name_en, name_zh, category, description_en, description_zh,
                    specifications, features, images, status
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', product)
    
    # æ’å…¥é»˜è®¤è®¾ç½®
    default_settings = [
        ('site_title_en', 'Lianjin LED Display', 'English site title'),
        ('site_title_zh', 'è”é”¦LEDæ˜¾ç¤ºå±', 'Chinese site title'),
        ('company_phone', '+86-755-1234-5678', 'Company phone number'),
        ('company_email', 'info@lianjinled.com', 'Company email'),
        ('company_address_en', 'Shenzhen, Guangdong Province, China', 'English address'),
        ('company_address_zh', 'ä¸­å›½å¹¿ä¸œçœæ·±åœ³å¸‚', 'Chinese address')
    ]
    
    for key, value, desc in default_settings:
        cursor.execute('''
            INSERT OR IGNORE INTO settings (key, value, description)
            VALUES (?, ?, ?)
        ''', (key, value, desc))
    
    conn.commit()
    conn.close()

# ç™»å½•éªŒè¯è£…é¥°å™¨
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'admin_id' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

# æ•°æ®åº“è¿æ¥å‡½æ•°
def get_db_connection():
    conn = sqlite3.connect('led_admin.db')
    conn.row_factory = sqlite3.Row
    return conn

# è·¯ç”±å®šä¹‰
@app.route('/')
@login_required
def dashboard():
    """ç®¡ç†åå°é¦–é¡µ"""
    conn = get_db_connection()
    
    # è·å–ç»Ÿè®¡æ•°æ®
    stats = {
        'products': conn.execute('SELECT COUNT(*) FROM products WHERE status = "active"').fetchone()[0],
        'news': conn.execute('SELECT COUNT(*) FROM news WHERE status = "published"').fetchone()[0],
        'cases': conn.execute('SELECT COUNT(*) FROM cases WHERE status = "published"').fetchone()[0],
        'inquiries': conn.execute('SELECT COUNT(*) FROM inquiries WHERE status = "new"').fetchone()[0],
        'quotes': conn.execute('SELECT COUNT(*) FROM quotes WHERE status = "pending"').fetchone()[0]
    }
    
    # è·å–æœ€æ–°è¯¢ç›˜
    recent_inquiries = conn.execute('''
        SELECT * FROM inquiries 
        ORDER BY created_at DESC 
        LIMIT 5
    ''').fetchall()
    
    # è·å–æœ€æ–°æŠ¥ä»·è¯·æ±‚
    recent_quotes = conn.execute('''
        SELECT * FROM quotes 
        ORDER BY created_at DESC 
        LIMIT 5
    ''').fetchall()
    
    conn.close()
    
    return render_template('dashboard.html', 
                         stats=stats, 
                         recent_inquiries=recent_inquiries,
                         recent_quotes=recent_quotes)

@app.route('/login', methods=['GET', 'POST'])
def login():
    """ç®¡ç†å‘˜ç™»å½•"""
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        
        conn = get_db_connection()
        admin = conn.execute(
            'SELECT * FROM admins WHERE username = ?', (username,)
        ).fetchone()
        conn.close()
        
        if admin and check_password_hash(admin['password_hash'], password):
            session['admin_id'] = admin['id']
            session['admin_username'] = admin['username']
            session['admin_role'] = admin['role']
            
            # æ›´æ–°æœ€åç™»å½•æ—¶é—´
            conn = get_db_connection()
            conn.execute(
                'UPDATE admins SET last_login = CURRENT_TIMESTAMP WHERE id = ?',
                (admin['id'],)
            )
            conn.commit()
            conn.close()
            
            flash('ç™»å½•æˆåŠŸï¼', 'success')
            return redirect(url_for('dashboard'))
        else:
            flash('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼', 'error')
    
    return render_template('login.html')

@app.route('/logout')
def logout():
    """ç®¡ç†å‘˜ç™»å‡º"""
    session.clear()
    flash('å·²æˆåŠŸç™»å‡ºï¼', 'info')
    return redirect(url_for('login'))

# äº§å“ç®¡ç†
@app.route('/products')
@login_required
def products():
    """äº§å“åˆ—è¡¨"""
    conn = get_db_connection()
    products = conn.execute('''
        SELECT * FROM products 
        ORDER BY created_at DESC
    ''').fetchall()
    conn.close()
    
    return render_template('products.html', products=products)

@app.route('/products/add', methods=['GET', 'POST'])
@login_required
def add_product():
    """æ·»åŠ äº§å“"""
    if request.method == 'POST':
        data = request.form
        
        # å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        image_path = None
        if 'product_image' in request.files:
            file = request.files['product_image']
            if file.filename != '':
                image_path = process_uploaded_image(file, 'products')
        
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO products (
                name_en, name_zh, category, description_en, description_zh,
                specifications, features, images, price, status
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            data['name_en'], data['name_zh'], data['category'],
            data['description_en'], data['description_zh'],
            data['specifications'], data['features'],
            image_path or data.get('images', ''),
            float(data['price']) if data['price'] else None,
            data['status']
        ))
        
        # è·å–æ–°åˆ›å»ºçš„äº§å“ID
        product_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        flash('äº§å“æ·»åŠ æˆåŠŸï¼', 'success')
        return redirect(url_for('products'))
    
    return render_template('product_form.html', action='add')

# APIæ¥å£ - ç”¨äºå‰ç«¯ç½‘ç«™
@app.route('/api/contact', methods=['POST'])
def api_contact():
    """æ¥æ”¶è”ç³»è¡¨å•"""
    data = request.get_json()
    
    conn = get_db_connection()
    conn.execute('''
        INSERT INTO inquiries (name, email, company, phone, product_interest, message)
        VALUES (?, ?, ?, ?, ?, ?)
    ''', (
        data.get('name'), data.get('email'), data.get('company'),
        data.get('phone'), data.get('product'), data.get('message')
    ))
    conn.commit()
    conn.close()
    
    return jsonify({'status': 'success', 'message': 'Thank you for your inquiry!'})

@app.route('/api/products', methods=['GET'])
def api_products():
    """è·å–äº§å“åˆ—è¡¨API - ä¾›å‰ç«¯ç½‘ç«™ä½¿ç”¨"""
    conn = get_db_connection()
    products = conn.execute('''
        SELECT * FROM products WHERE status = 'active'
        ORDER BY created_at DESC
    ''').fetchall()
    conn.close()
    
    products_list = []
    for product in products:
        products_list.append({
            'id': product['id'],
            'name_en': product['name_en'],
            'name_zh': product['name_zh'],
            'category': product['category'],
            'description_en': product['description_en'],
            'description_zh': product['description_zh'],
            'specifications': product['specifications'],
            'features': product['features'],
            'images': product['images'],
            'price': product['price']
        })
    
    response = jsonify({'status': 'success', 'products': products_list})
    response.headers['Content-Type'] = 'application/json; charset=utf-8'
    return response

# æ³¨å†ŒAPIè“å›¾
try:
    from api import api_bp
    app.register_blueprint(api_bp)
except ImportError:
    print("Warning: API blueprint not found, continuing without it")

if __name__ == '__main__':
    init_db()
    print("ğŸš€ LED Display Admin Panel Starting...")
    print("ğŸ“ Admin URL: http://localhost:5000")
    print("ğŸ‘¤ Default Login: admin / admin123")
    print("ğŸ”— API Endpoints: http://localhost:5000/api/")
    print("=" * 50)
    app.run(debug=False, host='0.0.0.0', port=5000, use_reloader=False)