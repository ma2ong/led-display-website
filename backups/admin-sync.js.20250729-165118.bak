/**
 * Frontend-Backend Synchronization System
 * ÂâçÂêéÁ´ØÂêåÊ≠•Á≥ªÁªü
 */

class AdminSync {
    constructor() {
        this.apiBase = 'http://localhost:5000/api';
        this.lastSync = localStorage.getItem('lastSync');
        this.syncInterval = 30000; // 30 seconds
        this.init();
    }

    init() {
        // È°µÈù¢Âä†ËΩΩÊó∂ÂêåÊ≠•Êï∞ÊçÆ
        this.syncData();
        
        // ÂÆöÊúüÂêåÊ≠•Êï∞ÊçÆ
        setInterval(() => {
            this.syncData();
        }, this.syncInterval);
        
        // ÁõëÂê¨È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.syncData();
            }
        });
    }

    async syncData() {
        try {
            console.log('üîÑ Syncing data with backend...');
            
            // ÂêåÊ≠•‰∫ßÂìÅÊï∞ÊçÆ
            await this.syncProducts();
            
            // ÂêåÊ≠•Êñ∞ÈóªÊï∞ÊçÆ
            await this.syncNews();
            
            // ÂêåÊ≠•Ê°à‰æãÊï∞ÊçÆ
            await this.syncCases();
            
            // ÂêåÊ≠•ÂÖ¨Âè∏‰ø°ÊÅØ
            await this.syncCompanyInfo();
            
            // Êõ¥Êñ∞ÂêåÊ≠•Êó∂Èó¥
            this.lastSync = new Date().toISOString();
            localStorage.setItem('lastSync', this.lastSync);
            
            console.log('‚úÖ Data sync completed');
            this.updateSyncStatus('success');
            
        } catch (error) {
            console.error('‚ùå Sync failed:', error);
            this.updateSyncStatus('error');
        }
    }

    async syncProducts() {
        try {
            const response = await fetch(`${this.apiBase}/products`);
            const data = await response.json();
            
            if (data.success) {
                // Êõ¥Êñ∞‰∫ßÂìÅÈ°µÈù¢ÂÜÖÂÆπ
                this.updateProductsDisplay(data.products);
                
                // Êõ¥Êñ∞‰∫ßÂìÅËØ¶ÊÉÖÈ°µÈù¢
                this.updateProductDetailPages(data.products);
                
                console.log(`üì¶ Synced ${data.products.length} products`);
            }
        } catch (error) {
            console.error('Failed to sync products:', error);
        }
    }

    async syncNews() {
        try {
            const response = await fetch(`${this.apiBase}/news`);
            const data = await response.json();
            
            if (data.success) {
                this.updateNewsDisplay(data.news);
                console.log(`üì∞ Synced ${data.news.length} news items`);
            }
        } catch (error) {
            console.error('Failed to sync news:', error);
        }
    }

    async syncCases() {
        try {
            const response = await fetch(`${this.apiBase}/cases`);
            const data = await response.json();
            
            if (data.success) {
                this.updateCasesDisplay(data.cases);
                console.log(`üíº Synced ${data.cases.length} cases`);
            }
        } catch (error) {
            console.error('Failed to sync cases:', error);
        }
    }

    async syncCompanyInfo() {
        try {
            const response = await fetch(`${this.apiBase}/company-info`);
            const data = await response.json();
            
            if (data.success) {
                this.updateCompanyInfo(data.company_info);
                console.log('üè¢ Synced company info');
            }
        } catch (error) {
            console.error('Failed to sync company info:', error);
        }
    }

    updateProductsDisplay(products) {
        // Êõ¥Êñ∞‰∫ßÂìÅÈ°µÈù¢ÁöÑ‰∫ßÂìÅÂàóË°®
        const productGrid = document.querySelector('.product-grid');
        if (productGrid && products.length > 0) {
            productGrid.innerHTML = products.map(product => `
                <div class="col-lg-4 col-md-6 mb-4" data-aos="fade-up">
                    <div class="card product-card h-100">
                        <div class="card-img-container">
                            <img src="${product.images || 'assets/products/placeholder.jpg'}" 
                                 class="card-img-top" alt="${product.name_en}">
                            <div class="card-overlay">
                                <a href="${this.getCategoryPage(product.category)}" class="btn btn-primary">
                                    <i class="fas fa-eye me-2"></i>View Details
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${product.name_en}</h5>
                            <p class="card-text">${product.description_en}</p>
                            <div class="product-features">
                                ${product.features ? product.features.split(',').map(feature => 
                                    `<span class="badge bg-primary me-1">${feature.trim()}</span>`
                                ).join('') : ''}
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">Category: ${product.category}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Êõ¥Êñ∞È¶ñÈ°µ‰∫ßÂìÅÂ±ïÁ§∫
        const homeProducts = document.querySelector('.home-products');
        if (homeProducts && products.length > 0) {
            const featuredProducts = products.slice(0, 6);
            homeProducts.innerHTML = featuredProducts.map(product => `
                <div class="col-lg-4 col-md-6 mb-4" data-aos="fade-up">
                    <div class="card product-card h-100">
                        <img src="${product.images || 'assets/products/placeholder.jpg'}" 
                             class="card-img-top" alt="${product.name_en}">
                        <div class="card-body">
                            <h5 class="card-title">${product.name_en}</h5>
                            <p class="card-text">${product.description_en}</p>
                            <a href="${this.getCategoryPage(product.category)}" class="btn btn-primary">
                                Learn More
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    updateProductDetailPages(products) {
        // Ê†πÊçÆÂΩìÂâçÈ°µÈù¢Êõ¥Êñ∞ÂØπÂ∫îÁöÑ‰∫ßÂìÅËØ¶ÊÉÖ
        const currentPage = window.location.pathname.split('/').pop();
        const pageProduct = products.find(p => 
            currentPage.includes(p.category) || 
            currentPage === `${p.category}.html`
        );

        if (pageProduct) {
            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
            const pageTitle = document.querySelector('.hero-title');
            if (pageTitle) {
                pageTitle.textContent = pageProduct.name_en;
            }

            // Êõ¥Êñ∞‰∫ßÂìÅÊèèËø∞
            const pageDescription = document.querySelector('.hero-subtitle');
            if (pageDescription) {
                pageDescription.textContent = pageProduct.description_en;
            }

            // Êõ¥Êñ∞‰∫ßÂìÅÂõæÁâá
            const productImage = document.querySelector('.product-image-container img');
            if (productImage && pageProduct.images) {
                productImage.src = pageProduct.images;
                productImage.alt = pageProduct.name_en;
            }

            // Êõ¥Êñ∞ËßÑÊ†ºË°®Ê†º
            if (pageProduct.specifications) {
                this.updateSpecificationsTable(pageProduct.specifications);
            }
        }
    }

    updateSpecificationsTable(specifications) {
        const specTable = document.querySelector('#specifications table tbody');
        if (specTable && specifications) {
            const specs = specifications.split('\n').filter(line => line.trim());
            const tableRows = specs.map(spec => {
                const [key, value] = spec.split(':').map(s => s.trim());
                return `<tr><td><strong>${key}</strong></td><td>${value}</td></tr>`;
            }).join('');
            
            if (tableRows) {
                specTable.innerHTML = tableRows;
            }
        }
    }

    updateNewsDisplay(news) {
        const newsContainer = document.querySelector('.news-container');
        if (newsContainer && news.length > 0) {
            newsContainer.innerHTML = news.slice(0, 6).map(item => `
                <div class="col-lg-4 col-md-6 mb-4" data-aos="fade-up">
                    <div class="card news-card h-100">
                        <img src="${item.image || 'assets/news/placeholder.jpg'}" 
                             class="card-img-top" alt="${item.title_en}">
                        <div class="card-body">
                            <h5 class="card-title">${item.title_en}</h5>
                            <p class="card-text">${item.content_en ? item.content_en.substring(0, 150) + '...' : ''}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-2"></i>
                                ${new Date(item.created_at).toLocaleDateString()}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    updateCasesDisplay(cases) {
        const casesContainer = document.querySelector('.cases-container');
        if (casesContainer && cases.length > 0) {
            casesContainer.innerHTML = cases.slice(0, 6).map(caseItem => `
                <div class="col-lg-4 col-md-6 mb-4" data-aos="fade-up">
                    <div class="card case-card h-100">
                        <img src="${caseItem.images || 'assets/cases/placeholder.jpg'}" 
                             class="card-img-top" alt="${caseItem.title_en}">
                        <div class="card-body">
                            <h5 class="card-title">${caseItem.title_en}</h5>
                            <p class="card-text">${caseItem.description_en}</p>
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                ${caseItem.location}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    updateCompanyInfo(companyInfo) {
        // Êõ¥Êñ∞ËÅîÁ≥ª‰ø°ÊÅØ
        const phoneElements = document.querySelectorAll('.company-phone');
        phoneElements.forEach(el => {
            if (companyInfo.phone) el.textContent = companyInfo.phone;
        });

        const emailElements = document.querySelectorAll('.company-email');
        emailElements.forEach(el => {
            if (companyInfo.email) el.textContent = companyInfo.email;
        });

        const addressElements = document.querySelectorAll('.company-address');
        addressElements.forEach(el => {
            if (companyInfo.address_en) el.textContent = companyInfo.address_en;
        });
    }

    getCategoryPage(category) {
        const categoryPages = {
            'fine-pitch': 'fine-pitch.html',
            'outdoor': 'outdoor.html',
            'indoor': 'products.html',
            'transparent': 'transparent.html',
            'creative': 'creative.html',
            'rental': 'rental.html'
        };
        return categoryPages[category] || 'products.html';
    }

    updateSyncStatus(status) {
        // ÂàõÂª∫ÂêåÊ≠•Áä∂ÊÄÅÊåáÁ§∫Âô®
        let statusIndicator = document.querySelector('.sync-status');
        if (!statusIndicator) {
            statusIndicator = document.createElement('div');
            statusIndicator.className = 'sync-status';
            statusIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 9999;
                transition: all 0.3s ease;
            `;
            document.body.appendChild(statusIndicator);
        }

        if (status === 'success') {
            statusIndicator.style.backgroundColor = '#10b981';
            statusIndicator.style.color = 'white';
            statusIndicator.innerHTML = '<i class="fas fa-check me-1"></i>Synced';
            
            // 3ÁßíÂêéÈöêËóè
            setTimeout(() => {
                statusIndicator.style.opacity = '0';
            }, 3000);
        } else if (status === 'error') {
            statusIndicator.style.backgroundColor = '#ef4444';
            statusIndicator.style.color = 'white';
            statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Sync Error';
        }

        // ÈáçÁΩÆÈÄèÊòéÂ∫¶
        statusIndicator.style.opacity = '1';
    }

    // ÊâãÂä®Ëß¶ÂèëÂêåÊ≠•
    async forcSync() {
        await this.syncData();
    }

    // Ëé∑ÂèñÂêåÊ≠•Áä∂ÊÄÅ
    getSyncStatus() {
        return {
            lastSync: this.lastSync,
            isOnline: navigator.onLine,
            syncInterval: this.syncInterval
        };
    }
}

// ÂàùÂßãÂåñÂêåÊ≠•Á≥ªÁªü
document.addEventListener('DOMContentLoaded', () => {
    window.adminSync = new AdminSync();
    
    // Ê∑ªÂä†ÊâãÂä®ÂêåÊ≠•ÊåâÈíÆÔºàÂèØÈÄâÔºâ
    const syncButton = document.createElement('button');
    syncButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
    syncButton.className = 'btn btn-sm btn-outline-primary sync-btn';
    syncButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        z-index: 9998;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    syncButton.title = 'Manual Sync';
    syncButton.onclick = () => {
        syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        window.adminSync.forcSync().finally(() => {
            syncButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
        });
    };
    
    document.body.appendChild(syncButton);
});

// ÂØºÂá∫‰æõÂÖ∂‰ªñËÑöÊú¨‰ΩøÁî®
window.AdminSync = AdminSync;