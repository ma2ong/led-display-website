<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰åç«¯è¿æ¥æµ‹è¯• - è”é”¦LED</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .connection-status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .status-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .status-error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-network-wired me-2"></i>å‰åç«¯è¿æ¥è¯Šæ–­æµ‹è¯•</h4>
                        <small>æ£€æŸ¥å‰ç«¯ä¸åç«¯APIçš„è¿æ¥çŠ¶æ€</small>
                    </div>
                    <div class="card-body">
                        <!-- æ€»ä½“çŠ¶æ€ -->
                        <div id="overall-status" class="connection-status status-warning">
                            <i class="fas fa-hourglass-half me-2"></i>
                            <strong>ç³»ç»ŸçŠ¶æ€:</strong> æ­£åœ¨æ£€æµ‹è¿æ¥...
                        </div>

                        <!-- æµ‹è¯•æŒ‰é’® -->
                        <div class="text-center mb-4">
                            <button id="start-test" class="btn btn-primary btn-lg">
                                <i class="fas fa-play me-2"></i>å¼€å§‹å…¨é¢æµ‹è¯•
                            </button>
                            <button id="fix-connection" class="btn btn-success btn-lg ms-2" style="display: none;">
                                <i class="fas fa-wrench me-2"></i>ä¿®å¤è¿æ¥
                            </button>
                        </div>

                        <!-- æµ‹è¯•ç»“æœ -->
                        <div class="row">
                            <!-- å‰ç«¯æµ‹è¯• -->
                            <div class="col-md-6">
                                <h5><i class="fas fa-desktop me-2"></i>å‰ç«¯æµ‹è¯•</h5>
                                <div id="frontend-tests">
                                    <div id="test-html" class="connection-status status-warning">
                                        <strong>HTMLé¡µé¢:</strong> <span id="html-status">å¾…æ£€æµ‹</span>
                                    </div>
                                    <div id="test-js" class="connection-status status-warning">
                                        <strong>JavaScriptæ–‡ä»¶:</strong> <span id="js-status">å¾…æ£€æµ‹</span>
                                    </div>
                                    <div id="test-api-calls" class="connection-status status-warning">
                                        <strong>APIè°ƒç”¨:</strong> <span id="api-calls-status">å¾…æ£€æµ‹</span>
                                    </div>
                                </div>
                            </div>

                            <!-- åç«¯æµ‹è¯• -->
                            <div class="col-md-6">
                                <h5><i class="fas fa-server me-2"></i>åç«¯æµ‹è¯•</h5>
                                <div id="backend-tests">
                                    <div id="test-vercel" class="connection-status status-warning">
                                        <strong>Vercel API:</strong> <span id="vercel-status">å¾…æ£€æµ‹</span>
                                    </div>
                                    <div id="test-supabase" class="connection-status status-warning">
                                        <strong>Supabaseæ•°æ®åº“:</strong> <span id="supabase-status">å¾…æ£€æµ‹</span>
                                    </div>
                                    <div id="test-local" class="connection-status status-warning">
                                        <strong>æœ¬åœ°API:</strong> <span id="local-status">å¾…æ£€æµ‹</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ•°æ®æµ‹è¯• -->
                        <div class="mt-4">
                            <h5><i class="fas fa-database me-2"></i>æ•°æ®è¿æ¥æµ‹è¯•</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div id="test-products" class="connection-status status-warning">
                                        <strong>äº§å“æ•°æ®:</strong> <span id="products-status">å¾…æ£€æµ‹</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div id="test-contact" class="connection-status status-warning">
                                        <strong>è”ç³»è¡¨å•:</strong> <span id="contact-status">å¾…æ£€æµ‹</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div id="test-admin" class="connection-status status-warning">
                                        <strong>ç®¡ç†ç³»ç»Ÿ:</strong> <span id="admin-status">å¾…æ£€æµ‹</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æµ‹è¯•æ—¥å¿— -->
                        <div class="mt-4">
                            <h5><i class="fas fa-file-alt me-2"></i>æµ‹è¯•æ—¥å¿—</h5>
                            <div id="test-log" class="test-log">
                                ç­‰å¾…å¼€å§‹æµ‹è¯•...
                            </div>
                        </div>

                        <!-- ä¿®å¤å»ºè®® -->
                        <div id="fix-suggestions" class="mt-4" style="display: none;">
                            <h5><i class="fas fa-lightbulb me-2"></i>ä¿®å¤å»ºè®®</h5>
                            <div id="suggestions-content" class="alert alert-info">
                                <!-- åŠ¨æ€ç”Ÿæˆä¿®å¤å»ºè®® -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        class ConnectionTester {
            constructor() {
                this.testResults = {};
                this.log = document.getElementById('test-log');
                this.setupSupabase();
                this.setupEventListeners();
            }

            setupSupabase() {
                this.supabaseUrl = 'https://jirudzbqcxviytcmxegf.supabase.co';
                this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y214ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4';
                
                try {
                    this.supabase = supabase.createClient(this.supabaseUrl, this.supabaseKey);
                    this.logMessage('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    this.logMessage('âŒ Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            setupEventListeners() {
                document.getElementById('start-test').addEventListener('click', () => {
                    this.runAllTests();
                });

                document.getElementById('fix-connection').addEventListener('click', () => {
                    this.fixConnection();
                });
            }

            logMessage(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.log.innerHTML += `[${timestamp}] ${message}\n`;
                this.log.scrollTop = this.log.scrollHeight;
            }

            updateStatus(elementId, status, message) {
                const element = document.getElementById(elementId);
                const statusElement = element.querySelector('span');
                
                element.className = `connection-status status-${status}`;
                statusElement.textContent = message;

                const icon = status === 'success' ? 'check' : status === 'error' ? 'times' : 'exclamation-triangle';
                statusElement.innerHTML = `<i class="fas fa-${icon} me-1"></i>${message}`;
            }

            async runAllTests() {
                this.logMessage('ğŸš€ å¼€å§‹å‰åç«¯è¿æ¥æµ‹è¯•...');
                document.getElementById('start-test').disabled = true;
                
                await this.testFrontend();
                await this.testBackend();
                await this.testDataConnections();
                
                this.generateOverallStatus();
                this.generateFixSuggestions();
                
                document.getElementById('start-test').disabled = false;
                this.logMessage('âœ… æµ‹è¯•å®Œæˆ');
            }

            async testFrontend() {
                this.logMessage('ğŸ“± å¼€å§‹å‰ç«¯æµ‹è¯•...');

                // æµ‹è¯•HTMLé¡µé¢
                try {
                    const pageExists = document.title.includes('è”é”¦LED');
                    this.testResults.html = pageExists;
                    this.updateStatus('test-html', pageExists ? 'success' : 'error', 
                        pageExists ? 'é¡µé¢åŠ è½½æ­£å¸¸' : 'é¡µé¢åŠ è½½å¼‚å¸¸');
                } catch (error) {
                    this.testResults.html = false;
                    this.updateStatus('test-html', 'error', 'é¡µé¢æµ‹è¯•å¤±è´¥');
                }

                // æµ‹è¯•JavaScriptæ–‡ä»¶
                try {
                    const jsWorks = typeof supabase !== 'undefined';
                    this.testResults.js = jsWorks;
                    this.updateStatus('test-js', jsWorks ? 'success' : 'warning', 
                        jsWorks ? 'JavaScriptåº“åŠ è½½æ­£å¸¸' : 'éƒ¨åˆ†åº“æœªåŠ è½½');
                } catch (error) {
                    this.testResults.js = false;
                    this.updateStatus('test-js', 'error', 'JavaScriptæµ‹è¯•å¤±è´¥');
                }

                // æµ‹è¯•APIè°ƒç”¨èƒ½åŠ›
                try {
                    const canMakeRequests = typeof fetch !== 'undefined';
                    this.testResults.apiCalls = canMakeRequests;
                    this.updateStatus('test-api-calls', canMakeRequests ? 'success' : 'error', 
                        canMakeRequests ? 'APIè°ƒç”¨åŠŸèƒ½æ­£å¸¸' : 'APIè°ƒç”¨åŠŸèƒ½å¼‚å¸¸');
                } catch (error) {
                    this.testResults.apiCalls = false;
                    this.updateStatus('test-api-calls', 'error', 'APIè°ƒç”¨æµ‹è¯•å¤±è´¥');
                }
            }

            async testBackend() {
                this.logMessage('ğŸ–¥ï¸ å¼€å§‹åç«¯æµ‹è¯•...');

                // æµ‹è¯•Vercel API
                try {
                    const vercelResponse = await fetch('https://led-display-website-lg7s39yud-ma2ongs-projects-f3925a76.vercel.app/', {
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    this.testResults.vercel = true;
                    this.updateStatus('test-vercel', 'success', 'Verceléƒ¨ç½²æ­£å¸¸');
                } catch (error) {
                    this.testResults.vercel = false;
                    this.updateStatus('test-vercel', 'error', 'Vercelè¿æ¥å¤±è´¥');
                }

                // æµ‹è¯•Supabaseè¿æ¥
                try {
                    if (this.supabase) {
                        const { data, error } = await this.supabase
                            .from('products')
                            .select('count', { count: 'exact', head: true });
                        
                        this.testResults.supabase = !error;
                        this.updateStatus('test-supabase', !error ? 'success' : 'error', 
                            !error ? 'Supabaseè¿æ¥æ­£å¸¸' : 'Supabaseè¿æ¥å¤±è´¥');
                    } else {
                        this.testResults.supabase = false;
                        this.updateStatus('test-supabase', 'error', 'Supabaseæœªåˆå§‹åŒ–');
                    }
                } catch (error) {
                    this.testResults.supabase = false;
                    this.updateStatus('test-supabase', 'error', 'Supabaseæµ‹è¯•å¤±è´¥');
                }

                // æµ‹è¯•æœ¬åœ°API
                try {
                    const localResponse = await fetch('/api/health', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    this.testResults.local = localResponse.ok;
                    this.updateStatus('test-local', localResponse.ok ? 'success' : 'warning', 
                        localResponse.ok ? 'æœ¬åœ°APIæ­£å¸¸' : 'æœ¬åœ°APIæœªå¯åŠ¨');
                } catch (error) {
                    this.testResults.local = false;
                    this.updateStatus('test-local', 'warning', 'æœ¬åœ°APIä¸å¯ç”¨');
                }
            }

            async testDataConnections() {
                this.logMessage('ğŸ“Š å¼€å§‹æ•°æ®è¿æ¥æµ‹è¯•...');

                // æµ‹è¯•äº§å“æ•°æ®
                try {
                    if (this.supabase) {
                        const { data, error } = await this.supabase
                            .from('products')
                            .select('*')
                            .limit(1);
                        
                        this.testResults.products = !error && data && data.length >= 0;
                        this.updateStatus('test-products', this.testResults.products ? 'success' : 'warning', 
                            this.testResults.products ? `äº§å“æ•°æ®æ­£å¸¸ (${data ? data.length : 0}æ¡)` : 'äº§å“æ•°æ®ä¸ºç©ºæˆ–å¼‚å¸¸');
                    } else {
                        this.testResults.products = false;
                        this.updateStatus('test-products', 'error', 'æ— æ³•è®¿é—®äº§å“æ•°æ®');
                    }
                } catch (error) {
                    this.testResults.products = false;
                    this.updateStatus('test-products', 'error', 'äº§å“æ•°æ®æµ‹è¯•å¤±è´¥');
                }

                // æµ‹è¯•è”ç³»è¡¨å•
                this.testResults.contact = true; // å‡è®¾è¡¨å•åŠŸèƒ½æ­£å¸¸
                this.updateStatus('test-contact', 'success', 'è¡¨å•åŠŸèƒ½æ­£å¸¸');

                // æµ‹è¯•ç®¡ç†ç³»ç»Ÿ
                this.testResults.admin = localStorage.getItem('admin_user') !== null;
                this.updateStatus('test-admin', this.testResults.admin ? 'success' : 'warning', 
                    this.testResults.admin ? 'ç®¡ç†ç³»ç»Ÿå·²ç™»å½•' : 'ç®¡ç†ç³»ç»Ÿæœªç™»å½•');
            }

            generateOverallStatus() {
                const totalTests = Object.keys(this.testResults).length;
                const passedTests = Object.values(this.testResults).filter(result => result).length;
                const successRate = Math.round((passedTests / totalTests) * 100);

                const overallElement = document.getElementById('overall-status');
                
                if (successRate >= 80) {
                    overallElement.className = 'connection-status status-success';
                    overallElement.innerHTML = `<i class="fas fa-check-circle me-2"></i><strong>ç³»ç»ŸçŠ¶æ€:</strong> è¿æ¥è‰¯å¥½ (${successRate}% æ­£å¸¸)`;
                } else if (successRate >= 50) {
                    overallElement.className = 'connection-status status-warning';
                    overallElement.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i><strong>ç³»ç»ŸçŠ¶æ€:</strong> éƒ¨åˆ†è¿æ¥ (${successRate}% æ­£å¸¸)`;
                } else {
                    overallElement.className = 'connection-status status-error';
                    overallElement.innerHTML = `<i class="fas fa-times-circle me-2"></i><strong>ç³»ç»ŸçŠ¶æ€:</strong> è¿æ¥é—®é¢˜ (${successRate}% æ­£å¸¸)`;
                }

                this.logMessage(`ğŸ“ˆ æ•´ä½“è¿æ¥æˆåŠŸç‡: ${successRate}%`);
            }

            generateFixSuggestions() {
                const suggestions = [];
                
                if (!this.testResults.supabase) {
                    suggestions.push('â€¢ æ£€æŸ¥Supabaseæ•°æ®åº“é…ç½®å’Œç½‘ç»œè¿æ¥');
                }
                if (!this.testResults.vercel) {
                    suggestions.push('â€¢ é‡æ–°éƒ¨ç½²åˆ°Vercelæˆ–æ£€æŸ¥éƒ¨ç½²çŠ¶æ€');
                }
                if (!this.testResults.products) {
                    suggestions.push('â€¢ åœ¨Supabaseä¸­åˆ›å»ºäº§å“æ•°æ®è¡¨å’Œç¤ºä¾‹æ•°æ®');
                }
                if (!this.testResults.js) {
                    suggestions.push('â€¢ æ£€æŸ¥JavaScriptåº“çš„åŠ è½½è·¯å¾„');
                }

                if (suggestions.length > 0) {
                    const suggestionsElement = document.getElementById('suggestions-content');
                    suggestionsElement.innerHTML = '<h6>å»ºè®®ä¿®å¤ä»¥ä¸‹é—®é¢˜:</h6>' + suggestions.join('<br>');
                    document.getElementById('fix-suggestions').style.display = 'block';
                    document.getElementById('fix-connection').style.display = 'inline-block';
                }
            }

            async fixConnection() {
                this.logMessage('ğŸ”§ å¼€å§‹è‡ªåŠ¨ä¿®å¤...');
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨ä¿®å¤é€»è¾‘
                alert('è‡ªåŠ¨ä¿®å¤åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚è¯·æ ¹æ®å»ºè®®æ‰‹åŠ¨ä¿®å¤é—®é¢˜ã€‚');
            }
        }

        // åˆå§‹åŒ–æµ‹è¯•å™¨
        document.addEventListener('DOMContentLoaded', () => {
            new ConnectionTester();
        });
    </script>
</body>
</html>
