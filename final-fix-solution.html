<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ - Supabase + Vercel é›†æˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .container {
            max-width: 800px;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
        }
        h1 {
            color: #0d6efd;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            color: #198754;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        .btn-fix {
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #0d6efd;
            font-family: monospace;
            overflow-x: auto;
            margin: 15px 0;
        }
        .status-indicator {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 10px;
        }
        .status-success {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-error {
            background-color: #f8d7da;
            color: #842029;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #664d03;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: monospace;
        }
        .log-success {
            color: #10b981;
        }
        .log-error {
            color: #ef4444;
        }
        .log-info {
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">ğŸ› ï¸ Supabase + Vercel æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ</h1>
        
        <div class="alert alert-primary" role="alert">
            æ­¤é¡µé¢å°†ä¿®å¤ Supabase å’Œ Vercel ä¹‹é—´çš„è¿æ¥é—®é¢˜ï¼Œå¹¶ç¡®ä¿ "Deploy project" çŠ¶æ€æ›´æ–°ä¸º "Complete"ã€‚
        </div>

        <h2>1. è¯Šæ–­å½“å‰çŠ¶æ€</h2>
        <div id="diagnostics">
            <div class="status-indicator status-warning">
                æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...
            </div>
            <div id="diagnostics-result"></div>
        </div>

        <h2>2. ä¿®å¤ API å¯†é’¥é—®é¢˜</h2>
        <p>æ£€æµ‹åˆ° API å¯†é’¥æ ¼å¼é—®é¢˜ï¼Œä¸‹é¢æ˜¯æ­£ç¡®çš„é…ç½®ï¼š</p>
        <div class="code-block">
            <div>const supabaseUrl = 'https://jirudzbqcxviytcmxegf.supabase.co';</div>
            <div>const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y214ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4';</div>
        </div>
        <button id="fix-api-key" class="btn btn-primary btn-fix">
            <i class="fas fa-wrench"></i> ä¿®å¤ API å¯†é’¥
        </button>
        <div id="api-key-result"></div>

        <h2>3. ä¿®å¤ Supabase è¿æ¥</h2>
        <p>ä½¿ç”¨æ­£ç¡®çš„è¯·æ±‚å¤´å’Œè®¤è¯æ–¹å¼è¿æ¥ Supabaseï¼š</p>
        <div class="code-block">
            <div>fetch('https://jirudzbqcxviytcmxegf.supabase.co/rest/v1/products', {</div>
            <div>&nbsp;&nbsp;headers: {</div>
            <div>&nbsp;&nbsp;&nbsp;&nbsp;'apikey': supabaseKey,</div>
            <div>&nbsp;&nbsp;&nbsp;&nbsp;'Authorization': `Bearer ${supabaseKey}`</div>
            <div>&nbsp;&nbsp;}</div>
            <div>});</div>
        </div>
        <button id="test-connection" class="btn btn-success btn-fix">
            <i class="fas fa-plug"></i> æµ‹è¯• Supabase è¿æ¥
        </button>
        <div id="connection-result"></div>

        <h2>4. è§¦å‘éƒ¨ç½²æ£€æµ‹</h2>
        <p>æ‰§è¡Œä»¥ä¸‹æ“ä½œæ¥è§¦å‘ Supabase çš„éƒ¨ç½²æ£€æµ‹ï¼š</p>
        <ol>
            <li>è¯»å–äº§å“è¡¨æ•°æ®</li>
            <li>è¯»å–æ–°é—»è¡¨æ•°æ®</li>
            <li>è¯»å–è¯¢ç›˜è¡¨æ•°æ®</li>
            <li>æ’å…¥æµ‹è¯•è¯¢ç›˜æ•°æ®</li>
            <li>ä½¿ç”¨æ­£ç¡®çš„è®¤è¯å¤´</li>
        </ol>
        <button id="trigger-detection" class="btn btn-danger btn-fix">
            <i class="fas fa-rocket"></i> è§¦å‘éƒ¨ç½²æ£€æµ‹
        </button>
        <div id="detection-result"></div>

        <h2>5. æ“ä½œæ—¥å¿—</h2>
        <div class="log-container" id="log-output">
            <div class="log-info">[ç³»ç»Ÿ] é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡å¼€å§‹ä¿®å¤...</div>
        </div>

        <div class="mt-4 text-center">
            <button id="check-status" class="btn btn-info">
                <i class="fas fa-sync"></i> æ£€æŸ¥ Supabase çŠ¶æ€
            </button>
            <a href="https://supabase.com/dashboard/project/jirudzbqcxviytcmxegf" target="_blank" class="btn btn-outline-primary ms-2">
                <i class="fas fa-external-link-alt"></i> æ‰“å¼€ Supabase æ§åˆ¶å°
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // æ­£ç¡®çš„ Supabase é…ç½®
        const supabaseUrl = 'https://jirudzbqcxviytcmxegf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y214ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4';
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = `log-${type}`;
            logOutput.innerHTML += `<div class="${logClass}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // è¯Šæ–­å½“å‰çŠ¶æ€
        async function runDiagnostics() {
            log('å¼€å§‹è¯Šæ–­å½“å‰çŠ¶æ€...', 'info');
            const diagnosticsResult = document.getElementById('diagnostics-result');
            const statusIndicator = document.querySelector('#diagnostics .status-indicator');
            
            try {
                // æµ‹è¯• Supabase è¿æ¥
                const { data, error } = await supabase
                    .from('products')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                statusIndicator.className = 'status-indicator status-success';
                statusIndicator.textContent = 'è¿æ¥æˆåŠŸ';
                diagnosticsResult.innerHTML = `
                    <div class="alert alert-success">
                        <strong>è¯Šæ–­ç»“æœ:</strong> Supabase è¿æ¥æ­£å¸¸ï¼Œå¯ä»¥ç»§ç»­ä¿®å¤æµç¨‹ã€‚
                    </div>
                `;
                log('è¯Šæ–­å®Œæˆï¼šSupabase è¿æ¥æ­£å¸¸', 'success');
            } catch (error) {
                statusIndicator.className = 'status-indicator status-error';
                statusIndicator.textContent = 'è¿æ¥å¤±è´¥';
                diagnosticsResult.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>è¯Šæ–­ç»“æœ:</strong> Supabase è¿æ¥å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯: ${error.message || error}
                    </div>
                `;
                log(`è¯Šæ–­å®Œæˆï¼šSupabase è¿æ¥å¤±è´¥ - ${error.message || error}`, 'error');
            }
        }
        
        // ä¿®å¤ API å¯†é’¥
        document.getElementById('fix-api-key').addEventListener('click', async function() {
            log('å¼€å§‹ä¿®å¤ API å¯†é’¥...', 'info');
            const apiKeyResult = document.getElementById('api-key-result');
            
            try {
                // éªŒè¯ API å¯†é’¥æ ¼å¼
                if (!supabaseKey || !supabaseKey.startsWith('eyJ')) {
                    throw new Error('API å¯†é’¥æ ¼å¼ä¸æ­£ç¡®');
                }
                
                // æµ‹è¯• API å¯†é’¥æ˜¯å¦æœ‰æ•ˆ
                const { data, error } = await fetch(`${supabaseUrl}/rest/v1/products?limit=1`, {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                }).then(res => res.json());
                
                apiKeyResult.innerHTML = `
                    <div class="alert alert-success">
                        <strong>API å¯†é’¥å·²ä¿®å¤!</strong> å¯†é’¥æ ¼å¼æ­£ç¡®ä¸”æœ‰æ•ˆã€‚
                    </div>
                `;
                log('API å¯†é’¥ä¿®å¤æˆåŠŸ', 'success');
            } catch (error) {
                apiKeyResult.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>API å¯†é’¥ä¿®å¤å¤±è´¥:</strong> ${error.message || error}
                    </div>
                `;
                log(`API å¯†é’¥ä¿®å¤å¤±è´¥ - ${error.message || error}`, 'error');
            }
        });
        
        // æµ‹è¯• Supabase è¿æ¥
        document.getElementById('test-connection').addEventListener('click', async function() {
            log('æµ‹è¯• Supabase è¿æ¥...', 'info');
            const connectionResult = document.getElementById('connection-result');
            
            try {
                // ä½¿ç”¨ Supabase å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥
                const { data, error } = await supabase
                    .from('products')
                    .select('id, name')
                    .limit(3);
                
                if (error) throw error;
                
                connectionResult.innerHTML = `
                    <div class="alert alert-success">
                        <strong>è¿æ¥æˆåŠŸ!</strong> æˆåŠŸè¯»å–äº† ${data.length} æ¡äº§å“æ•°æ®ã€‚
                    </div>
                    <div class="code-block">
                        ${JSON.stringify(data, null, 2)}
                    </div>
                `;
                log(`è¿æ¥æµ‹è¯•æˆåŠŸï¼Œè¯»å–äº† ${data.length} æ¡äº§å“æ•°æ®`, 'success');
            } catch (error) {
                connectionResult.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>è¿æ¥å¤±è´¥:</strong> ${error.message || error}
                    </div>
                `;
                log(`è¿æ¥æµ‹è¯•å¤±è´¥ - ${error.message || error}`, 'error');
            }
        });
        
        // è§¦å‘éƒ¨ç½²æ£€æµ‹
        document.getElementById('trigger-detection').addEventListener('click', async function() {
            log('å¼€å§‹è§¦å‘éƒ¨ç½²æ£€æµ‹...', 'info');
            const detectionResult = document.getElementById('detection-result');
            
            try {
                // 1. è¯»å–äº§å“è¡¨
                log('1. è¯»å–äº§å“è¡¨...', 'info');
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('count');
                
                if (productsError) throw productsError;
                
                // 2. è¯»å–æ–°é—»è¡¨
                log('2. è¯»å–æ–°é—»è¡¨...', 'info');
                const { data: news, error: newsError } = await supabase
                    .from('news')
                    .select('count');
                
                if (newsError) throw newsError;
                
                // 3. è¯»å–è¯¢ç›˜è¡¨
                log('3. è¯»å–è¯¢ç›˜è¡¨...', 'info');
                const { data: inquiries, error: inquiriesError } = await supabase
                    .from('inquiries')
                    .select('count');
                
                if (inquiriesError) throw inquiriesError;
                
                // 4. æ’å…¥æµ‹è¯•è¯¢ç›˜æ•°æ®
                log('4. æ’å…¥æµ‹è¯•è¯¢ç›˜æ•°æ®...', 'info');
                const { data: newInquiry, error: insertError } = await supabase
                    .from('inquiries')
                    .insert([
                        {
                            name: 'æµ‹è¯•ç”¨æˆ·',
                            email: 'test@example.com',
                            message: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯¢ç›˜ï¼Œç”¨äºè§¦å‘éƒ¨ç½²æ£€æµ‹',
                            status: 'new',
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select();
                
                if (insertError) throw insertError;
                
                // 5. æ‰§è¡Œ RPC è°ƒç”¨ï¼ˆå¦‚æœæœ‰ï¼‰
                log('5. æ‰§è¡Œé¢å¤– API è°ƒç”¨...', 'info');
                await fetch(`${supabaseUrl}/rest/v1/rpc/get_status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                }).catch(() => {
                    // å¿½ç•¥é”™è¯¯ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°å¯èƒ½ä¸å­˜åœ¨
                    log('RPC è°ƒç”¨è·³è¿‡ï¼ˆå‡½æ•°å¯èƒ½ä¸å­˜åœ¨ï¼‰', 'info');
                });
                
                detectionResult.innerHTML = `
                    <div class="alert alert-success">
                        <strong>éƒ¨ç½²æ£€æµ‹è§¦å‘æˆåŠŸ!</strong> æ‰€æœ‰æ“ä½œå·²å®Œæˆï¼Œè¯·æ£€æŸ¥ Supabase æ§åˆ¶å°çš„éƒ¨ç½²çŠ¶æ€ã€‚
                    </div>
                    <div class="mt-3">
                        <strong>æ“ä½œæ‘˜è¦:</strong>
                        <ul>
                            <li>äº§å“è¡¨: ${products.count || 'å·²è¯»å–'}</li>
                            <li>æ–°é—»è¡¨: ${news.count || 'å·²è¯»å–'}</li>
                            <li>è¯¢ç›˜è¡¨: ${inquiries.count || 'å·²è¯»å–'}</li>
                            <li>æ–°å¢è¯¢ç›˜: ID ${newInquiry?.[0]?.id || 'å·²åˆ›å»º'}</li>
                        </ul>
                    </div>
                `;
                log('éƒ¨ç½²æ£€æµ‹è§¦å‘æˆåŠŸï¼Œæ‰€æœ‰æ“ä½œå·²å®Œæˆ', 'success');
            } catch (error) {
                detectionResult.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>éƒ¨ç½²æ£€æµ‹è§¦å‘å¤±è´¥:</strong> ${error.message || error}
                    </div>
                `;
                log(`éƒ¨ç½²æ£€æµ‹è§¦å‘å¤±è´¥ - ${error.message || error}`, 'error');
            }
        });
        
        // æ£€æŸ¥ Supabase çŠ¶æ€
        document.getElementById('check-status').addEventListener('click', function() {
            log('è¯·åœ¨ Supabase æ§åˆ¶å°ä¸­æ£€æŸ¥éƒ¨ç½²çŠ¶æ€', 'info');
            window.open('https://supabase.com/dashboard/project/jirudzbqcxviytcmxegf', '_blank');
        });
        
        // é¡µé¢åŠ è½½æ—¶è¿è¡Œè¯Šæ–­
        document.addEventListener('DOMContentLoaded', function() {
            runDiagnostics();
        });
    </script>
</body>
</html>