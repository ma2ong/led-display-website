<script>
    // 创建默认表和数据
    async function createDefaultTables() {
        try {
            // 创建用户表
            const { data: userData, error: userError } = await supabase
                .from('users')
                .upsert([
                    {
                        username: 'admin',
                        email: 'admin@lianjinled.com',
                        role: '超级管理员',
                        status: '活跃'
                    }
                ]);
            
            if (userError) throw userError;
            
            console.log('默认用户创建成功');
            
            // 创建产品表示例数据
            const { data: productData, error: productError } = await supabase
                .from('products')
                .upsert([
                    {
                        name: 'P2.5室内LED显示屏',
                        category: '室内显示屏',
                        description: '高清小间距LED显示屏，适用于会议室、控制室等场景',
                        specifications: '像素间距：2.5mm\n亮度：800cd/㎡\n刷新率：3840Hz',
                        price: 2800,
                        status: '上架',
                        image: '/images/products/indoor-p2.5.jpg'
                    },
                    {
                        name: 'P10户外LED显示屏',
                        category: '户外显示屏',
                        description: '高亮度户外全彩LED显示屏，适用于广告牌、体育场馆等场景',
                        specifications: '像素间距：10mm\n亮度：6000cd/㎡\n防护等级：IP65',
                        price: 1200,
                        status: '上架',
                        image: '/images/products/outdoor-p10.jpg'
                    }
                ]);
            
            if (productError) throw productError;
            
            console.log('默认产品创建成功');
            
            // 创建询盘表示例数据
            const { data: inquiryData, error: inquiryError } = await supabase
                .from('inquiries')
                .upsert([
                    {
                        name: '张先生',
                        email: 'zhang@example.com',
                        company: '科技公司',
                        phone: '13812345678',
                        message: '我们公司需要一块室内LED显示屏，尺寸大约3x2米，请提供详细报价和技术参数。',
                        status: '待处理',
                        created_at: new Date().toISOString()
                    },
                    {
                        name: '李女士',
                        email: 'li@example.com',
                        company: '广告公司',
                        phone: '13987654321',
                        message: '需要户外LED显示屏用于广告投放，要求防水防尘，亮度要高。',
                        status: '已处理',
                        created_at: new Date().toISOString()
                    }
                ]);
            
            if (inquiryError) throw inquiryError;
            
            console.log('默认询盘创建成功');
            
            // 创建新闻表示例数据
            const { data: newsData, error: newsError } = await supabase
                .from('news')
                .upsert([
                    {
                        title: 'LED显示屏技术发展趋势',
                        content: 'LED显示技术正朝着更小间距、更高清晰度、更低功耗的方向发展...',
                        category: '技术文章',
                        author: 'admin',
                        status: '已发布',
                        created_at: new Date().toISOString()
                    },
                    {
                        title: '小间距LED显示屏应用案例',
                        content: '近年来，小间距LED显示屏在会议室、控制室等场景的应用越来越广泛...',
                        category: '行业资讯',
                        author: 'admin',
                        status: '草稿',
                        created_at: new Date().toISOString()
                    }
                ]);
            
            if (newsError) throw newsError;
            
            console.log('默认新闻创建成功');
            
            // 创建页面内容表
            for (const [pageName, pageContent] of Object.entries(pageData)) {
                const { data: pageData, error: pageError } = await supabase
                    .from('page_contents')
                    .upsert([
                        {
                            page_name: pageName,
                            title: pageContent.title,
                            subtitle: pageContent.subtitle,
                            description: pageContent.description,
                            content: pageContent.content,
                            image: pageContent.image,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (pageError) throw pageError;
            }
            
            console.log('默认页面内容创建成功');
            
        } catch (error) {
            console.error('创建默认表错误:', error);
            throw error;
        }
    }
    
    // 加载仪表盘数据
    async function loadDashboardData() {
        showLoading();
        try {
            // 加载产品数量
            const { count: productCount, error: productError } = await supabase
                .from('products')
                .select('*', { count: 'exact', head: true });
            
            if (!productError) {
                document.getElementById('productCount').textContent = productCount || 0;
                document.getElementById('totalProducts').textContent = productCount || 0;
            }
            
            // 加载询盘数量
            const { count: inquiryCount, error: inquiryError } = await supabase
                .from('inquiries')
                .select('*', { count: 'exact', head: true });
            
            if (!inquiryError) {
                document.getElementById('inquiryCount').textContent = inquiryCount || 0;
                document.getElementById('totalInquiries').textContent = inquiryCount || 0;
            }
            
            // 加载新闻数量
            const { count: newsCount, error: newsError } = await supabase
                .from('news')
                .select('*', { count: 'exact', head: true });
            
            if (!newsError) {
                document.getElementById('newsCount').textContent = newsCount || 0;
                document.getElementById('totalNews').textContent = newsCount || 0;
            }
            
            // 加载用户数量
            const { count: userCount, error: userError } = await supabase
                .from('users')
                .select('*', { count: 'exact', head: true });
            
            if (!userError) {
                document.getElementById('totalUsers').textContent = userCount || 0;
            }
            
            // 设置页面数量
            document.getElementById('pageCount').textContent = 8;
            
            // 加载最新询盘
            const { data: latestInquiries, error: latestInquiryError } = await supabase
                .from('inquiries')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);
            
            if (!latestInquiryError && latestInquiries) {
                updateLatestInquiries(latestInquiries);
            }
            
            // 加载产品列表
            loadProducts();
            
            // 加载询盘列表
            loadInquiries();
            
            // 加载新闻列表
            loadNews();
            
            // 加载用户列表
            loadUsers();
            
        } catch (error) {
            console.error('加载仪表盘数据错误:', error);
        } finally {
            hideLoading();
        }
    }
</script>