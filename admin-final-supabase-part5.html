<script>
        // 产品管理相关功能
        let productPage = 1;
        const productPageSize = 10;
        let totalProducts = 0;
        
        // 加载产品列表
        async function loadProducts() {
            showLoading();
            
            try {
                // 获取产品总数
                const { count, error: countError } = await supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) throw countError;
                totalProducts = count || 0;
                
                // 获取分页产品数据
                const from = (productPage - 1) * productPageSize;
                const to = from + productPageSize - 1;
                
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .range(from, to);
                
                if (error) throw error;
                
                // 更新产品表格
                const productsTable = document.getElementById('productsTable');
                productsTable.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>¥${product.price}/㎡</td>
                            <td><span class="status-badge ${product.status === '上架' ? 'status-active' : 'status-inactive'}">${product.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})">编辑</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">删除</button>
                            </td>
                        `;
                        productsTable.appendChild(row);
                    });
                } else {
                    productsTable.innerHTML = '<tr><td colspan="5" class="text-center">暂无产品数据</td></tr>';
                }
                
                // 更新分页信息
                document.getElementById('productTotalCount').textContent = totalProducts;
                document.getElementById('productStartRange').textContent = totalProducts === 0 ? 0 : from + 1;
                document.getElementById('productEndRange').textContent = Math.min(to + 1, totalProducts);
                
                // 更新分页按钮状态
                document.getElementById('productPrevBtn').disabled = productPage === 1;
                document.getElementById('productNextBtn').disabled = (productPage * productPageSize) >= totalProducts;
                
            } catch (error) {
                console.error('加载产品数据失败:', error);
                alert('加载产品数据失败，请刷新页面重试');
            } finally {
                hideLoading();
            }
        }
        
        // 上一页产品
        function prevProductPage() {
            if (productPage > 1) {
                productPage--;
                loadProducts();
            }
        }
        
        // 下一页产品
        function nextProductPage() {
            if ((productPage * productPageSize) < totalProducts) {
                productPage++;
                loadProducts();
            }
        }
        
        // 搜索产品
        function searchProducts() {
            const searchTerm = document.getElementById('productSearchInput').value.trim();
            if (searchTerm) {
                searchProductsByTerm(searchTerm);
            } else {
                productPage = 1;
                loadProducts();
            }
        }
        
        // 根据关键词搜索产品
        async function searchProductsByTerm(term) {
            showLoading();
            
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .or(`name.ilike.%${term}%,category.ilike.%${term}%,description.ilike.%${term}%`)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // 更新产品表格
                const productsTable = document.getElementById('productsTable');
                productsTable.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>¥${product.price}/㎡</td>
                            <td><span class="status-badge ${product.status === '上架' ? 'status-active' : 'status-inactive'}">${product.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})">编辑</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">删除</button>
                            </td>
                        `;
                        productsTable.appendChild(row);
                    });
                } else {
                    productsTable.innerHTML = '<tr><td colspan="5" class="text-center">未找到匹配的产品</td></tr>';
                }
                
                // 更新分页信息
                document.getElementById('productTotalCount').textContent = data ? data.length : 0;
                document.getElementById('productStartRange').textContent = data && data.length > 0 ? 1 : 0;
                document.getElementById('productEndRange').textContent = data ? data.length : 0;
                
                // 禁用分页按钮
                document.getElementById('productPrevBtn').disabled = true;
                document.getElementById('productNextBtn').disabled = true;
                
            } catch (error) {
                console.error('搜索产品失败:', error);
                alert('搜索产品失败，请重试');
            } finally {
                hideLoading();
            }
        }
        
        // 显示产品模态框
        function showProductModal() {
            // 重置表单
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            
            // 显示模态框
            const productModal = new bootstrap.Modal(document.getElementById('productModal'));
            productModal.show();
        }
        
        // 编辑产品
        async function editProduct(id) {
            showLoading();
            
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    // 填充表单
                    document.getElementById('productId').value = data.id;
                    document.getElementById('productName').value = data.name;
                    document.getElementById('productCategory').value = data.category;
                    document.getElementById('productDescription').value = data.description;
                    document.getElementById('productSpecifications').value = data.specifications;
                    document.getElementById('productPrice').value = data.price;
                    document.getElementById('productStatus').value = data.status;
                    document.getElementById('productImage').value = data.image;
                    
                    // 显示模态框
                    const productModal = new bootstrap.Modal(document.getElementById('productModal'));
                    productModal.show();
                }
            } catch (error) {
                console.error('获取产品详情失败:', error);
                alert('获取产品详情失败，请重试');
            } finally {
                hideLoading();
            }
        }
        
        // 保存产品
        async function saveProduct() {
            showLoading();
            
            try {
                const productId = document.getElementById('productId').value;
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    description: document.getElementById('productDescription').value,
                    specifications: document.getElementById('productSpecifications').value,
                    price: parseFloat(document.getElementById('productPrice').value) || 0,
                    status: document.getElementById('productStatus').value,
                    image: document.getElementById('productImage').value
                };
                
                let result;
                
                if (productId) {
                    // 更新产品
                    result = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', productId);
                } else {
                    // 添加产品
                    productData.created_at = new Date().toISOString();
                    result = await supabase
                        .from('products')
                        .insert([productData]);
                }
                
                if (result.error) throw result.error;
                
                // 关闭模态框
                const productModal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                productModal.hide();
                
                // 重新加载产品列表
                loadProducts();
                
                // 更新仪表盘数据
                if (!productId) {
                    const productCount = document.getElementById('productCount');
                    productCount.textContent = (parseInt(productCount.textContent) + 1).toString();
                }
                
            } catch (error) {
                console.error('保存产品失败:', error);
                alert('保存产品失败，请重试');
            } finally {
                hideLoading();
            }
        }
        
        // 删除产品
        async function deleteProduct(id) {
            if (confirm('确定要删除这个产品吗？此操作不可恢复。')) {
                showLoading();
                
                try {
                    const { error } = await supabase
                        .from('products')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    // 重新加载产品列表
                    loadProducts();
                    
                    // 更新仪表盘数据
                    const productCount = document.getElementById('productCount');
                    productCount.textContent = (parseInt(productCount.textContent) - 1).toString();
                    
                } catch (error) {
                    console.error('删除产品失败:', error);
                    alert('删除产品失败，请重试');
                } finally {
                    hideLoading();
                }
            }
        }
    </script>