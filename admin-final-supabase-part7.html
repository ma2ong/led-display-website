<script>
        // 新闻管理相关功能
        let newsPage = 1;
        const newsPageSize = 10;
        let totalNews = 0;
        let currentNewsFilter = 'all';
        
        // 加载新闻列表
        async function loadNews() {
            showLoading();
            
            try {
                let query = supabase.from('news');
                
                // 应用过滤器
                if (currentNewsFilter !== 'all') {
                    query = query.eq('status', currentNewsFilter === 'published' ? '已发布' : '草稿');
                }
                
                // 获取新闻总数
                const { count, error: countError } = await query.select('*', { count: 'exact', head: true });
                
                if (countError) throw countError;
                totalNews = count || 0;
                
                // 获取分页新闻数据
                const from = (newsPage - 1) * newsPageSize;
                const to = from + newsPageSize - 1;
                
                const { data, error } = await query
                    .select('*')
                    .order('created_at', { ascending: false })
                    .range(from, to);
                
                if (error) throw error;
                
                // 更新新闻表格
                const newsTable = document.getElementById('newsTable');
                newsTable.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(news => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${news.title}</td>
                            <td>${news.category}</td>
                            <td>${news.author}</td>
                            <td><span class="status-badge ${news.status === '已发布' ? 'status-published' : 'status-draft'}">${news.status}</span></td>
                            <td>${new Date(news.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editNews(${news.id})">编辑</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteNews(${news.id})">删除</button>
                            </td>
                        `;
                        newsTable.appendChild(row);
                    });
                } else {
                    newsTable.innerHTML = '<tr><td colspan="6" class="text-center">暂无新闻数据</td></tr>';
                }
                
                // 更新分页信息
                document.getElementById('newsTotalCount').textContent = totalNews;
                document.getElementById('newsStartRange').textContent = totalNews === 0 ? 0 : from + 1;
                document.getElementById('newsEndRange').textContent = Math.min(to + 1, totalNews);
                
                // 更新分页按钮状态
                document.getElementById('newsPrevBtn').disabled = newsPage === 1;
                document.getElementById('newsNextBtn').disabled = (newsPage * newsPageSize) >= totalNews;
                
            } catch (error) {
                console.error('加载新闻数据失败:', error);
                alert('加载新闻数据失败，请刷新页面重试');
            } finally {
                hideLoading();
            }
        }
        
        // 上一页新闻
        function prevNewsPage() {
            if (newsPage > 1) {
                newsPage--;
                loadNews();
            }
        }
        
        // 下一页新闻
        function nextNewsPage() {
            if ((newsPage * newsPageSize) < totalNews) {
                newsPage++;
                loadNews();
            }
        }
        
        // 搜索新闻
        function searchNews() {
            const searchTerm = document.getElementById('newsSearchInput').value.trim();
            if (searchTerm) {
                searchNewsByTerm(searchTerm);
            } else {
                newsPage = 1;
                loadNews();
            }
        }
        
        // 根据关键词搜索新闻
        async function searchNewsByTerm(term) {
            showLoading();
            
            try {
                let query = supabase.from('news').select('*');
                
                // 应用过滤器
                if (currentNewsFilter !== 'all') {
                    query = query.eq('status', currentNewsFilter === 'published' ? '已发布' : '草稿');
                }
                
                // 应用搜索条件
                const { data, error } = await query
                    .or(`title.ilike.%${term}%,category.ilike.%${term}%,content.ilike.%${term}%,author.ilike.%${term}%`)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // 更新新闻表格
                const newsTable = document.getElementById('newsTable');
                newsTable.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(news => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${news.title}</td>
                            <td>${news.category}</td>
                            <td>${news.author}</td>
                            <td><span class="status-badge ${news.status === '已发布' ? 'status-published' : 'status-draft'}">${news.status}</span></td>
                            <td>${new Date(news.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editNews(${news.id})">编辑</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteNews(${news.id})">删除</button>
                            </td>
                        `;
                        newsTable.appendChild(row);
                    });
                } else {
                    newsTable.innerHTML = '<tr><td colspan="6" class="text-center">未找到匹配的新闻</td></tr>';
                }
                
                // 更新分页信息
                document.getElementById('newsTotalCount').textContent = data ? data.length : 0;
                document.getElementById('newsStartRange').textContent = data && data.length > 0 ? 1 : 0;
                document.getElementById('newsEndRange').textContent = data ? data.length : 0;
                
                // 禁用分页按钮
                document.getElementById('newsPrevBtn').disabled = true;
                document.getElementById('newsNextBtn').disabled = true;
                
            } catch (error) {
                console.error('搜索新闻失败:', error);
                alert('搜索新闻失败，请重试');
            } finally {
                hideLoading();
            }
        }
        
        // 过滤新闻
        function filterNews(filter) {
            currentNewsFilter = filter;
            newsPage = 1;
            
            // 更新按钮状态
            document.querySelectorAll('.btn-group[role="group"] .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.btn-group[role="group"] .btn[onclick="filterNews('${filter}')"]`).classList.add('active');
            
            // 重新加载新闻
            loadNews();
        }
        
        // 显示新闻模态框
        function showNewsModal() {
            // 重置表单
            document.getElementById('newsForm').reset();
            document.getElementById('newsId').value = '';
            
            // 显示模态框
            const newsModal = new bootstrap.Modal(document.getElementById('newsModal'));
            newsModal.show();
        }
        
        // 编辑新闻
        async function editNews(id) {
            showLoading();
            
            try {
                const { data, error } = await supabase
                    .from('news')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    // 填充表单
                    document.getElementById('newsId').value = data.id;
                    document.getElementById('newsTitle').value = data.title;
                    document.getElementById('newsCategory').value = data.category;
                    document.getElementById('newsContent').value = data.content;
                    document.getElementById('newsAuthor').value = data.author;
                    document.getElementById('newsStatus').value = data.status;
                    
                    // 显示模态框
                    const newsModal = new bootstrap.Modal(document.getElementById('newsModal'));
                    newsModal.show();
                }
            } catch (error) {
                console.error('获取新闻详情失败:', error);
                alert('获取新闻详情失败，请重试');
            } finally {
                hideLoading();
            }
        }
        
        // 保存新闻
        async function saveNews() {
            showLoading();
            
            try {
                const newsId = document.getElementById('newsId').value;
                const newsData = {
                    title: document.getElementById('newsTitle').value,
                    category: document.getElementById('newsCategory').value,
                    content: document.getElementById('newsContent').value,
                    author: document.getElementById('newsAuthor').value,
                    status: document.getElementById('newsStatus').value
                };
                
                let result;
                
                if (newsId) {
                    // 更新新闻
                    result = await supabase
                        .from('news')
                        .update(newsData)
                        .eq('id', newsId);
                } else {
                    // 添加新闻
                    newsData.created_at = new Date().toISOString();
                    result = await supabase
                        .from('news')
                        .insert([newsData]);
                }
                
                if (result.error) throw result.error;
                
                // 关闭模态框
                const newsModal = bootstrap.Modal.getInstance(document.getElementById('newsModal'));
                newsModal.hide();
                
                // 重新加载新闻列表
                loadNews();
                
                // 更新仪表盘数据
                if (!newsId) {
                    const newsCount = document.getElementById('newsCount');
                    newsCount.textContent = (parseInt(newsCount.textContent) + 1).toString();
                }
                
            } catch (error) {
                console.error('保存新闻失败:', error);
                alert('保存新闻失败，请重试');
            } finally {
                hideLoading();
            }
        }
        
        // 删除新闻
        async function deleteNews(id) {
            if (confirm('确定要删除这条新闻吗？此操作不可恢复。')) {
                showLoading();
                
                try {
                    const { error } = await supabase
                        .from('news')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    // 重新加载新闻列表
                    loadNews();
                    
                    // 更新仪表盘数据
                    const newsCount = document.getElementById('newsCount');
                    newsCount.textContent = (parseInt(newsCount.textContent) - 1).toString();
                    
                } catch (error) {
                    console.error('删除新闻失败:', error);
                    alert('删除新闻失败，请重试');
                } finally {
                    hideLoading();
                }
            }
        }
    </script>
</body>
</html>