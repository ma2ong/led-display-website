<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEDç½‘ç«™ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-info { background-color: #17a2b8; }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container-fluid my-4">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0">ğŸ” LEDç½‘ç«™ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
                        <small>å®æ—¶ç›‘æ§ç³»ç»Ÿå„ç»„ä»¶è¿è¡ŒçŠ¶æ€</small>
                    </div>
                    <div class="card-body">
                        <button id="check-all-btn" class="btn btn-primary btn-lg me-3">ğŸš€ å…¨é¢æ£€æŸ¥</button>
                        <button id="auto-refresh-btn" class="btn btn-outline-secondary">ğŸ”„ è‡ªåŠ¨åˆ·æ–°</button>
                        <span id="last-check" class="text-muted ms-3"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- æ ¸å¿ƒæœåŠ¡çŠ¶æ€ -->
            <div class="col-lg-6 mb-4">
                <div class="card status-card">
                    <div class="card-header">
                        <h4 class="mb-0">ğŸ–¥ï¸ æ ¸å¿ƒæœåŠ¡çŠ¶æ€</h4>
                    </div>
                    <div class="card-body">
                        <div id="core-services-status">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><span class="status-indicator status-info"></span>HTTPæœåŠ¡å™¨ (8000)</span>
                                <span id="http-status" class="badge bg-secondary">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><span class="status-indicator status-info"></span>Flaskç®¡ç†ç³»ç»Ÿ (5003)</span>
                                <span id="flask-status" class="badge bg-secondary">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><span class="status-indicator status-info"></span>Supabaseæ•°æ®åº“</span>
                                <span id="supabase-status" class="badge bg-secondary">æ£€æŸ¥ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®ç»Ÿè®¡ -->
            <div class="col-lg-6 mb-4">
                <div class="card status-card">
                    <div class="card-header">
                        <h4 class="mb-0">ğŸ“Š æ•°æ®ç»Ÿè®¡</h4>
                    </div>
                    <div class="card-body">
                        <div id="data-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <h3 id="products-count" class="text-primary">-</h3>
                                    <small class="text-muted">äº§å“æ•°é‡</small>
                                </div>
                                <div class="col-4">
                                    <h3 id="pages-count" class="text-success">8</h3>
                                    <small class="text-muted">é¡µé¢æ•°é‡</small>
                                </div>
                                <div class="col-4">
                                    <h3 id="api-count" class="text-info">-</h3>
                                    <small class="text-muted">APIæ¥å£</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- APIæ¥å£æµ‹è¯• -->
            <div class="col-lg-8 mb-4">
                <div class="card status-card">
                    <div class="card-header">
                        <h4 class="mb-0">ğŸ”Œ APIæ¥å£æµ‹è¯•</h4>
                    </div>
                    <div class="card-body">
                        <div id="api-tests">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Flaskç®¡ç†ç³»ç»ŸAPI</h6>
                                    <div class="mb-2">
                                        <span class="status-indicator status-info"></span>
                                        <span>/api/products</span>
                                        <span id="api-products" class="badge bg-secondary ms-2">å¾…æµ‹è¯•</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="status-indicator status-info"></span>
                                        <span>/api/status</span>
                                        <span id="api-status" class="badge bg-secondary ms-2">å¾…æµ‹è¯•</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="status-indicator status-info"></span>
                                        <span>/api/news</span>
                                        <span id="api-news" class="badge bg-secondary ms-2">å¾…æµ‹è¯•</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Supabaseæ•°æ®åº“</h6>
                                    <div class="mb-2">
                                        <span class="status-indicator status-info"></span>
                                        <span>productsè¡¨</span>
                                        <span id="db-products" class="badge bg-secondary ms-2">å¾…æµ‹è¯•</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="status-indicator status-info"></span>
                                        <span>è¿æ¥çŠ¶æ€</span>
                                        <span id="db-connection" class="badge bg-secondary ms-2">å¾…æµ‹è¯•</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿå»ºè®® -->
            <div class="col-lg-4 mb-4">
                <div class="card status-card">
                    <div class="card-header">
                        <h4 class="mb-0">ğŸ’¡ ç³»ç»Ÿå»ºè®®</h4>
                    </div>
                    <div class="card-body">
                        <div id="system-recommendations">
                            <p class="text-muted">ç‚¹å‡»"å…¨é¢æ£€æŸ¥"è·å–ç³»ç»Ÿå»ºè®®</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">ğŸ“ æ£€æŸ¥æ—¥å¿—</h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="log-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const { createClient } = supabase;
        const supabaseUrl = 'https://jirudzbqcxviytcmxegf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y214ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4';
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

        // æ—¥å¿—ç³»ç»Ÿ
        const logContainer = document.getElementById('log-container');
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`;
            logEntry.innerHTML = `<span class="text-muted">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`Element with ID '${elementId}' not found`);
                return;
            }
            
            element.className = `badge bg-${status === 'success' ? 'success' : status === 'error' ? 'danger' : status === 'warning' ? 'warning' : 'secondary'}`;
            element.textContent = message || (status === 'success' ? 'æ­£å¸¸' : status === 'error' ? 'å¼‚å¸¸' : status === 'warning' ? 'è­¦å‘Š' : 'æœªçŸ¥');
        }

        // æ£€æŸ¥HTTPæœåŠ¡å™¨
        async function checkHttpServer() {
            try {
                const response = await fetch('/test-products-simple.html', { method: 'HEAD' });
                if (response.ok) {
                    updateStatus('http-status', 'success');
                    log('âœ… HTTPæœåŠ¡å™¨è¿è¡Œæ­£å¸¸ (ç«¯å£8000)', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('http-status', 'error');
                log(`âŒ HTTPæœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ£€æŸ¥Flaskç®¡ç†ç³»ç»Ÿ
        async function checkFlaskSystem() {
            try {
                const response = await fetch('http://localhost:5003/api/status');
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('flask-status', 'success');
                    log('âœ… Flaskç®¡ç†ç³»ç»Ÿè¿è¡Œæ­£å¸¸ (ç«¯å£5003)', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('flask-status', 'error');
                log(`âŒ Flaskç®¡ç†ç³»ç»Ÿè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ£€æŸ¥Supabaseæ•°æ®åº“
        async function checkSupabase() {
            try {
                const { data, error, count } = await supabaseClient
                    .from('products')
                    .select('*', { count: 'exact', head: true });
                
                if (error) throw error;
                
                updateStatus('supabase-status', 'success');
                updateStatus('db-connection', 'success');
                updateStatus('db-products', 'success', `${count}æ¡è®°å½•`);
                document.getElementById('products-count').textContent = count || 0;
                
                log(`âœ… Supabaseæ•°æ®åº“è¿æ¥æ­£å¸¸ï¼Œäº§å“è¡¨æœ‰ ${count || 0} æ¡è®°å½•`, 'success');
                return { success: true, count: count || 0 };
            } catch (error) {
                updateStatus('supabase-status', 'error');
                updateStatus('db-connection', 'error');
                updateStatus('db-products', 'error');
                log(`âŒ Supabaseæ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return { success: false, count: 0 };
            }
        }

        // æµ‹è¯•Flask APIæ¥å£
        async function testFlaskAPIs() {
            const apis = [
                { name: 'products', url: '/api/products', elementId: 'api-products' },
                { name: 'status', url: '/api/status', elementId: 'api-status' },
                { name: 'news', url: '/api/news', elementId: 'api-news' }
            ];

            let successCount = 0;
            
            for (const api of apis) {
                try {
                    const response = await fetch(`http://localhost:5003${api.url}`);
                    if (response.ok) {
                        const data = await response.json();
                        updateStatus(api.elementId, 'success');
                        log(`âœ… API ${api.name} å“åº”æ­£å¸¸`, 'success');
                        successCount++;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    updateStatus(api.elementId, 'error');
                    log(`âŒ API ${api.name} æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
                
                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            document.getElementById('api-count').textContent = successCount;
            return successCount;
        }

        // ç”Ÿæˆç³»ç»Ÿå»ºè®®
        function generateRecommendations(results) {
            const recommendations = [];
            
            if (!results.http) {
                recommendations.push('ğŸ”´ å¯åŠ¨HTTPæœåŠ¡å™¨: python -m http.server 8000');
            }
            
            if (!results.flask) {
                recommendations.push('ğŸ”´ å¯åŠ¨Flaskç®¡ç†ç³»ç»Ÿ: cd admin && python complete_chinese_admin_system.py');
            }
            
            if (!results.supabase.success) {
                recommendations.push('ğŸ”´ æ£€æŸ¥Supabaseé…ç½®å’Œç½‘ç»œè¿æ¥');
            }
            
            if (results.supabase.count === 0) {
                recommendations.push('ğŸŸ¡ æ•°æ®åº“ä¸­æš‚æ— äº§å“æ•°æ®ï¼Œå»ºè®®æ·»åŠ ç¤ºä¾‹äº§å“');
            }
            
            if (results.apiCount < 3) {
                recommendations.push('ğŸŸ¡ éƒ¨åˆ†APIæ¥å£å¼‚å¸¸ï¼Œæ£€æŸ¥Flaskç³»ç»Ÿæ—¥å¿—');
            }
            
            if (recommendations.length === 0) {
                recommendations.push('ğŸŸ¢ ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæ‰€æœ‰ç»„ä»¶çŠ¶æ€è‰¯å¥½ï¼');
                recommendations.push('ğŸ’¡ å»ºè®®å®šæœŸæ£€æŸ¥ç³»ç»ŸçŠ¶æ€');
                recommendations.push('ğŸ“Š å¯ä»¥å¼€å§‹æ­£å¸¸ä½¿ç”¨LEDç½‘ç«™ç®¡ç†ç³»ç»Ÿ');
            }
            
            const container = document.getElementById('system-recommendations');
            container.innerHTML = recommendations.map(rec => `<div class="mb-2">${rec}</div>`).join('');
        }

        // å…¨é¢æ£€æŸ¥
        async function performFullCheck() {
            log('ğŸš€ å¼€å§‹å…¨é¢ç³»ç»Ÿæ£€æŸ¥...', 'info');
            document.getElementById('last-check').textContent = `æœ€åæ£€æŸ¥: ${new Date().toLocaleString()}`;
            
            const results = {
                http: false,
                flask: false,
                supabase: { success: false, count: 0 },
                apiCount: 0
            };
            
            // å¹¶è¡Œæ£€æŸ¥æ ¸å¿ƒæœåŠ¡
            log('æ£€æŸ¥æ ¸å¿ƒæœåŠ¡çŠ¶æ€...', 'info');
            const [httpResult, flaskResult, supabaseResult] = await Promise.all([
                checkHttpServer(),
                checkFlaskSystem(),
                checkSupabase()
            ]);
            
            results.http = httpResult;
            results.flask = flaskResult;
            results.supabase = supabaseResult;
            
            // å¦‚æœFlaskæ­£å¸¸ï¼Œæµ‹è¯•APIæ¥å£
            if (flaskResult) {
                log('æµ‹è¯•APIæ¥å£...', 'info');
                results.apiCount = await testFlaskAPIs();
            }
            
            // ç”Ÿæˆå»ºè®®
            generateRecommendations(results);
            
            log('âœ… å…¨é¢æ£€æŸ¥å®Œæˆ', 'success');
        }

        // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        let autoRefreshInterval = null;
        document.getElementById('auto-refresh-btn').addEventListener('click', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                this.textContent = 'ğŸ”„ è‡ªåŠ¨åˆ·æ–°';
                this.className = 'btn btn-outline-secondary';
                log('â¹ï¸ è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢', 'info');
            } else {
                autoRefreshInterval = setInterval(performFullCheck, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
                this.textContent = 'â¸ï¸ åœæ­¢åˆ·æ–°';
                this.className = 'btn btn-outline-warning';
                log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ (30ç§’é—´éš”)', 'info');
            }
        });

        // äº‹ä»¶ç›‘å¬
        document.getElementById('check-all-btn').addEventListener('click', performFullCheck);

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ” LEDç½‘ç«™ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å·¥å…·å·²åŠ è½½', 'info');
            log('ç‚¹å‡»"å…¨é¢æ£€æŸ¥"å¼€å§‹ç³»ç»Ÿè¯Šæ–­', 'info');
            
            // è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            setTimeout(performFullCheck, 1000);
        });
    </script>
</body>
</html>