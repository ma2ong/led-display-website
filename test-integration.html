<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰åç«¯é›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .status-success { border-left: 4px solid #28a745; }
        .status-error { border-left: 4px solid #dc3545; }
        .status-warning { border-left: 4px solid #ffc107; }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .loading { color: #6c757d; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— LEDç½‘ç«™å‰åç«¯é›†æˆæµ‹è¯•</h1>
        
        <div class="status-card" id="connectionStatus">
            <h3>ğŸ“¡ è¿æ¥çŠ¶æ€æ£€æµ‹</h3>
            <div id="statusResults">æ£€æµ‹ä¸­...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ—„ï¸ æœ¬åœ°APIæµ‹è¯•</h3>
            <button onclick="testLocalAPI()">æµ‹è¯•æœ¬åœ°API</button>
            <button onclick="testLocalProducts()">è·å–æœ¬åœ°äº§å“</button>
            <button onclick="testLocalNews()">è·å–æœ¬åœ°æ–°é—»</button>
            <div id="localResults" class="data-display"></div>
        </div>

        <div class="test-section">
            <h3>â˜ï¸ Supabaseäº‘æ•°æ®åº“æµ‹è¯•</h3>
            <button onclick="testSupabase()">æµ‹è¯•Supabaseè¿æ¥</button>
            <button onclick="testSupabaseProducts()">è·å–äº‘ç«¯äº§å“</button>
            <button onclick="testSupabaseNews()">è·å–äº‘ç«¯æ–°é—»</button>
            <div id="supabaseResults" class="data-display"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ è¡¨å•æäº¤æµ‹è¯•</h3>
            <form id="testForm">
                <input type="text" placeholder="å§“å" id="testName" required style="margin: 5px; padding: 8px;">
                <input type="email" placeholder="é‚®ç®±" id="testEmail" required style="margin: 5px; padding: 8px;">
                <input type="text" placeholder="ç”µè¯" id="testPhone" style="margin: 5px; padding: 8px;">
                <textarea placeholder="ç•™è¨€å†…å®¹" id="testMessage" style="margin: 5px; padding: 8px; width: 200px;"></textarea>
                <br>
                <button type="button" onclick="submitToLocal()">æäº¤åˆ°æœ¬åœ°</button>
                <button type="button" onclick="submitToSupabase()">æäº¤åˆ°Supabase</button>
            </form>
            <div id="formResults" class="data-display"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h3>
            <div id="systemInfo" class="data-display"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // å…¨å±€å˜é‡å£°æ˜
        let supabaseClient = null;
        let localAPI = null;

        // åˆå§‹åŒ–é…ç½®
        function initializeClients() {
            // Supabaseé…ç½®
            const supabaseUrl = 'https://jirudzbqcxviytcmxegf.supabase.co'
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y214ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4'
            
            try {
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey)
                console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ')
            } catch (error) {
                console.error('âŒ Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error)
            }

            // æœ¬åœ°APIåœ°å€ - ä½¿ç”¨5002ç«¯å£
            localAPI = 'http://127.0.0.1:5002'
            console.log('âœ… æœ¬åœ°APIé…ç½®å®Œæˆ:', localAPI)
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å¹¶æ£€æµ‹è¿æ¥çŠ¶æ€
        window.addEventListener('DOMContentLoaded', async function() {
            // ç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(async () => {
                try {
                    initializeClients()
                    await checkConnectionStatus()
                    showSystemInfo()
                } catch (error) {
                    console.error('åˆå§‹åŒ–é”™è¯¯:', error)
                }
            }, 100)
        })

        // å¤‡ç”¨åˆå§‹åŒ–
        window.onload = async function() {
            if (!document.getElementById('statusResults').innerHTML.includes('æ£€æµ‹ä¸­')) {
                return // å·²ç»åˆå§‹åŒ–è¿‡äº†
            }
            try {
                initializeClients()
                await checkConnectionStatus()
                showSystemInfo()
            } catch (error) {
                console.error('å¤‡ç”¨åˆå§‹åŒ–é”™è¯¯:', error)
            }
        }

        async function checkConnectionStatus() {
            const statusDiv = document.getElementById('statusResults')
            statusDiv.innerHTML = '<div class="loading">ğŸ”„ æ£€æµ‹è¿æ¥çŠ¶æ€...</div>'
            
            let html = ''
            
            // æ£€æµ‹æœ¬åœ°API
            try {
                const response = await fetch(`${localAPI}/api/health`)
                if (response.ok) {
                    const data = await response.json()
                    html += '<div class="success">âœ… æœ¬åœ°API: è¿æ¥æ­£å¸¸ (ç«¯å£5002)</div>'
                } else {
                    html += '<div class="error">âŒ æœ¬åœ°API: è¿æ¥å¤±è´¥</div>'
                }
            } catch (error) {
                html += '<div class="error">âŒ æœ¬åœ°API: æ— æ³•è¿æ¥ (è¯·ç¡®ä¿æœåŠ¡å™¨è¿è¡Œåœ¨5002ç«¯å£)</div>'
            }

            // æ£€æµ‹Supabase
            try {
                if (supabaseClient) {
                    const { data, error } = await supabaseClient.from('products').select('count').limit(1)
                    if (!error) {
                        html += '<div class="success">âœ… Supabase: è¿æ¥æ­£å¸¸</div>'
                    } else {
                        html += '<div class="error">âŒ Supabase: ' + error.message + '</div>'
                    }
                } else {
                    html += '<div class="error">âŒ Supabase: å®¢æˆ·ç«¯æœªåˆå§‹åŒ–</div>'
                }
            } catch (error) {
                html += '<div class="error">âŒ Supabase: è¿æ¥å¤±è´¥ - ' + error.message + '</div>'
            }

            statusDiv.innerHTML = html
        }

        async function testLocalAPI() {
            const resultsDiv = document.getElementById('localResults')
            resultsDiv.innerHTML = '<div class="loading">ğŸ”„ æµ‹è¯•æœ¬åœ°API...</div>'
            
            try {
                const response = await fetch(`${localAPI}/api/health`)
                const data = await response.json()
                resultsDiv.innerHTML = `<div class="success">âœ… æœ¬åœ°APIå“åº”:</div><pre>${JSON.stringify(data, null, 2)}</pre>`
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`
            }
        }

        async function testLocalProducts() {
            const resultsDiv = document.getElementById('localResults')
            resultsDiv.innerHTML = '<div class="loading">ğŸ”„ è·å–æœ¬åœ°äº§å“æ•°æ®...</div>'
            
            try {
                const response = await fetch(`${localAPI}/api/products`)
                const data = await response.json()
                resultsDiv.innerHTML = `<div class="success">âœ… æœ¬åœ°äº§å“æ•°æ® (${data.length}æ¡):</div><pre>${JSON.stringify(data, null, 2)}</pre>`
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`
            }
        }

        async function testLocalNews() {
            const resultsDiv = document.getElementById('localResults')
            resultsDiv.innerHTML = '<div class="loading">ğŸ”„ è·å–æœ¬åœ°æ–°é—»æ•°æ®...</div>'
            
            try {
                const response = await fetch(`${localAPI}/api/news`)
                const data = await response.json()
                resultsDiv.innerHTML = `<div class="success">âœ… æœ¬åœ°æ–°é—»æ•°æ® (${data.length}æ¡):</div><pre>${JSON.stringify(data, null, 2)}</pre>`
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`
            }
        }

        async function testSupabase() {
            const resultsDiv = document.getElementById('supabaseResults')
            resultsDiv.innerHTML = '<div class="loading">ğŸ”„ æµ‹è¯•Supabaseè¿æ¥...</div>'
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–')
                }
                const { data, error } = await supabaseClient.from('products').select('count').limit(1)
                if (error) throw error
                resultsDiv.innerHTML = `<div class="success">âœ… Supabaseè¿æ¥æˆåŠŸ</div><pre>è¿æ¥çŠ¶æ€: æ­£å¸¸</pre>`
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ Supabaseé”™è¯¯: ${error.message}</div>`
            }
        }

        async function testSupabaseProducts() {
            const resultsDiv = document.getElementById('supabaseResults')
            resultsDiv.innerHTML = '<div class="loading">ğŸ”„ è·å–Supabaseäº§å“æ•°æ®...</div>'
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–')
                }
                const { data, error } = await supabaseClient.from('products').select('*').order('created_at', { ascending: false })
                if (error) throw error
                resultsDiv.innerHTML = `<div class="success">âœ… Supabaseäº§å“æ•°æ® (${data.length}æ¡):</div><pre>${JSON.stringify(data, null, 2)}</pre>`
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`
            }
        }

        async function testSupabaseNews() {
            const resultsDiv = document.getElementById('supabaseResults')
            resultsDiv.innerHTML = '<div class="loading">ğŸ”„ è·å–Supabaseæ–°é—»æ•°æ®...</div>'
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–')
                }
                const { data, error } = await supabaseClient.from('news').select('*').eq('status', 'published').order('created_at', { ascending: false })
                if (error) throw error
                resultsDiv.innerHTML = `<div class="success">âœ… Supabaseæ–°é—»æ•°æ® (${data.length}æ¡):</div><pre>${JSON.stringify(data, null, 2)}</pre>`
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`
            }
        }

        async function submitToLocal() {
            const resultsDiv = document.getElementById('formResults')
            const formData = {
                name: document.getElementById('testName').value,
                email: document.getElementById('testEmail').value,
                phone: document.getElementById('testPhone').value,
                message: document.getElementById('testMessage').value
            }

            if (!formData.name || !formData.email) {
                resultsDiv.innerHTML = '<div class="error">âŒ è¯·å¡«å†™å§“åå’Œé‚®ç®±</div>'
                return
            }

            resultsDiv.innerHTML = '<div class="loading">ğŸ”„ æäº¤åˆ°æœ¬åœ°API...</div>'
            
            try {
                const response = await fetch(`${localAPI}/api/contact`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                const data = await response.json()
                resultsDiv.innerHTML = `<div class="success">âœ… æœ¬åœ°æäº¤æˆåŠŸ:</div><pre>${JSON.stringify(data, null, 2)}</pre>`
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ æœ¬åœ°æäº¤å¤±è´¥: ${error.message}</div>`
            }
        }

        async function submitToSupabase() {
            const resultsDiv = document.getElementById('formResults')
            const formData = {
                name: document.getElementById('testName').value,
                email: document.getElementById('testEmail').value,
                phone: document.getElementById('testPhone').value,
                message: document.getElementById('testMessage').value,
                status: 'pending'
            }

            if (!formData.name || !formData.email) {
                resultsDiv.innerHTML = '<div class="error">âŒ è¯·å¡«å†™å§“åå’Œé‚®ç®±</div>'
                return
            }

            resultsDiv.innerHTML = '<div class="loading">ğŸ”„ æäº¤åˆ°Supabase...</div>'
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–')
                }
                const { data, error } = await supabaseClient.from('inquiries').insert([formData]).select()
                if (error) throw error
                resultsDiv.innerHTML = `<div class="success">âœ… Supabaseæäº¤æˆåŠŸ:</div><pre>${JSON.stringify(data, null, 2)}</pre>`
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ Supabaseæäº¤å¤±è´¥: ${error.message}</div>`
            }
        }

        function showSystemInfo() {
            const infoDiv = document.getElementById('systemInfo')
            const info = {
                'æœ¬åœ°æœåŠ¡å™¨': 'http://127.0.0.1:5002',
                'ç®¡ç†åå°': 'http://127.0.0.1:5002/admin',
                'Supabaseé¡¹ç›®': 'https://jirudzbqcxviytcmxegf.supabase.co',
                'Supabaseæ§åˆ¶å°': 'https://supabase.com/dashboard/project/jirudzbqcxviytcmxegf',
                'å½“å‰æ—¶é—´': new Date().toLocaleString('zh-CN'),
                'æµè§ˆå™¨': navigator.userAgent.split(' ')[0],
                'æµ‹è¯•é¡µé¢': window.location.href
            }
            
            let html = '<h4>ğŸ”§ ç³»ç»Ÿé…ç½®ä¿¡æ¯:</h4>'
            for (const [key, value] of Object.entries(info)) {
                html += `<div><strong>${key}:</strong> ${value}</div>`
            }
            
            infoDiv.innerHTML = html
        }
    </script>
</body>
</html>