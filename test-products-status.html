<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品数据状态检查</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
        }
        .product-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">产品数据状态检查</h3>
                    </div>
                    <div class="card-body">
                        <button id="check-status-btn" class="btn btn-primary me-3">检查数据库状态</button>
                        <button id="load-products-btn" class="btn btn-success me-3">加载产品数据</button>
                        <button id="add-sample-btn" class="btn btn-warning">添加示例产品</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">数据库状态</h4>
                    </div>
                    <div class="card-body">
                        <div id="status-result">点击"检查数据库状态"开始检查</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">产品数据</h4>
                    </div>
                    <div class="card-body">
                        <div id="products-result">点击"加载产品数据"查看产品</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">操作日志</h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="log-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 直接在页面中定义Supabase客户端
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://your-project.supabase.co', // 这里需要替换为实际的Supabase URL
            'your-anon-key' // 这里需要替换为实际的anon key
        );

        // 简化的产品表修复类
        class ProductTableFix {
            static async checkTablePermissions() {
                try {
                    // 测试读取权限
                    const { data: readTest, error: readError } = await supabaseClient
                        .from('products')
                        .select('count')
                        .limit(1);
                    
                    // 测试写入权限
                    let writeTest = false;
                    try {
                        const { error: writeError } = await supabaseClient
                            .from('products')
                            .insert({ name: 'test', category: 'test' });
                        writeTest = !writeError;
                    } catch (e) {
                        writeTest = false;
                    }
                    
                    return {
                        read: !readError,
                        write: writeTest
                    };
                } catch (error) {
                    return { read: false, write: false };
                }
            }
            
            static async insertProduct(product) {
                try {
                    const { data, error } = await supabaseClient
                        .from('products')
                        .insert(product);
                    
                    if (error) {
                        return { success: false, error: error.message };
                    }
                    
                    return { success: true, data };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }

        // 日志系统
        const logContainer = document.getElementById('log-container');
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 检查数据库状态
        document.getElementById('check-status-btn').addEventListener('click', async () => {
            log('开始检查数据库状态...');
            document.getElementById('status-result').innerHTML = '<div class="spinner-border" role="status"></div>';
            
            try {
                // 检查连接
                const { data: connectionTest, error: connectionError } = await supabase
                    .from('products')
                    .select('count')
                    .limit(1);
                
                if (connectionError) {
                    throw new Error(`连接失败: ${connectionError.message}`);
                }
                
                log('数据库连接成功', 'success');
                
                // 获取产品数量
                const { count, error: countError } = await supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    throw new Error(`获取产品数量失败: ${countError.message}`);
                }
                
                log(`数据库中共有 ${count} 个产品`, 'success');
                
                // 检查权限
                const permissionTest = await ProductTableFix.checkTablePermissions();
                
                document.getElementById('status-result').innerHTML = `
                    <div class="alert alert-success">
                        <h5>数据库状态正常</h5>
                        <ul class="mb-0">
                            <li>连接状态: ✅ 正常</li>
                            <li>产品数量: ${count} 个</li>
                            <li>读取权限: ${permissionTest.read ? '✅' : '❌'}</li>
                            <li>写入权限: ${permissionTest.write ? '✅' : '❌'}</li>
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                log(`检查失败: ${error.message}`, 'error');
                document.getElementById('status-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>数据库状态异常</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // 加载产品数据
        document.getElementById('load-products-btn').addEventListener('click', async () => {
            log('开始加载产品数据...');
            document.getElementById('products-result').innerHTML = '<div class="spinner-border" role="status"></div>';
            
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw new Error(`加载产品失败: ${error.message}`);
                }
                
                log(`成功加载 ${products.length} 个产品`, 'success');
                
                if (products.length === 0) {
                    document.getElementById('products-result').innerHTML = `
                        <div class="alert alert-warning">
                            <h5>暂无产品数据</h5>
                            <p>数据库中没有产品数据，请添加示例产品。</p>
                        </div>
                    `;
                } else {
                    let productsHtml = `<div class="alert alert-info">找到 ${products.length} 个产品</div>`;
                    
                    products.forEach(product => {
                        productsHtml += `
                            <div class="product-card">
                                <h6>${product.name}</h6>
                                <p class="text-muted mb-1">分类: ${product.category}</p>
                                <p class="text-muted mb-1">描述: ${product.description || '无'}</p>
                                <p class="text-muted mb-1">价格: ${product.price ? '¥' + product.price : '未设置'}</p>
                                <small class="text-muted">创建时间: ${new Date(product.created_at).toLocaleString()}</small>
                            </div>
                        `;
                    });
                    
                    document.getElementById('products-result').innerHTML = productsHtml;
                }
                
            } catch (error) {
                log(`加载失败: ${error.message}`, 'error');
                document.getElementById('products-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>加载失败</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // 添加示例产品
        document.getElementById('add-sample-btn').addEventListener('click', async () => {
            log('开始添加示例产品...');
            
            const sampleProducts = [
                {
                    name: "P2.5室内LED显示屏",
                    category: "Indoor",
                    description: "高清室内LED显示屏，适用于会议室、展厅等场所",
                    price: 1999.99,
                    image_url: "assets/products/p2.5-indoor.jpg",
                    specifications: ["像素间距: P2.5", "分辨率: 1920x1080", "亮度: 800nits", "刷新率: 3840Hz"]
                },
                {
                    name: "P4户外LED显示屏",
                    category: "Outdoor",
                    description: "防水户外LED显示屏，适用于广告牌、体育场等",
                    price: 2999.99,
                    image_url: "assets/products/p4-outdoor.jpg",
                    specifications: ["像素间距: P4", "防护等级: IP65", "亮度: 6000nits", "工作温度: -40°C~+60°C"]
                },
                {
                    name: "P3.91租赁LED显示屏",
                    category: "Rental",
                    description: "轻便租赁LED显示屏，适用于演出、会议等临时活动",
                    price: 1599.99,
                    image_url: "assets/products/p3.91-rental.jpg",
                    specifications: ["像素间距: P3.91", "重量: 7kg/㎡", "快速安装", "航空箱包装"]
                }
            ];
            
            try {
                for (let i = 0; i < sampleProducts.length; i++) {
                    const product = sampleProducts[i];
                    log(`添加产品 ${i + 1}/${sampleProducts.length}: ${product.name}`);
                    
                    const result = await ProductTableFix.insertProduct(product);
                    
                    if (result.success) {
                        log(`✅ ${product.name} 添加成功`, 'success');
                    } else {
                        log(`❌ ${product.name} 添加失败: ${result.error}`, 'error');
                    }
                    
                    // 添加延迟避免频率限制
                    if (i < sampleProducts.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                log('示例产品添加完成', 'success');
                
                // 自动重新加载产品数据
                document.getElementById('load-products-btn').click();
                
            } catch (error) {
                log(`添加示例产品失败: ${error.message}`, 'error');
            }
        });

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', () => {
            log('产品数据状态检查工具已加载');
            log('请点击按钮开始检查');
        });
    </script>
</body>
</html>