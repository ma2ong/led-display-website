<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•è°ƒè¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
        }

        h2 {
            color: #569cd6;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #404040;
            padding-bottom: 5px;
        }

        .section {
            background: #252526;
            border: 1px solid #404040;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #9cdcfe;
        }

        .form-group input {
            width: 100%;
            max-width: 400px;
            padding: 8px 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 3px;
            color: #d4d4d4;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            background: #1177bb;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .log-container {
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 3px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .log-entry.success {
            color: #4ec9b0;
            border-left-color: #4ec9b0;
        }

        .log-entry.error {
            color: #f48771;
            border-left-color: #f48771;
        }

        .log-entry.warning {
            color: #dcdcaa;
            border-left-color: #dcdcaa;
        }

        .log-entry.info {
            color: #9cdcfe;
            border-left-color: #9cdcfe;
        }

        .timestamp {
            color: #858585;
            font-size: 11px;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-badge.success {
            background: #107c10;
            color: white;
        }

        .status-badge.error {
            background: #e81123;
            color: white;
        }

        .status-badge.unknown {
            background: #8a8a8a;
            color: white;
        }

        code {
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            color: #ce9178;
        }

        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .json-viewer {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç™»å½•è°ƒè¯•å·¥å…·</h1>
        <p style="color: #858585; margin-bottom: 20px;">
            æ­¤å·¥å…·å¸®åŠ©è¯Šæ–­ Supabase è®¤è¯é—®é¢˜ï¼ŒæŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè¿æ¥çŠ¶æ€
        </p>

        <!-- æ­¥éª¤ 1: è¿æ¥æµ‹è¯• -->
        <div class="section">
            <h2>æ­¥éª¤ 1: Supabase è¿æ¥æµ‹è¯•</h2>
            <button id="testConnection">æµ‹è¯•è¿æ¥</button>
            <button id="clearLogs">æ¸…ç©ºæ—¥å¿—</button>
            <div id="connectionStatus" style="margin-top: 15px;"></div>
            <div id="connectionLogs" class="log-container" style="margin-top: 15px;"></div>
        </div>

        <!-- æ­¥éª¤ 2: ç™»å½•æµ‹è¯• -->
        <div class="section">
            <h2>æ­¥éª¤ 2: ç™»å½•æµ‹è¯•</h2>
            <div class="form-group">
                <label for="debugEmail">é‚®ç®±åœ°å€</label>
                <input type="email" id="debugEmail" placeholder="your-email@example.com">
            </div>
            <div class="form-group">
                <label for="debugPassword">å¯†ç </label>
                <input type="password" id="debugPassword" placeholder="è¾“å…¥å¯†ç ">
            </div>
            <button id="testLogin">æµ‹è¯•ç™»å½•</button>
            <button id="testSession">æ£€æŸ¥å½“å‰ä¼šè¯</button>
            <button id="testLogout">ç™»å‡º</button>
            <div id="loginLogs" class="log-container" style="margin-top: 15px;"></div>
        </div>

        <!-- æ­¥éª¤ 3: æ•°æ®åº“æ£€æŸ¥ -->
        <div class="section">
            <h2>æ­¥éª¤ 3: æ•°æ®åº“æ£€æŸ¥</h2>
            <p style="color: #858585; margin-bottom: 10px;">
                æ£€æŸ¥å½“å‰ç”¨æˆ·åœ¨ admin_users è¡¨ä¸­çš„çŠ¶æ€
            </p>
            <button id="checkDatabase">æ£€æŸ¥æ•°æ®åº“</button>
            <div id="databaseLogs" class="log-container" style="margin-top: 15px;"></div>
        </div>

        <!-- æ­¥éª¤ 4: ç¯å¢ƒä¿¡æ¯ -->
        <div class="section">
            <h2>æ­¥éª¤ 4: ç¯å¢ƒä¿¡æ¯</h2>
            <button id="showEnv">æ˜¾ç¤ºç¯å¢ƒé…ç½®</button>
            <div id="envLogs" class="log-container" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        // å¯¼å…¥æ‰€æœ‰å¿…è¦çš„æ¨¡å—
        import { supabase, auth } from '../lib/supabase-client.js'

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info', containerId = 'connectionLogs') {
            const container = document.getElementById(containerId)
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false })
            const entry = document.createElement('div')
            entry.className = `log-entry ${type}`
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`
            container.appendChild(entry)
            container.scrollTop = container.scrollHeight
        }

        function logJSON(obj, containerId = 'connectionLogs') {
            const container = document.getElementById(containerId)
            const pre = document.createElement('pre')
            pre.className = 'json-viewer'
            pre.textContent = JSON.stringify(obj, null, 2)
            container.appendChild(pre)
            container.scrollTop = container.scrollHeight
        }

        function clearLog(containerId) {
            document.getElementById(containerId).innerHTML = ''
        }

        // æ­¥éª¤ 1: æµ‹è¯•è¿æ¥
        document.getElementById('testConnection').addEventListener('click', async () => {
            clearLog('connectionLogs')
            log('ğŸ”„ å¼€å§‹æµ‹è¯• Supabase è¿æ¥...', 'info', 'connectionLogs')

            try {
                // æ£€æŸ¥ Supabase å®¢æˆ·ç«¯
                log('âœ… Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–', 'success', 'connectionLogs')

                // è·å–é…ç½®ä¿¡æ¯ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
                const config = {
                    url: supabase.supabaseUrl || '(æœªè®¾ç½®)',
                    keyPrefix: supabase.supabaseKey ? supabase.supabaseKey.substring(0, 20) + '...' : '(æœªè®¾ç½®)'
                }
                log(`ğŸ“¡ Supabase URL: <code>${config.url}</code>`, 'info', 'connectionLogs')
                log(`ğŸ”‘ API Key (å‰20å­—ç¬¦): <code>${config.keyPrefix}</code>`, 'info', 'connectionLogs')

                // æµ‹è¯•åŸºæœ¬è¿æ¥
                log('ğŸ”„ æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info', 'connectionLogs')
                const { data, error } = await supabase.from('admin_users').select('count').limit(1)

                if (error) {
                    throw error
                }

                log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success', 'connectionLogs')

                // æ˜¾ç¤ºçŠ¶æ€
                document.getElementById('connectionStatus').innerHTML =
                    '<span class="status-badge success">è¿æ¥æ­£å¸¸</span>'

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error', 'connectionLogs')
                logJSON({ error: error }, 'connectionLogs')
                document.getElementById('connectionStatus').innerHTML =
                    '<span class="status-badge error">è¿æ¥å¤±è´¥</span>'
            }
        })

        // æ¸…ç©ºæ—¥å¿—
        document.getElementById('clearLogs').addEventListener('click', () => {
            clearLog('connectionLogs')
            clearLog('loginLogs')
            clearLog('databaseLogs')
            clearLog('envLogs')
        })

        // æ­¥éª¤ 2: æµ‹è¯•ç™»å½•
        document.getElementById('testLogin').addEventListener('click', async () => {
            clearLog('loginLogs')
            const email = document.getElementById('debugEmail').value.trim()
            const password = document.getElementById('debugPassword').value

            if (!email || !password) {
                log('âš ï¸ è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'warning', 'loginLogs')
                return
            }

            log(`ğŸ”„ å°è¯•ç™»å½•: ${email}`, 'info', 'loginLogs')

            try {
                // ç¬¬ 1 æ­¥: Supabase Auth ç™»å½•
                log('ğŸ“ æ­¥éª¤ 1: è°ƒç”¨ Supabase Auth API...', 'info', 'loginLogs')
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email,
                    password
                })

                if (authError) {
                    throw authError
                }

                log('âœ… æ­¥éª¤ 1 æˆåŠŸ: Supabase Auth è®¤è¯é€šè¿‡', 'success', 'loginLogs')
                log(`ğŸ‘¤ ç”¨æˆ· ID: <code>${authData.user.id}</code>`, 'info', 'loginLogs')
                log(`ğŸ“§ é‚®ç®±: <code>${authData.user.email}</code>`, 'info', 'loginLogs')

                // ç¬¬ 2 æ­¥: æ£€æŸ¥ admin_users è¡¨
                log('ğŸ“ æ­¥éª¤ 2: æ£€æŸ¥ admin_users è¡¨...', 'info', 'loginLogs')
                const { data: adminData, error: adminError } = await supabase
                    .from('admin_users')
                    .select('*')
                    .eq('user_id', authData.user.id)
                    .single()

                if (adminError) {
                    if (adminError.code === 'PGRST116') {
                        log('âŒ æ­¥éª¤ 2 å¤±è´¥: ç”¨æˆ·ä¸åœ¨ admin_users è¡¨ä¸­', 'error', 'loginLogs')
                        log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ: è¿è¡Œ database/fix_admin_login.sql ä¸­çš„ä¿®å¤ 1', 'warning', 'loginLogs')
                        return
                    }
                    throw adminError
                }

                log('âœ… æ­¥éª¤ 2 æˆåŠŸ: åœ¨ admin_users è¡¨ä¸­æ‰¾åˆ°ç”¨æˆ·', 'success', 'loginLogs')
                logJSON(adminData, 'loginLogs')

                // ç¬¬ 3 æ­¥: æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€
                log('ğŸ“ æ­¥éª¤ 3: æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€...', 'info', 'loginLogs')

                if (!adminData.is_active) {
                    log('âŒ è´¦å·å·²è¢«ç¦ç”¨', 'error', 'loginLogs')
                    log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ: è¿è¡Œ database/fix_admin_login.sql ä¸­çš„ä¿®å¤ 2', 'warning', 'loginLogs')
                    return
                }

                if (!['super_admin', 'admin', 'editor'].includes(adminData.role)) {
                    log(`âŒ è§’è‰²æƒé™ä¸è¶³: ${adminData.role}`, 'error', 'loginLogs')
                    log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ: è§’è‰²å¿…é¡»æ˜¯ super_admin, admin æˆ– editor', 'warning', 'loginLogs')
                    return
                }

                log('âœ… æ­¥éª¤ 3 æˆåŠŸ: ç®¡ç†å‘˜æƒé™éªŒè¯é€šè¿‡', 'success', 'loginLogs')
                log(`ğŸ­ è§’è‰²: <code>${adminData.role}</code>`, 'success', 'loginLogs')
                log('ğŸ‰ ç™»å½•æµ‹è¯•å®Œå…¨æˆåŠŸï¼æ‰€æœ‰æ­¥éª¤éƒ½é€šè¿‡äº†', 'success', 'loginLogs')

            } catch (error) {
                log(`âŒ ç™»å½•å¤±è´¥: ${error.message}`, 'error', 'loginLogs')
                logJSON({
                    error: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                }, 'loginLogs')

                // æä¾›å…·ä½“çš„é”™è¯¯æç¤º
                if (error.message.includes('Invalid login credentials')) {
                    log('ğŸ’¡ å¯èƒ½åŸå› : é‚®ç®±æˆ–å¯†ç é”™è¯¯', 'warning', 'loginLogs')
                } else if (error.message.includes('Email not confirmed')) {
                    log('ğŸ’¡ å¯èƒ½åŸå› : é‚®ç®±æœªç¡®è®¤', 'warning', 'loginLogs')
                    log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ: è¿è¡Œ database/fix_admin_login.sql ä¸­çš„ä¿®å¤ 4', 'warning', 'loginLogs')
                }
            }
        })

        // æ£€æŸ¥å½“å‰ä¼šè¯
        document.getElementById('testSession').addEventListener('click', async () => {
            clearLog('loginLogs')
            log('ğŸ”„ æ£€æŸ¥å½“å‰ä¼šè¯...', 'info', 'loginLogs')

            try {
                const { data: { session }, error } = await supabase.auth.getSession()

                if (error) throw error

                if (!session) {
                    log('â„¹ï¸ å½“å‰æ²¡æœ‰æ´»åŠ¨ä¼šè¯', 'info', 'loginLogs')
                    return
                }

                log('âœ… æ‰¾åˆ°æ´»åŠ¨ä¼šè¯', 'success', 'loginLogs')
                logJSON({
                    user: {
                        id: session.user.id,
                        email: session.user.email,
                        created_at: session.user.created_at
                    },
                    expires_at: new Date(session.expires_at * 1000).toLocaleString('zh-CN')
                }, 'loginLogs')

            } catch (error) {
                log(`âŒ æ£€æŸ¥ä¼šè¯å¤±è´¥: ${error.message}`, 'error', 'loginLogs')
                logJSON({ error }, 'loginLogs')
            }
        })

        // ç™»å‡º
        document.getElementById('testLogout').addEventListener('click', async () => {
            clearLog('loginLogs')
            log('ğŸ”„ æ­£åœ¨ç™»å‡º...', 'info', 'loginLogs')

            try {
                await supabase.auth.signOut()
                log('âœ… ç™»å‡ºæˆåŠŸ', 'success', 'loginLogs')
            } catch (error) {
                log(`âŒ ç™»å‡ºå¤±è´¥: ${error.message}`, 'error', 'loginLogs')
            }
        })

        // æ­¥éª¤ 3: æ£€æŸ¥æ•°æ®åº“
        document.getElementById('checkDatabase').addEventListener('click', async () => {
            clearLog('databaseLogs')
            log('ğŸ”„ æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...', 'info', 'databaseLogs')

            try {
                // è·å–å½“å‰ç”¨æˆ·
                const { data: { user } } = await supabase.auth.getUser()

                if (!user) {
                    log('â„¹ï¸ å½“å‰æœªç™»å½•ï¼Œæ— æ³•æ£€æŸ¥æ•°æ®åº“', 'info', 'databaseLogs')
                    return
                }

                log(`ğŸ‘¤ å½“å‰ç”¨æˆ·: ${user.email}`, 'info', 'databaseLogs')

                // æŸ¥è¯¢ admin_users è¡¨
                log('ğŸ”„ æŸ¥è¯¢ admin_users è¡¨...', 'info', 'databaseLogs')
                const { data: adminData, error: adminError } = await supabase
                    .from('admin_users')
                    .select('*')
                    .eq('user_id', user.id)
                    .single()

                if (adminError) {
                    if (adminError.code === 'PGRST116') {
                        log('âŒ ç”¨æˆ·ä¸åœ¨ admin_users è¡¨ä¸­', 'error', 'databaseLogs')
                        log('ğŸ’¡ éœ€è¦è¿è¡Œ SQL: database/fix_admin_login.sql', 'warning', 'databaseLogs')
                    } else {
                        throw adminError
                    }
                    return
                }

                log('âœ… åœ¨ admin_users è¡¨ä¸­æ‰¾åˆ°ç”¨æˆ·è®°å½•', 'success', 'databaseLogs')
                logJSON(adminData, 'databaseLogs')

                // åˆ†æçŠ¶æ€
                if (adminData.is_active) {
                    log('âœ… è´¦å·çŠ¶æ€: æ´»è·ƒ', 'success', 'databaseLogs')
                } else {
                    log('âŒ è´¦å·çŠ¶æ€: å·²ç¦ç”¨', 'error', 'databaseLogs')
                }

                log(`ğŸ­ è§’è‰²: ${adminData.role}`, 'info', 'databaseLogs')

            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error', 'databaseLogs')
                logJSON({ error }, 'databaseLogs')
            }
        })

        // æ­¥éª¤ 4: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        document.getElementById('showEnv').addEventListener('click', () => {
            clearLog('envLogs')
            log('ğŸ“Š ç¯å¢ƒé…ç½®ä¿¡æ¯', 'info', 'envLogs')

            // æµè§ˆå™¨ä¿¡æ¯
            log(`ğŸŒ æµè§ˆå™¨: ${navigator.userAgent}`, 'info', 'envLogs')
            log(`ğŸ“ å½“å‰é¡µé¢: ${window.location.href}`, 'info', 'envLogs')

            // Supabase é…ç½® (è„±æ•)
            const supabaseUrl = supabase.supabaseUrl || '(æœªè®¾ç½®)'
            const keyPrefix = supabase.supabaseKey ?
                supabase.supabaseKey.substring(0, 20) + '...' : '(æœªè®¾ç½®)'

            log(`ğŸ“¡ Supabase URL: <code>${supabaseUrl}</code>`, 'info', 'envLogs')
            log(`ğŸ”‘ API Key (å‰20å­—ç¬¦): <code>${keyPrefix}</code>`, 'info', 'envLogs')

            // LocalStorage
            log('ğŸ’¾ LocalStorage å†…å®¹:', 'info', 'envLogs')
            const adminUser = localStorage.getItem('admin_user')
            if (adminUser) {
                try {
                    logJSON(JSON.parse(adminUser), 'envLogs')
                } catch {
                    log('è§£æå¤±è´¥', 'error', 'envLogs')
                }
            } else {
                log('  æ—  admin_user æ•°æ®', 'info', 'envLogs')
            }
        })

        // è‡ªåŠ¨è¿è¡Œè¿æ¥æµ‹è¯•
        log('ğŸš€ è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success', 'connectionLogs')
        log('ğŸ’¡ æç¤º: ç‚¹å‡» "æµ‹è¯•è¿æ¥" å¼€å§‹è¯Šæ–­', 'info', 'connectionLogs')
    </script>
</body>
</html>
