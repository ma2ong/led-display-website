{% extends "base.html" %}

{% block title %}Media Management - LED Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-images me-2"></i>Media Management</h2>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-upload me-2"></i>Upload Files
                    </button>
                    <button class="btn btn-success" onclick="syncAllMedia()">
                        <i class="fas fa-sync me-2"></i>Sync to Frontend
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="row mb-4">
        <div class="col-md-3">
            <select class="form-select" id="typeFilter" onchange="filterMedia()">
                <option value="">All Types</option>
                <option value="image">Images</option>
                <option value="video">Videos</option>
                <option value="document">Documents</option>
            </select>
        </div>
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchMedia" placeholder="Search files..." onkeyup="searchMedia()">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="col-md-3">
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="viewMode" id="gridView" checked onchange="toggleView('grid')">
                <label class="btn btn-outline-primary" for="gridView">
                    <i class="fas fa-th"></i> Grid
                </label>
                <input type="radio" class="btn-check" name="viewMode" id="listView" onchange="toggleView('list')">
                <label class="btn btn-outline-primary" for="listView">
                    <i class="fas fa-list"></i> List
                </label>
            </div>
        </div>
    </div>

    <!-- Media Grid View -->
    <div id="gridViewContainer">
        <div class="row g-3" id="mediaGrid">
            {% for file in media_files %}
            <div class="col-lg-2 col-md-3 col-sm-4 col-6 media-item" data-type="{{ file.file_type }}" data-name="{{ file.original_name.lower() }}">
                <div class="card h-100">
                    <div class="position-relative">
                        {% if file.file_type == 'image' %}
                            <img src="../{{ file.file_path }}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="{{ file.alt_text or file.original_name }}">
                        {% elif file.file_type == 'video' %}
                            <div class="d-flex align-items-center justify-content-center bg-dark text-white" style="height: 150px;">
                                <i class="fas fa-play-circle fa-3x"></i>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center justify-content-center bg-light" style="height: 150px;">
                                <i class="fas fa-file fa-3x text-muted"></i>
                            </div>
                        {% endif %}
                        
                        <!-- File Type Badge -->
                        <span class="position-absolute top-0 end-0 badge bg-{{ 'success' if file.file_type == 'image' else 'info' if file.file_type == 'video' else 'secondary' }} m-1">
                            {{ file.file_type }}
                        </span>
                    </div>
                    
                    <div class="card-body p-2">
                        <h6 class="card-title small mb-1" title="{{ file.original_name }}">
                            {{ (file.original_name[:20] + '...') if file.original_name|length > 20 else file.original_name }}
                        </h6>
                        <div class="small text-muted">
                            <div>{{ (file.file_size / 1024 / 1024)|round(2) }} MB</div>
                            <div>{{ file.created_at.strftime('%Y-%m-%d') if file.created_at else 'N/A' }}</div>
                        </div>
                    </div>
                    
                    <div class="card-footer p-2">
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="previewFile('{{ file.id }}', '{{ file.file_type }}', '{{ file.file_path }}', '{{ file.original_name }}')" title="Preview">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="copyPath('{{ file.file_path }}')" title="Copy Path">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFile({{ file.id }})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Media List View -->
    <div id="listViewContainer" style="display: none;">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="mediaTable">
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>Uploaded By</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in media_files %}
                            <tr class="media-item" data-type="{{ file.file_type }}" data-name="{{ file.original_name.lower() }}">
                                <td>
                                    {% if file.file_type == 'image' %}
                                        <img src="../{{ file.file_path }}" style="width: 40px; height: 40px; object-fit: cover;" class="rounded" alt="{{ file.original_name }}">
                                    {% elif file.file_type == 'video' %}
                                        <div class="d-flex align-items-center justify-content-center bg-dark text-white rounded" style="width: 40px; height: 40px;">
                                            <i class="fas fa-play"></i>
                                        </div>
                                    {% else %}
                                        <div class="d-flex align-items-center justify-content-center bg-light rounded" style="width: 40px; height: 40px;">
                                            <i class="fas fa-file text-muted"></i>
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ file.original_name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ file.filename }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if file.file_type == 'image' else 'info' if file.file_type == 'video' else 'secondary' }}">
                                        {{ file.file_type }}
                                    </span>
                                </td>
                                <td>{{ (file.file_size / 1024 / 1024)|round(2) }} MB</td>
                                <td>{{ file.uploaded_by or 'Unknown' }}</td>
                                <td>{{ file.created_at.strftime('%Y-%m-%d %H:%M') if file.created_at else 'N/A' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="previewFile('{{ file.id }}', '{{ file.file_type }}', '{{ file.file_path }}', '{{ file.original_name }}')" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="copyPath('{{ file.file_path }}')" title="Copy Path">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="editFile({{ file.id }})" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteFile({{ file.id }})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Media Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Files</label>
                    <input type="file" class="form-control" id="fileInput" multiple accept="image/*,video/*,.pdf,.doc,.docx">
                    <div class="form-text">Supported formats: Images (JPG, PNG, GIF, WebP), Videos (MP4, AVI, MOV, WMV), Documents (PDF, DOC, DOCX). Max size: 16MB per file.</div>
                </div>
                
                <div id="filePreview" class="row g-2 mb-3">
                    <!-- File previews will be shown here -->
                </div>
                
                <div class="progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadFiles()" id="uploadBtn">
                    <i class="fas fa-upload me-2"></i>Upload Files
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewTitle">File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="previewBody">
                <!-- Preview content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadFile()" id="downloadBtn">
                    <i class="fas fa-download me-2"></i>Download
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPreviewPath = '';

// File input change handler
document.getElementById('fileInput').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const previewContainer = document.getElementById('filePreview');
    previewContainer.innerHTML = '';
    
    files.forEach((file, index) => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'col-md-3';
        
        const isImage = file.type.startsWith('image/');
        const isVideo = file.type.startsWith('video/');
        
        fileDiv.innerHTML = `
            <div class="card">
                <div class="card-body p-2 text-center">
                    ${isImage ? `<img src="${URL.createObjectURL(file)}" class="img-fluid rounded mb-2" style="max-height: 80px;">` : 
                      isVideo ? `<i class="fas fa-video fa-3x text-info mb-2"></i>` : 
                      `<i class="fas fa-file fa-3x text-muted mb-2"></i>`}
                    <div class="small">
                        <strong>${file.name}</strong><br>
                        <span class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                    </div>
                </div>
            </div>
        `;
        
        previewContainer.appendChild(fileDiv);
    });
});

function toggleView(viewType) {
    const gridView = document.getElementById('gridViewContainer');
    const listView = document.getElementById('listViewContainer');
    
    if (viewType === 'grid') {
        gridView.style.display = 'block';
        listView.style.display = 'none';
    } else {
        gridView.style.display = 'none';
        listView.style.display = 'block';
    }
}

function filterMedia() {
    const filter = document.getElementById('typeFilter').value.toLowerCase();
    const items = document.querySelectorAll('.media-item');
    
    items.forEach(item => {
        const type = item.getAttribute('data-type').toLowerCase();
        if (filter === '' || type === filter) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

function searchMedia() {
    const searchTerm = document.getElementById('searchMedia').value.toLowerCase();
    const items = document.querySelectorAll('.media-item');
    
    items.forEach(item => {
        const name = item.getAttribute('data-name');
        if (name.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

async function uploadFiles() {
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    
    if (files.length === 0) {
        alert('Please select files to upload');
        return;
    }
    
    const uploadBtn = document.getElementById('uploadBtn');
    const progress = document.getElementById('uploadProgress');
    const progressBar = progress.querySelector('.progress-bar');
    
    uploadBtn.disabled = true;
    progress.style.display = 'block';
    
    let uploadedCount = 0;
    const totalFiles = files.length;
    
    for (let i = 0; i < files.length; i++) {
        const formData = new FormData();
        formData.append('file', files[i]);
        
        try {
            const response = await fetch('/media/upload', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                uploadedCount++;
            }
        } catch (error) {
            console.error('Upload error:', error);
        }
        
        // Update progress
        const progressPercent = ((i + 1) / totalFiles) * 100;
        progressBar.style.width = progressPercent + '%';
    }
    
    uploadBtn.disabled = false;
    progress.style.display = 'none';
    
    if (uploadedCount === totalFiles) {
        alert(`Successfully uploaded ${uploadedCount} files!`);
        location.reload();
    } else {
        alert(`Uploaded ${uploadedCount} out of ${totalFiles} files. Some uploads failed.`);
    }
}

function previewFile(id, type, path, name) {
    currentPreviewPath = path;
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    const title = document.getElementById('previewTitle');
    const body = document.getElementById('previewBody');
    
    title.textContent = name;
    
    if (type === 'image') {
        body.innerHTML = `<img src="../${path}" class="img-fluid" alt="${name}">`;
    } else if (type === 'video') {
        body.innerHTML = `
            <video controls class="w-100" style="max-height: 500px;">
                <source src="../${path}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        `;
    } else {
        body.innerHTML = `
            <div class="text-center">
                <i class="fas fa-file fa-5x text-muted mb-3"></i>
                <h5>${name}</h5>
                <p class="text-muted">Preview not available for this file type</p>
            </div>
        `;
    }
    
    modal.show();
}

function copyPath(path) {
    navigator.clipboard.writeText(path).then(() => {
        // Show temporary success message
        const toast = document.createElement('div');
        toast.className = 'toast-container position-fixed top-0 end-0 p-3';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong class="me-auto">Success</strong>
                </div>
                <div class="toast-body">
                    File path copied to clipboard!
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    });
}

function downloadFile() {
    if (currentPreviewPath) {
        const link = document.createElement('a');
        link.href = '../' + currentPreviewPath;
        link.download = '';
        link.click();
    }
}

async function deleteFile(id) {
    if (!confirm('Are you sure you want to delete this file?')) {
        return;
    }
    
    try {
        const response = await fetch(`/media/delete/${id}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete file');
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete file');
    }
}

async function syncAllMedia() {
    try {
        const response = await fetch('/api/sync', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('All media files synchronized to frontend successfully!');
        } else {
            alert('Failed to sync: ' + result.message);
        }
    } catch (error) {
        console.error('Error syncing media:', error);
        alert('Failed to sync media files');
    }
}
</script>
{% endblock %}