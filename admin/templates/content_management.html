{% extends "base.html" %}

{% block title %}Content Management - LED Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-edit me-2"></i>Content Management</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContentModal">
                    <i class="fas fa-plus me-2"></i>Add Content
                </button>
            </div>
        </div>
    </div>

    <!-- Page Filter -->
    <div class="row mb-4">
        <div class="col-md-6">
            <select class="form-select" id="pageFilter" onchange="filterContent()">
                <option value="">All Pages</option>
                <option value="homepage">Homepage</option>
                <option value="about">About Us</option>
                <option value="contact">Contact</option>
                <option value="products">Products</option>
                <option value="outdoor">Outdoor LED</option>
                <option value="rental">Rental LED</option>
                <option value="creative">Creative LED</option>
                <option value="transparent">Transparent LED</option>
            </select>
        </div>
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchContent" placeholder="Search content..." onkeyup="searchContent()">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Content List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="contentTable">
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th>Section</th>
                                    <th>Type</th>
                                    <th>Content (EN)</th>
                                    <th>Content (ZH)</th>
                                    <th>Status</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for content in contents %}
                                <tr data-page="{{ content.page_name }}">
                                    <td><span class="badge bg-primary">{{ content.page_name }}</span></td>
                                    <td>{{ content.section_name }}</td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-{{ 'image' if content.content_type == 'image' else 'video' if content.content_type == 'video' else 'text' }} me-1"></i>
                                            {{ content.content_type }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if content.content_type == 'text' %}
                                            {{ (content.content_en[:50] + '...') if content.content_en and content.content_en|length > 50 else content.content_en }}
                                        {% elif content.content_type == 'image' %}
                                            {% if content.image_url %}
                                                <img src="{{ content.image_url }}" alt="Content Image" style="max-width: 60px; max-height: 40px;" class="rounded">
                                            {% else %}
                                                <span class="text-muted">No image</span>
                                            {% endif %}
                                        {% elif content.content_type == 'video' %}
                                            {% if content.video_url %}
                                                <i class="fas fa-play-circle text-primary"></i> Video
                                            {% else %}
                                                <span class="text-muted">No video</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if content.content_type == 'text' %}
                                            {{ (content.content_zh[:50] + '...') if content.content_zh and content.content_zh|length > 50 else content.content_zh }}
                                        {% else %}
                                            <span class="text-muted">Same as EN</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if content.status == 'active' else 'warning' }}">
                                            {{ content.status }}
                                        </span>
                                    </td>
                                    <td>{{ content.updated_at.strftime('%Y-%m-%d %H:%M') if content.updated_at else 'N/A' }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editContent({{ content.id }})" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteContent({{ content.id }})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Content Modal -->
<div class="modal fade" id="addContentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addContentForm" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Page Name *</label>
                            <select class="form-select" name="page_name" required>
                                <option value="">Select Page</option>
                                <option value="homepage">Homepage</option>
                                <option value="about">About Us</option>
                                <option value="contact">Contact</option>
                                <option value="products">Products</option>
                                <option value="outdoor">Outdoor LED</option>
                                <option value="rental">Rental LED</option>
                                <option value="creative">Creative LED</option>
                                <option value="transparent">Transparent LED</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Section Name *</label>
                            <input type="text" class="form-control" name="section_name" required placeholder="e.g., hero_title, company_intro">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Content Type *</label>
                            <select class="form-select" name="content_type" onchange="toggleContentFields(this)" required>
                                <option value="">Select Type</option>
                                <option value="text">Text Content</option>
                                <option value="image">Image</option>
                                <option value="video">Video</option>
                                <option value="html">HTML Content</option>
                            </select>
                        </div>
                        
                        <!-- Text Content Fields -->
                        <div class="content-fields text-fields" style="display: none;">
                            <div class="col-12">
                                <label class="form-label">English Content</label>
                                <textarea class="form-control" name="content_en" rows="4" placeholder="Enter English content..."></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Chinese Content</label>
                                <textarea class="form-control" name="content_zh" rows="4" placeholder="输入中文内容..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Image Upload Field -->
                        <div class="content-fields image-fields" style="display: none;">
                            <div class="col-12">
                                <label class="form-label">Upload Image</label>
                                <input type="file" class="form-control" name="image_file" accept="image/*">
                                <div class="form-text">Supported formats: JPG, PNG, GIF, WebP (Max: 16MB)</div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Alt Text (English)</label>
                                <input type="text" class="form-control" name="alt_text_en" placeholder="Image description in English">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Alt Text (Chinese)</label>
                                <input type="text" class="form-control" name="alt_text_zh" placeholder="图片描述（中文）">
                            </div>
                        </div>
                        
                        <!-- Video Upload Field -->
                        <div class="content-fields video-fields" style="display: none;">
                            <div class="col-12">
                                <label class="form-label">Upload Video</label>
                                <input type="file" class="form-control" name="video_file" accept="video/*">
                                <div class="form-text">Supported formats: MP4, AVI, MOV, WMV (Max: 16MB)</div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Video Title (English)</label>
                                <input type="text" class="form-control" name="video_title_en" placeholder="Video title in English">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Video Title (Chinese)</label>
                                <input type="text" class="form-control" name="video_title_zh" placeholder="视频标题（中文）">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Sort Order</label>
                            <input type="number" class="form-control" name="sort_order" value="0" min="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Content
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Content Modal -->
<div class="modal fade" id="editContentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editContentForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="content_id" id="edit_content_id">
                <div class="modal-body" id="editContentBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Content
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleContentFields(select) {
    // Hide all content fields
    document.querySelectorAll('.content-fields').forEach(field => {
        field.style.display = 'none';
    });
    
    // Show selected content fields
    const selectedType = select.value;
    if (selectedType) {
        const fieldsToShow = document.querySelector(`.${selectedType}-fields`);
        if (fieldsToShow) {
            fieldsToShow.style.display = 'block';
        }
    }
}

function filterContent() {
    const filter = document.getElementById('pageFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#contentTable tbody tr');
    
    rows.forEach(row => {
        const page = row.getAttribute('data-page').toLowerCase();
        if (filter === '' || page === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function searchContent() {
    const searchTerm = document.getElementById('searchContent').value.toLowerCase();
    const rows = document.querySelectorAll('#contentTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

async function editContent(contentId) {
    try {
        const response = await fetch(`/api/content/${contentId}`);
        const content = await response.json();
        
        if (content.status === 'success') {
            // Populate edit form
            document.getElementById('edit_content_id').value = contentId;
            
            // Load content into edit modal
            const editBody = document.getElementById('editContentBody');
            editBody.innerHTML = generateEditForm(content.data);
            
            // Show modal
            new bootstrap.Modal(document.getElementById('editContentModal')).show();
        } else {
            alert('Failed to load content: ' + content.message);
        }
    } catch (error) {
        console.error('Error loading content:', error);
        alert('Failed to load content');
    }
}

function generateEditForm(content) {
    return `
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Page Name</label>
                <input type="text" class="form-control" value="${content.page_name}" readonly>
            </div>
            <div class="col-md-6">
                <label class="form-label">Section Name</label>
                <input type="text" class="form-control" name="section_name" value="${content.section_name}" required>
            </div>
            <div class="col-12">
                <label class="form-label">Content Type</label>
                <input type="text" class="form-control" value="${content.content_type}" readonly>
            </div>
            ${content.content_type === 'text' ? `
                <div class="col-12">
                    <label class="form-label">English Content</label>
                    <textarea class="form-control" name="content_en" rows="4">${content.content_en || ''}</textarea>
                </div>
                <div class="col-12">
                    <label class="form-label">Chinese Content</label>
                    <textarea class="form-control" name="content_zh" rows="4">${content.content_zh || ''}</textarea>
                </div>
            ` : ''}
            ${content.content_type === 'image' ? `
                <div class="col-12">
                    ${content.image_url ? `<img src="${content.image_url}" alt="Current Image" class="img-thumbnail mb-2" style="max-height: 200px;">` : ''}
                    <label class="form-label">Replace Image</label>
                    <input type="file" class="form-control" name="image_file" accept="image/*">
                </div>
            ` : ''}
            <div class="col-md-6">
                <label class="form-label">Sort Order</label>
                <input type="number" class="form-control" name="sort_order" value="${content.sort_order || 0}">
            </div>
            <div class="col-md-6">
                <label class="form-label">Status</label>
                <select class="form-select" name="status">
                    <option value="active" ${content.status === 'active' ? 'selected' : ''}>Active</option>
                    <option value="inactive" ${content.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                </select>
            </div>
        </div>
    `;
}

async function deleteContent(contentId) {
    if (!confirm('Are you sure you want to delete this content?')) {
        return;
    }
    
    try {
        const response = await fetch(`/content/delete/${contentId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete content');
        }
    } catch (error) {
        console.error('Error deleting content:', error);
        alert('Failed to delete content');
    }
}

// Form submission handlers
document.getElementById('addContentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/content/add', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to add content');
        }
    } catch (error) {
        console.error('Error adding content:', error);
        alert('Failed to add content');
    }
});

document.getElementById('editContentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const contentId = document.getElementById('edit_content_id').value;
    
    try {
        const response = await fetch(`/content/edit/${contentId}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to update content');
        }
    } catch (error) {
        console.error('Error updating content:', error);
        alert('Failed to update content');
    }
});
</script>
{% endblock %}