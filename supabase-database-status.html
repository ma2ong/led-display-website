<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase数据库状态检查</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f8f9fa; }
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-success { border-left: 5px solid #28a745; }
        .status-error { border-left: 5px solid #dc3545; }
        .status-warning { border-left: 5px solid #ffc107; }
        .loading { display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="text-center mb-4">
                    <h1><i class="fas fa-database me-2"></i>Supabase数据库状态检查</h1>
                    <p class="text-muted">LED显示屏网站 - 数据库连接验证</p>
                </div>

                <!-- 连接状态 -->
                <div class="card status-card" id="connectionCard">
                    <div class="card-body">
                        <h5><i class="fas fa-wifi me-2"></i>数据库连接状态</h5>
                        <div id="connectionStatus">
                            <i class="fas fa-spinner loading me-2"></i>正在检查连接...
                        </div>
                    </div>
                </div>

                <!-- 产品数据 -->
                <div class="card status-card" id="productsCard">
                    <div class="card-body">
                        <h5><i class="fas fa-cube me-2"></i>产品数据</h5>
                        <div id="productsStatus">
                            <i class="fas fa-spinner loading me-2"></i>正在加载产品数据...
                        </div>
                        <div id="productsData" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- 询盘数据 -->
                <div class="card status-card" id="inquiriesCard">
                    <div class="card-body">
                        <h5><i class="fas fa-envelope me-2"></i>询盘数据</h5>
                        <div id="inquiriesStatus">
                            <i class="fas fa-spinner loading me-2"></i>正在加载询盘数据...
                        </div>
                        <div id="inquiriesData" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- 新闻数据 -->
                <div class="card status-card" id="newsCard">
                    <div class="card-body">
                        <h5><i class="fas fa-newspaper me-2"></i>新闻数据</h5>
                        <div id="newsStatus">
                            <i class="fas fa-spinner loading me-2"></i>正在加载新闻数据...
                        </div>
                        <div id="newsData" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- 用户数据 -->
                <div class="card status-card" id="usersCard">
                    <div class="card-body">
                        <h5><i class="fas fa-users me-2"></i>用户数据</h5>
                        <div id="usersStatus">
                            <i class="fas fa-spinner loading me-2"></i>正在加载用户数据...
                        </div>
                        <div id="usersData" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- 数据库配置信息 -->
                <div class="card status-card">
                    <div class="card-body">
                        <h5><i class="fas fa-cog me-2"></i>数据库配置信息</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Supabase URL:</strong><br>
                                <code>https://jirudzbqcxviytcmxegf.supabase.co</code></p>
                                <p><strong>项目ID:</strong><br>
                                <code>jirudzbqcxviytcmxegf</code></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>数据库类型:</strong> PostgreSQL</p>
                                <p><strong>API版本:</strong> v1</p>
                                <p><strong>认证方式:</strong> API Key</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="text-center">
                    <button class="btn btn-primary me-2" onclick="checkAllTables()">
                        <i class="fas fa-sync-alt me-1"></i>重新检查
                    </button>
                    <button class="btn btn-success me-2" onclick="testConnection()">
                        <i class="fas fa-plug me-1"></i>测试连接
                    </button>
                    <a href="http://localhost:5003" class="btn btn-info me-2" target="_blank">
                        <i class="fas fa-cog me-1"></i>后台管理
                    </a>
                    <a href="http://localhost:8000" class="btn btn-warning" target="_blank">
                        <i class="fas fa-globe me-1"></i>前端网站
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Supabase配置
        const SUPABASE_URL = 'https://jirudzbqcxviytcmxegf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y214ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4';

        // 通用请求函数
        async function makeSupabaseRequest(table) {
            const url = `${SUPABASE_URL}/rest/v1/${table}`;
            const headers = {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
            };

            try {
                const response = await fetch(url, { headers });
                if (response.ok) {
                    return await response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                throw error;
            }
        }

        // 更新状态显示
        function updateStatus(cardId, statusId, success, message, data = null) {
            const card = document.getElementById(cardId);
            const status = document.getElementById(statusId);
            
            if (success) {
                card.className = 'card status-card status-success';
                status.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${message}`;
            } else {
                card.className = 'card status-card status-error';
                status.innerHTML = `<i class="fas fa-times-circle text-danger me-2"></i>${message}`;
            }

            if (data && success) {
                const dataDiv = document.getElementById(statusId.replace('Status', 'Data'));
                if (dataDiv) {
                    dataDiv.style.display = 'block';
                    dataDiv.innerHTML = data;
                }
            }
        }

        // 检查产品数据
        async function checkProducts() {
            try {
                const products = await makeSupabaseRequest('products');
                const message = `成功连接！共有 ${products.length} 个产品`;
                const dataHtml = `
                    <div class="row">
                        ${products.slice(0, 6).map(product => `
                            <div class="col-md-4 mb-2">
                                <div class="border rounded p-2">
                                    <strong>${product.name}</strong><br>
                                    <small class="text-muted">${product.category} - ¥${product.price}</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                updateStatus('productsCard', 'productsStatus', true, message, dataHtml);
            } catch (error) {
                updateStatus('productsCard', 'productsStatus', false, `连接失败: ${error.message}`);
            }
        }

        // 检查询盘数据
        async function checkInquiries() {
            try {
                const inquiries = await makeSupabaseRequest('inquiries');
                const message = `成功连接！共有 ${inquiries.length} 条询盘`;
                const dataHtml = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>姓名</th><th>公司</th><th>邮箱</th><th>状态</th></tr></thead>
                            <tbody>
                                ${inquiries.slice(0, 5).map(inquiry => `
                                    <tr>
                                        <td>${inquiry.name}</td>
                                        <td>${inquiry.company || '-'}</td>
                                        <td>${inquiry.email}</td>
                                        <td><span class="badge bg-primary">${inquiry.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                updateStatus('inquiriesCard', 'inquiriesStatus', true, message, dataHtml);
            } catch (error) {
                updateStatus('inquiriesCard', 'inquiriesStatus', false, `连接失败: ${error.message}`);
            }
        }

        // 检查新闻数据
        async function checkNews() {
            try {
                const news = await makeSupabaseRequest('news');
                const message = `成功连接！共有 ${news.length} 条新闻`;
                const dataHtml = `
                    <div class="list-group">
                        ${news.slice(0, 5).map(item => `
                            <div class="list-group-item">
                                <strong>${item.title}</strong><br>
                                <small class="text-muted">作者: ${item.author} | 状态: ${item.status}</small>
                            </div>
                        `).join('')}
                    </div>
                `;
                updateStatus('newsCard', 'newsStatus', true, message, dataHtml);
            } catch (error) {
                updateStatus('newsCard', 'newsStatus', false, `连接失败: ${error.message}`);
            }
        }

        // 检查用户数据
        async function checkUsers() {
            try {
                const users = await makeSupabaseRequest('users');
                const message = `成功连接！共有 ${users.length} 个用户`;
                const dataHtml = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>用户名</th><th>角色</th><th>创建时间</th></tr></thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${user.username}</td>
                                        <td><span class="badge bg-success">${user.role}</span></td>
                                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                updateStatus('usersCard', 'usersStatus', true, message, dataHtml);
            } catch (error) {
                updateStatus('usersCard', 'usersStatus', false, `连接失败: ${error.message}`);
            }
        }

        // 测试基本连接
        async function testConnection() {
            const connectionStatus = document.getElementById('connectionStatus');
            const connectionCard = document.getElementById('connectionCard');
            
            connectionStatus.innerHTML = '<i class="fas fa-spinner loading me-2"></i>正在测试连接...';
            connectionCard.className = 'card status-card';

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    updateStatus('connectionCard', 'connectionStatus', true, 
                        `数据库连接成功！响应时间: ${Date.now() - startTime}ms`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('connectionCard', 'connectionStatus', false, 
                    `连接失败: ${error.message}`);
            }
        }

        // 检查所有表
        async function checkAllTables() {
            // 重置所有状态
            ['connectionCard', 'productsCard', 'inquiriesCard', 'newsCard', 'usersCard'].forEach(cardId => {
                const card = document.getElementById(cardId);
                const statusId = cardId.replace('Card', 'Status');
                const status = document.getElementById(statusId);
                
                card.className = 'card status-card';
                status.innerHTML = '<i class="fas fa-spinner loading me-2"></i>正在检查...';
                
                const dataDiv = document.getElementById(statusId.replace('Status', 'Data'));
                if (dataDiv) dataDiv.style.display = 'none';
            });

            // 依次检查各个表
            await testConnection();
            await checkProducts();
            await checkInquiries();
            await checkNews();
            await checkUsers();
        }

        // 页面加载时自动检查
        let startTime;
        window.addEventListener('load', () => {
            startTime = Date.now();
            checkAllTables();
        });
    </script>
</body>
</html>