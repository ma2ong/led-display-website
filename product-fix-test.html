<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品表写入修复工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-card {
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #17a2b8; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tools me-2"></i>产品表写入修复工具
            </a>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">产品表写入失败修复工具 (HTTP 错误: 400)</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5>问题原因:</h5>
                            <ul>
                                <li>RLS策略阻止写入</li>
                                <li>数据格式不匹配</li>
                                <li>规格字段格式问题</li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-success">
                            <h5>已实施的修复:</h5>
                            <ul>
                                <li>禁用 RLS (Row Level Security)</li>
                                <li>添加数据验证和清理</li>
                                <li>规格字段格式标准化</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">诊断工具</h4>
                    </div>
                    <div class="card-body">
                        <button id="diagnose-btn" class="btn btn-primary mb-3">运行诊断</button>
                        <div id="diagnosis-result"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">应用修复</h4>
                    </div>
                    <div class="card-body">
                        <button id="fix-rls-btn" class="btn btn-warning mb-3">禁用RLS</button>
                        <div id="fix-result"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">测试产品插入</h4>
                    </div>
                    <div class="card-body">
                        <form id="product-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="product-name" class="form-label">产品名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="product-name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="product-category" class="form-label">产品分类 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="product-category" required>
                                        <option value="">选择分类...</option>
                                        <option value="Indoor">室内显示屏</option>
                                        <option value="Outdoor">户外显示屏</option>
                                        <option value="Rental">租赁显示屏</option>
                                        <option value="Transparent">透明显示屏</option>
                                        <option value="Creative">创意显示屏</option>
                                        <option value="Fine Pitch">小间距显示屏</option>
                                        <option value="Industrial">工业显示屏</option>
                                        <option value="Broadcast">广播显示屏</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="product-price" class="form-label">价格</label>
                                    <input type="number" class="form-control" id="product-price" step="0.01">
                                </div>
                                <div class="col-md-6">
                                    <label for="product-image" class="form-label">图片URL</label>
                                    <input type="text" class="form-control" id="product-image">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="product-description" class="form-label">产品描述</label>
                                <textarea class="form-control" id="product-description" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="product-specs" class="form-label">产品规格 (每行一个)</label>
                                <textarea class="form-control" id="product-specs" rows="4" placeholder="分辨率: 1920x1080&#10;亮度: 800nits&#10;刷新率: 3840Hz"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-success">安全插入产品</button>
                        </form>
                        
                        <div id="insert-result" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">日志</h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="log-container"></div>
                    </div>
                    <div class="card-footer">
                        <button id="clear-logs" class="btn btn-secondary btn-sm">清除日志</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import ProductTableFix from './js/product-fix-solution.js';
        
        // 日志系统
        const logContainer = document.getElementById('log-container');
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 清除日志
        document.getElementById('clear-logs').addEventListener('click', () => {
            logContainer.innerHTML = '';
        });

        // 运行诊断
        document.getElementById('diagnose-btn').addEventListener('click', async () => {
            log('开始运行诊断...');
            document.getElementById('diagnosis-result').innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">诊断中...</span>
                </div>
            `;
            
            try {
                const diagnosis = await ProductTableFix.diagnoseProductTableIssues();
                log('诊断完成', 'success');
                
                let resultHtml = `
                    <div class="alert alert-${diagnosis.recommendations.length === 0 ? 'success' : 'warning'}">
                        <h5>诊断结果</h5>
                        <p>${diagnosis.recommendations.length === 0 ? '所有检查通过！' : `发现 ${diagnosis.recommendations.length} 个问题`}</p>
                    </div>
                    
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            数据库连接
                            <span class="badge bg-${diagnosis.connection ? 'success' : 'danger'} rounded-pill">
                                ${diagnosis.connection ? '成功' : '失败'}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            表存在
                            <span class="badge bg-${diagnosis.tableExists ? 'success' : 'danger'} rounded-pill">
                                ${diagnosis.tableExists ? '是' : '否'}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            读取权限
                            <span class="badge bg-${diagnosis.permissions.read ? 'success' : 'danger'} rounded-pill">
                                ${diagnosis.permissions.read ? '有' : '无'}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            写入权限
                            <span class="badge bg-${diagnosis.permissions.write ? 'success' : 'danger'} rounded-pill">
                                ${diagnosis.permissions.write ? '有' : '无'}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            RLS状态
                            <span class="badge bg-secondary rounded-pill">
                                ${diagnosis.rlsStatus || '未知'}
                            </span>
                        </li>
                    </ul>
                `;
                
                if (diagnosis.recommendations.length > 0) {
                    resultHtml += `
                        <div class="alert alert-info">
                            <h5>修复建议</h5>
                            <ul>
                                ${diagnosis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                document.getElementById('diagnosis-result').innerHTML = resultHtml;
                
            } catch (err) {
                log(`诊断出错: ${err.message}`, 'error');
                document.getElementById('diagnosis-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>诊断失败</h5>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        });
        
        // 禁用RLS
        document.getElementById('fix-rls-btn').addEventListener('click', async () => {
            log('正在应用修复: 禁用RLS...');
            document.getElementById('fix-result').innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">修复中...</span>
                </div>
            `;
            
            try {
                const result = await ProductTableFix.applyFix_DisableRLS();
                
                if (result.success) {
                    log('RLS已成功禁用', 'success');
                    document.getElementById('fix-result').innerHTML = `
                        <div class="alert alert-success">
                            <h5>修复成功</h5>
                            <p>${result.message}</p>
                        </div>
                    `;
                } else {
                    log(`禁用RLS失败: ${result.error}`, 'error');
                    document.getElementById('fix-result').innerHTML = `
                        <div class="alert alert-danger">
                            <h5>修复失败</h5>
                            <p>${result.error}</p>
                        </div>
                    `;
                }
            } catch (err) {
                log(`应用修复出错: ${err.message}`, 'error');
                document.getElementById('fix-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>修复失败</h5>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        });
        
        // 产品表单提交
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            log('准备插入产品数据...');
            document.getElementById('insert-result').innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">插入中...</span>
                </div>
            `;
            
            try {
                // 收集表单数据
                const productData = {
                    name: document.getElementById('product-name').value,
                    category: document.getElementById('product-category').value,
                    description: document.getElementById('product-description').value || null,
                    price: document.getElementById('product-price').value ? Number(document.getElementById('product-price').value) : null,
                    image_url: document.getElementById('product-image').value || null,
                    specifications: null
                };
                
                // 处理规格
                const specsText = document.getElementById('product-specs').value;
                if (specsText) {
                    const specs = specsText.split('\n').filter(line => line.trim() !== '');
                    productData.specifications = specs;
                }
                
                log(`产品数据: ${JSON.stringify(productData)}`);
                
                // 使用修复工具插入
                const result = await ProductTableFix.insertProduct(productData);
                
                if (result.success) {
                    log('产品插入成功', 'success');
                    document.getElementById('insert-result').innerHTML = `
                        <div class="alert alert-success">
                            <h5>插入成功</h5>
                            <p>产品 "${result.data.name}" 已成功添加到数据库</p>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `;
                    
                    // 清空表单
                    document.getElementById('product-form').reset();
                } else {
                    log(`产品插入失败: ${result.error}`, 'error');
                    document.getElementById('insert-result').innerHTML = `
                        <div class="alert alert-danger">
                            <h5>插入失败</h5>
                            <p>${result.error}</p>
                            ${result.details ? `<pre>${JSON.stringify(result.details, null, 2)}</pre>` : ''}
                        </div>
                    `;
                }
            } catch (err) {
                log(`产品插入异常: ${err.message}`, 'error');
                document.getElementById('insert-result').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>插入异常</h5>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        });
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', () => {
            log('产品表写入修复工具已加载', 'info');
            log('请使用上方工具进行诊断和修复', 'info');
        });
    </script>
</body>
</html>