<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§¦å‘ Supabase éƒ¨ç½²æ£€æµ‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        #log {
            background: #f8f9fa;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Supabase éƒ¨ç½²çŠ¶æ€è§¦å‘å™¨</h1>
        <p>è¿™ä¸ªé¡µé¢ä¸“é—¨ç”¨æ¥è§¦å‘ Supabase æ§åˆ¶å°çš„éƒ¨ç½²æ£€æµ‹ï¼Œè®©çŠ¶æ€ä» "Not started" å˜ä¸º "Complete"ã€‚</p>
        
        <div id="status" class="status info">
            æ­£åœ¨åˆå§‹åŒ–...
        </div>
        
        <div>
            <button onclick="triggerDeployment()">è§¦å‘éƒ¨ç½²æ£€æµ‹</button>
            <button onclick="testAllTables()">æµ‹è¯•æ‰€æœ‰æ•°æ®è¡¨</button>
            <button onclick="performCRUDOperations()">æ‰§è¡Œå®Œæ•´ CRUD æ“ä½œ</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <h3>æ“ä½œæ—¥å¿—ï¼š</h3>
        <div id="log"></div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://jirudzbqcxviytcmxegf.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y218ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4'
        
        let supabaseClient = null;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // åˆå§‹åŒ– Supabase
        function initSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase library not loaded');
                }
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                updateStatus('Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–', 'success');
                return true;
            } catch (error) {
                log(`âŒ Supabase åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                updateStatus('Supabase åˆå§‹åŒ–å¤±è´¥', 'error');
                return false;
            }
        }
        
        // è§¦å‘éƒ¨ç½²æ£€æµ‹çš„ä¸»è¦å‡½æ•°
        async function triggerDeployment() {
            log('ğŸš€ å¼€å§‹è§¦å‘ Supabase éƒ¨ç½²æ£€æµ‹...');
            
            if (!supabaseClient && !initSupabase()) {
                return;
            }
            
            try {
                // 1. æ‰§è¡Œå¤šä¸ªæ•°æ®åº“æ“ä½œæ¥è§¦å‘æ£€æµ‹
                log('ğŸ“Š æ­¥éª¤ 1: æµ‹è¯•æ‰€æœ‰æ•°æ®è¡¨è¿æ¥...');
                await testAllTables();
                
                // 2. æ‰§è¡Œè®¤è¯æ“ä½œ
                log('ğŸ” æ­¥éª¤ 2: æµ‹è¯•è®¤è¯ç³»ç»Ÿ...');
                await testAuthSystem();
                
                // 3. æ‰§è¡Œå®æ—¶è®¢é˜…
                log('ğŸ”„ æ­¥éª¤ 3: å»ºç«‹å®æ—¶è¿æ¥...');
                await setupRealTimeConnection();
                
                // 4. æ‰§è¡Œå­˜å‚¨æ“ä½œ
                log('ğŸ’¾ æ­¥éª¤ 4: æ‰§è¡Œæ•°æ®å­˜å‚¨æ“ä½œ...');
                await performStorageOperations();
                
                // 5. å‘é€å¤šä¸ªå¹¶å‘è¯·æ±‚
                log('âš¡ æ­¥éª¤ 5: å‘é€å¹¶å‘è¯·æ±‚...');
                await sendConcurrentRequests();
                
                log('ğŸ‰ éƒ¨ç½²æ£€æµ‹è§¦å‘å®Œæˆï¼è¯·æ£€æŸ¥ Supabase æ§åˆ¶å°çŠ¶æ€ã€‚', 'success');
                updateStatus('éƒ¨ç½²æ£€æµ‹å·²è§¦å‘ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°', 'success');
                
            } catch (error) {
                log(`âŒ è§¦å‘éƒ¨ç½²æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
                updateStatus('è§¦å‘å¤±è´¥', 'error');
            }
        }
        
        // æµ‹è¯•æ‰€æœ‰æ•°æ®è¡¨
        async function testAllTables() {
            const tables = ['products', 'inquiries', 'news', 'users'];
            
            for (const table of tables) {
                try {
                    // è¯»å–æ“ä½œ
                    const { data: readData, error: readError } = await supabaseClient
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (readError) throw readError;
                    log(`âœ… è¡¨ ${table}: è¯»å–æˆåŠŸ`, 'success');
                    
                    // è®¡æ•°æ“ä½œ
                    const { count, error: countError } = await supabaseClient
                        .from(table)
                        .select('*', { count: 'exact', head: true });
                    
                    if (countError) throw countError;
                    log(`ğŸ“Š è¡¨ ${table}: ${count} æ¡è®°å½•`, 'info');
                    
                } catch (error) {
                    log(`âŒ è¡¨ ${table}: ${error.message}`, 'error');
                }
            }
        }
        
        // æµ‹è¯•è®¤è¯ç³»ç»Ÿ
        async function testAuthSystem() {
            try {
                // è·å–å½“å‰ä¼šè¯
                const { data: sessionData } = await supabaseClient.auth.getSession();
                log(`ğŸ” å½“å‰ä¼šè¯çŠ¶æ€: ${sessionData.session ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`, 'info');
                
                // è·å–ç”¨æˆ·ä¿¡æ¯
                const { data: userData } = await supabaseClient.auth.getUser();
                log(`ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${userData.user ? userData.user.email : 'æ— ç”¨æˆ·'}`, 'info');
                
            } catch (error) {
                log(`âŒ è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å»ºç«‹å®æ—¶è¿æ¥
        async function setupRealTimeConnection() {
            try {
                // è®¢é˜…äº§å“è¡¨å˜åŒ–
                const subscription = supabaseClient
                    .channel('deployment-trigger')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'products' }, 
                        (payload) => {
                            log(`ğŸ”„ å®æ—¶æ›´æ–°: ${payload.eventType} on products`, 'info');
                        }
                    )
                    .subscribe((status) => {
                        log(`ğŸ“¡ å®æ—¶è¿æ¥çŠ¶æ€: ${status}`, 'info');
                    });
                
                // 5ç§’åå–æ¶ˆè®¢é˜…
                setTimeout(() => {
                    subscription.unsubscribe();
                    log('ğŸ“¡ å®æ—¶è¿æ¥å·²æ–­å¼€', 'info');
                }, 5000);
                
            } catch (error) {
                log(`âŒ å®æ—¶è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ‰§è¡Œå­˜å‚¨æ“ä½œ
        async function performStorageOperations() {
            try {
                // æ’å…¥æµ‹è¯•æ•°æ®åˆ°äº§å“è¡¨
                const testProduct = {
                    name: `éƒ¨ç½²æµ‹è¯•äº§å“ ${Date.now()}`,
                    category: 'deployment-test',
                    description: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºè§¦å‘ Supabase éƒ¨ç½²æ£€æµ‹çš„æµ‹è¯•äº§å“',
                    price: 999.99,
                    created_at: new Date().toISOString()
                };
                
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('products')
                    .insert([testProduct])
                    .select();
                
                if (insertError) throw insertError;
                log(`âœ… æ’å…¥æµ‹è¯•äº§å“æˆåŠŸ: ID ${insertData[0].id}`, 'success');
                
                // æ›´æ–°æµ‹è¯•æ•°æ®
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('products')
                    .update({ description: 'å·²æ›´æ–°çš„æµ‹è¯•äº§å“æè¿°' })
                    .eq('id', insertData[0].id)
                    .select();
                
                if (updateError) throw updateError;
                log(`âœ… æ›´æ–°æµ‹è¯•äº§å“æˆåŠŸ`, 'success');
                
                // åˆ é™¤æµ‹è¯•æ•°æ®
                const { error: deleteError } = await supabaseClient
                    .from('products')
                    .delete()
                    .eq('id', insertData[0].id);
                
                if (deleteError) throw deleteError;
                log(`âœ… åˆ é™¤æµ‹è¯•äº§å“æˆåŠŸ`, 'success');
                
            } catch (error) {
                log(`âŒ å­˜å‚¨æ“ä½œå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å‘é€å¹¶å‘è¯·æ±‚
        async function sendConcurrentRequests() {
            try {
                const requests = [];
                
                // åˆ›å»ºå¤šä¸ªå¹¶å‘è¯·æ±‚
                for (let i = 0; i < 5; i++) {
                    requests.push(
                        supabaseClient
                            .from('products')
                            .select('count')
                            .limit(1)
                    );
                }
                
                const results = await Promise.all(requests);
                log(`âš¡ å¹¶å‘è¯·æ±‚å®Œæˆ: ${results.length} ä¸ªè¯·æ±‚æˆåŠŸ`, 'success');
                
            } catch (error) {
                log(`âŒ å¹¶å‘è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ‰§è¡Œå®Œæ•´çš„ CRUD æ“ä½œ
        async function performCRUDOperations() {
            log('ğŸ”„ å¼€å§‹æ‰§è¡Œå®Œæ•´ CRUD æ“ä½œ...');
            
            try {
                // Create - åˆ›å»º
                const testInquiry = {
                    name: 'éƒ¨ç½²æµ‹è¯•ç”¨æˆ·',
                    email: 'deployment-test@example.com',
                    message: 'è¿™æ˜¯ä¸€ä¸ªéƒ¨ç½²æµ‹è¯•è¯¢ä»·',
                    status: 'new',
                    created_at: new Date().toISOString()
                };
                
                const { data: createData, error: createError } = await supabaseClient
                    .from('inquiries')
                    .insert([testInquiry])
                    .select();
                
                if (createError) throw createError;
                log(`âœ… CREATE: åˆ›å»ºè¯¢ä»·è®°å½• ID ${createData[0].id}`, 'success');
                
                // Read - è¯»å–
                const { data: readData, error: readError } = await supabaseClient
                    .from('inquiries')
                    .select('*')
                    .eq('id', createData[0].id);
                
                if (readError) throw readError;
                log(`âœ… READ: è¯»å–è¯¢ä»·è®°å½•æˆåŠŸ`, 'success');
                
                // Update - æ›´æ–°
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('inquiries')
                    .update({ status: 'processed' })
                    .eq('id', createData[0].id)
                    .select();
                
                if (updateError) throw updateError;
                log(`âœ… UPDATE: æ›´æ–°è¯¢ä»·çŠ¶æ€æˆåŠŸ`, 'success');
                
                // Delete - åˆ é™¤
                const { error: deleteError } = await supabaseClient
                    .from('inquiries')
                    .delete()
                    .eq('id', createData[0].id);
                
                if (deleteError) throw deleteError;
                log(`âœ… DELETE: åˆ é™¤è¯¢ä»·è®°å½•æˆåŠŸ`, 'success');
                
                log('ğŸ‰ å®Œæ•´ CRUD æ“ä½œæ‰§è¡Œå®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`âŒ CRUD æ“ä½œå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // æ£€æŸ¥ Supabase åº“æ˜¯å¦åŠ è½½
            if (typeof window.supabase === 'undefined') {
                log('âš ï¸ Supabase åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                updateStatus('Supabase åº“åŠ è½½å¤±è´¥', 'error');
                return;
            }
            
            // åˆå§‹åŒ–å®¢æˆ·ç«¯
            if (initSupabase()) {
                log('âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹è§¦å‘éƒ¨ç½²æ£€æµ‹', 'success');
                updateStatus('å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®è§¦å‘éƒ¨ç½²æ£€æµ‹', 'info');
            }
        });
    </script>
</body>
</html>