<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>触发 Supabase 部署检测</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        #log {
            background: #f8f9fa;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Supabase 部署状态触发器</h1>
        <p>这个页面专门用来触发 Supabase 控制台的部署检测，让状态从 "Not started" 变为 "Complete"。</p>
        
        <div id="status" class="status info">
            正在初始化...
        </div>
        
        <div>
            <button onclick="triggerDeployment()">触发部署检测</button>
            <button onclick="testAllTables()">测试所有数据表</button>
            <button onclick="performCRUDOperations()">执行完整 CRUD 操作</button>
            <button onclick="clearLog()">清空日志</button>
        </div>
        
        <h3>操作日志：</h3>
        <div id="log"></div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase 配置
        const SUPABASE_URL = 'https://jirudzbqcxviytcmxegf.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppcnVkemJxY3h2aXl0Y218ZWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTExOTUsImV4cCI6MjA3MDAyNzE5NX0.qi0YhrxQmbRa6YsbVA13IpddImIjJKJyd1fgz5jIlt4'
        
        let supabaseClient = null;
        
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // 初始化 Supabase
        function initSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase library not loaded');
                }
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('✅ Supabase 客户端初始化成功', 'success');
                updateStatus('Supabase 客户端已初始化', 'success');
                return true;
            } catch (error) {
                log(`❌ Supabase 初始化失败: ${error.message}`, 'error');
                updateStatus('Supabase 初始化失败', 'error');
                return false;
            }
        }
        
        // 触发部署检测的主要函数
        async function triggerDeployment() {
            log('🚀 开始触发 Supabase 部署检测...');
            
            if (!supabaseClient && !initSupabase()) {
                return;
            }
            
            try {
                // 1. 执行多个数据库操作来触发检测
                log('📊 步骤 1: 测试所有数据表连接...');
                await testAllTables();
                
                // 2. 执行认证操作
                log('🔐 步骤 2: 测试认证系统...');
                await testAuthSystem();
                
                // 3. 执行实时订阅
                log('🔄 步骤 3: 建立实时连接...');
                await setupRealTimeConnection();
                
                // 4. 执行存储操作
                log('💾 步骤 4: 执行数据存储操作...');
                await performStorageOperations();
                
                // 5. 发送多个并发请求
                log('⚡ 步骤 5: 发送并发请求...');
                await sendConcurrentRequests();
                
                log('🎉 部署检测触发完成！请检查 Supabase 控制台状态。', 'success');
                updateStatus('部署检测已触发，请检查控制台', 'success');
                
            } catch (error) {
                log(`❌ 触发部署检测失败: ${error.message}`, 'error');
                updateStatus('触发失败', 'error');
            }
        }
        
        // 测试所有数据表
        async function testAllTables() {
            const tables = ['products', 'inquiries', 'news', 'users'];
            
            for (const table of tables) {
                try {
                    // 读取操作
                    const { data: readData, error: readError } = await supabaseClient
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (readError) throw readError;
                    log(`✅ 表 ${table}: 读取成功`, 'success');
                    
                    // 计数操作
                    const { count, error: countError } = await supabaseClient
                        .from(table)
                        .select('*', { count: 'exact', head: true });
                    
                    if (countError) throw countError;
                    log(`📊 表 ${table}: ${count} 条记录`, 'info');
                    
                } catch (error) {
                    log(`❌ 表 ${table}: ${error.message}`, 'error');
                }
            }
        }
        
        // 测试认证系统
        async function testAuthSystem() {
            try {
                // 获取当前会话
                const { data: sessionData } = await supabaseClient.auth.getSession();
                log(`🔐 当前会话状态: ${sessionData.session ? '已登录' : '未登录'}`, 'info');
                
                // 获取用户信息
                const { data: userData } = await supabaseClient.auth.getUser();
                log(`👤 用户信息: ${userData.user ? userData.user.email : '无用户'}`, 'info');
                
            } catch (error) {
                log(`❌ 认证测试失败: ${error.message}`, 'error');
            }
        }
        
        // 建立实时连接
        async function setupRealTimeConnection() {
            try {
                // 订阅产品表变化
                const subscription = supabaseClient
                    .channel('deployment-trigger')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'products' }, 
                        (payload) => {
                            log(`🔄 实时更新: ${payload.eventType} on products`, 'info');
                        }
                    )
                    .subscribe((status) => {
                        log(`📡 实时连接状态: ${status}`, 'info');
                    });
                
                // 5秒后取消订阅
                setTimeout(() => {
                    subscription.unsubscribe();
                    log('📡 实时连接已断开', 'info');
                }, 5000);
                
            } catch (error) {
                log(`❌ 实时连接失败: ${error.message}`, 'error');
            }
        }
        
        // 执行存储操作
        async function performStorageOperations() {
            try {
                // 插入测试数据到产品表
                const testProduct = {
                    name: `部署测试产品 ${Date.now()}`,
                    category: 'deployment-test',
                    description: '这是一个用于触发 Supabase 部署检测的测试产品',
                    price: 999.99,
                    created_at: new Date().toISOString()
                };
                
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('products')
                    .insert([testProduct])
                    .select();
                
                if (insertError) throw insertError;
                log(`✅ 插入测试产品成功: ID ${insertData[0].id}`, 'success');
                
                // 更新测试数据
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('products')
                    .update({ description: '已更新的测试产品描述' })
                    .eq('id', insertData[0].id)
                    .select();
                
                if (updateError) throw updateError;
                log(`✅ 更新测试产品成功`, 'success');
                
                // 删除测试数据
                const { error: deleteError } = await supabaseClient
                    .from('products')
                    .delete()
                    .eq('id', insertData[0].id);
                
                if (deleteError) throw deleteError;
                log(`✅ 删除测试产品成功`, 'success');
                
            } catch (error) {
                log(`❌ 存储操作失败: ${error.message}`, 'error');
            }
        }
        
        // 发送并发请求
        async function sendConcurrentRequests() {
            try {
                const requests = [];
                
                // 创建多个并发请求
                for (let i = 0; i < 5; i++) {
                    requests.push(
                        supabaseClient
                            .from('products')
                            .select('count')
                            .limit(1)
                    );
                }
                
                const results = await Promise.all(requests);
                log(`⚡ 并发请求完成: ${results.length} 个请求成功`, 'success');
                
            } catch (error) {
                log(`❌ 并发请求失败: ${error.message}`, 'error');
            }
        }
        
        // 执行完整的 CRUD 操作
        async function performCRUDOperations() {
            log('🔄 开始执行完整 CRUD 操作...');
            
            try {
                // Create - 创建
                const testInquiry = {
                    name: '部署测试用户',
                    email: 'deployment-test@example.com',
                    message: '这是一个部署测试询价',
                    status: 'new',
                    created_at: new Date().toISOString()
                };
                
                const { data: createData, error: createError } = await supabaseClient
                    .from('inquiries')
                    .insert([testInquiry])
                    .select();
                
                if (createError) throw createError;
                log(`✅ CREATE: 创建询价记录 ID ${createData[0].id}`, 'success');
                
                // Read - 读取
                const { data: readData, error: readError } = await supabaseClient
                    .from('inquiries')
                    .select('*')
                    .eq('id', createData[0].id);
                
                if (readError) throw readError;
                log(`✅ READ: 读取询价记录成功`, 'success');
                
                // Update - 更新
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('inquiries')
                    .update({ status: 'processed' })
                    .eq('id', createData[0].id)
                    .select();
                
                if (updateError) throw updateError;
                log(`✅ UPDATE: 更新询价状态成功`, 'success');
                
                // Delete - 删除
                const { error: deleteError } = await supabaseClient
                    .from('inquiries')
                    .delete()
                    .eq('id', createData[0].id);
                
                if (deleteError) throw deleteError;
                log(`✅ DELETE: 删除询价记录成功`, 'success');
                
                log('🎉 完整 CRUD 操作执行完成！', 'success');
                
            } catch (error) {
                log(`❌ CRUD 操作失败: ${error.message}`, 'error');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 页面加载时初始化
        window.addEventListener('load', function() {
            log('🚀 页面加载完成，开始初始化...');
            
            // 检查 Supabase 库是否加载
            if (typeof window.supabase === 'undefined') {
                log('⚠️ Supabase 库未加载，请检查网络连接', 'error');
                updateStatus('Supabase 库加载失败', 'error');
                return;
            }
            
            // 初始化客户端
            if (initSupabase()) {
                log('✅ 初始化完成，可以开始触发部署检测', 'success');
                updateStatus('准备就绪，点击按钮触发部署检测', 'info');
            }
        });
    </script>
</body>
</html>